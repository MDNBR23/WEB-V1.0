<!doctype html><html lang="es"><head>
<meta charset="utf-8">
<script src="src/utils/i18n.js"></script>
  <script src="src/utils/themeCustomizer.js"></script>
<script>
(function(){
  var themeMode = localStorage.getItem('themeMode') || 'light';
  var themeMode = localStorage.getItem('themeMode') || 'light';
  document.documentElement.setAttribute('data-theme', themeMode);
})();
</script>
<script>(function(){var r=localStorage.getItem('userRole');if(r==='admin'){document.addEventListener('DOMContentLoaded',function(){var a=document.getElementById('adminNavLink');if(a)a.style.display='flex';});}})();</script>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#475569">
<title>Med Tools Hub</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="stylesheet" href="style.css">
<style>
.tool-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 0;
}
.tool-card {
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  padding: 28px;
  border: 2px solid var(--border);
  background: var(--card);
}
.tool-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), #006666);
  transform: scaleX(0);
  transition: transform 0.3s ease;
}
.tool-card:hover::before {
  transform: scaleX(1);
}
.tool-card:hover {
  transform: translateY(-6px);
  border-color: var(--primary);
  box-shadow: 0 12px 40px rgba(0,139,139,.15);
}
.tool-card-icon {
  font-size: 56px;
  margin-bottom: 16px;
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
}
.tool-card h3 {
  margin: 0 0 10px 0;
  font-size: 20px;
  font-weight: 600;
  color: var(--text);
}
.tool-card p {
  margin: 0;
  color: var(--muted);
  font-size: 14px;
  line-height: 1.5;
}
.tool-section {
  margin-bottom: 24px;
}
.tool-result {
  margin-top: 16px;
  padding: 12px;
  background: var(--bg);
  border-radius: 6px;
  border: 1px solid var(--border);
}
.gsa-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}
.gsa-input-card {
  position: relative;
  padding: 16px;
  background: linear-gradient(135deg, rgba(0,139,139,0.05), rgba(0,128,128,0.05));
  border: 2px solid var(--border);
  border-radius: 12px;
  transition: all 0.3s ease;
}
.gsa-input-card:hover {
  transform: translateY(-2px);
  border-color: var(--primary);
  box-shadow: 0 8px 20px rgba(0,139,139,0.15);
}
.gsa-input-card label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text);
}
.range-indicator {
  color: var(--muted);
  font-size: 12px;
  font-weight: 400;
}
.interactive-input {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.2s ease;
  background: var(--card);
}
.interactive-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,139,139,0.1);
}
.input-status {
  margin-top: 6px;
  font-size: 12px;
  font-weight: 500;
  min-height: 18px;
  transition: all 0.2s ease;
}
.gsa-result {
  padding: 20px;
  background: rgba(var(--success-rgb), 0.08);
  color: var(--text);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(var(--success-rgb), 0.1);
  border: 1px solid rgba(var(--success-rgb), 0.2);
}
.gsa-result h4 {
  margin: 0 0 12px 0;
  color: var(--success);
  font-size: 18px;
}
.gsa-result p {
  margin: 8px 0;
  font-size: 15px;
  line-height: 1.6;
  color: var(--text);
}
.doc-list {
  margin-top: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.doc-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg);
  border-radius: 6px;
  border: 1px solid var(--border);
}
.doc-item .doc-name {
  flex: 1;
  font-weight: 500;
}
.doc-item .doc-meta {
  color: var(--muted);
  font-size: 13px;
}
.text-editor {
  width: 100%;
  min-height: 120px;
  max-height: 400px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: monospace;
  font-size: 14px;
  margin-top: 12px;
  resize: vertical;
}
.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  padding: 10px 18px;
  background: rgba(71,85,105,.85);
  color: #fff;
  border-radius: 12px;
  text-decoration: none !important;
  font-weight: 700;
  transition: all 0.2s;
}
.back-btn:hover {
  background: rgba(51,65,85,.95);
  transform: translateX(-4px);
  text-decoration: none !important;
}
.infusion-calculator {
  display: grid;
  gap: 20px;
}
.infusion-section {
  padding: 16px;
  background: var(--bg);
  border-radius: 8px;
  border: 1px solid var(--border);
}
.infusion-section h4 {
  margin: 0 0 12px 0;
  color: var(--primary);
  font-size: 16px;
  font-weight: 700;
}
.infusion-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}
.infusion-result {
  background: rgba(var(--primary-rgb), 0.08);
  color: var(--text);
  padding: 16px;
  border-radius: 8px;
  margin-top: 12px;
  transition: all 0.3s ease;
  animation: fadeInScale 0.4s ease;
  border: 1px solid rgba(var(--primary-rgb), 0.2);
}
.infusion-result h5 {
  margin: 0 0 8px 0;
  font-size: 18px;
  color: var(--primary);
}
.infusion-result p {
  margin: 4px 0;
  font-size: 14px;
  color: var(--text);
}
.infusion-result.updating {
  animation: pulse 0.5s ease;
}
@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.02);
  }
}
.medication-select {
  margin-bottom: 16px;
}
.infusion-table {
  width: 100%;
  margin-top: 12px;
  border-collapse: collapse;
}
.infusion-table th,
.infusion-table td {
  padding: 8px;
  border: 1px solid var(--border);
  text-align: left;
}
.infusion-table th {
  background: var(--primary);
  color: white;
  font-weight: 700;
  font-size: 13px;
}
.infusion-table td {
  background: var(--bg);
  font-size: 14px;
}
#medicationSelect {
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  font-size: 15px;
  padding: 12px 14px;
  border-radius: 10px;
  border: 2px solid var(--border);
  background: rgba(255,255,255,.95);
  color: #1a202c;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
}
html[data-theme="dark"] #medicationSelect {
  background: rgba(20,25,42,.85);
  color: #f7fafc;
}
</style>
<script>
  document.documentElement.classList.add('preload');
  window.addEventListener('DOMContentLoaded', function(){
    document.body.classList.add('loaded');
    document.documentElement.classList.remove('preload');
  });
</script>
</head><body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo"><span class="logo-full">Med Tools Hub</span><span class="logo-short">MTH</span></div>
      <nav>
        <a href="main.html"><span class="icon">üè†</span><span  data-i18n="header.principal">Principal</span></a>
        <a href="vademecum.html"><span class="icon">üíä</span><span  data-i18n="header.vademecum">Vademecum</span></a>
        <a href="herramientas.html" class="active"><span class="icon">üîß</span><span  data-i18n="header.herramientas">Herramientas</span></a>
        <a href="turnos.html"><span class="icon">üìÖ</span><span  data-i18n="header.turnos">Turnos</span></a>
        <a href="sugerencias.html"><span class="icon">üí¨</span><span  data-i18n="header.sugerencias">Sugerencias</span><span id="sugerenciasBadge" class="sidebar-notification-badge" style="display:none;">0</span></a>
        <a href="configuracion.html"><span class="icon">‚öôÔ∏è</span><span  data-i18n="header.configuracion">Configuraci√≥n</span></a>
        <a href="admin.html" id="adminNavLink" style="display:none;"><span class="icon">üõ†Ô∏è</span><span  data-i18n="header.admin">Administraci√≥n</span><span id="adminBadge" class="sidebar-notification-badge" style="display:none;">0</span></a>
      </nav>
    </aside>
    <div class="content">
      <header class="header">
        <button id="btnToggleSidebar" type="button"></button>
        <div class="header-title-group">
          <h2>üîß Herramientas M√©dicas</h2>
          <p class="header-subtitle">Suite completa de calculadoras y herramientas para pr√°ctica cl√≠nica en pediatr√≠a y neonatolog√≠a</p>
        </div>
        <div id="colombiaClock"></div>
        <div class="user-info">
          <img id="avatarTop" alt="">
          <span id="mainUserInfo" class="text-muted"></span>
          <button class="btn danger sm" type="button" onclick="logout()"  data-i18n="header.logout">Salir</button>
        </div>
      </header>
      <main>

        <div id="toolMenu" class="tool-menu">
          <div class="card glass tool-card" onclick="showTool('corrector')">
            <span class="tool-card-icon">üìù</span>
            <h3  data-i18n="herramientas.corrector_texto">Corrector de Texto</h3>
            <p>Herramientas de formato y correcci√≥n de texto</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('gases')">
            <span class="tool-card-icon">ü´Å</span>
            <h3>Ventilaci√≥n</h3>
            <p>Interpreta gases arteriales y calcula √≠ndice de oxigenaci√≥n</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('infusiones')">
            <span class="tool-card-icon">ü©π</span>
            <h3>Calculadora</h3>
            <p>Calculadora de sedoanalgesia e infusiones</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('plantillas')">
            <span class="tool-card-icon">üìã</span>
            <h3  data-i18n="herramientas.plantillas">Plantillas</h3>
            <p>Gestiona plantillas de evoluci√≥n por patolog√≠a</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('ia')">
            <span class="tool-card-icon">ü§ñ</span>
            <h3>Asistente de IA</h3>
            <p>Consulta y obt√©n respuestas con inteligencia artificial</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('guias')">
            <span class="tool-card-icon">üìö</span>
            <h3>Gu√≠as Cl√≠nicas</h3>
            <p>Protocolos m√©dicos indexados y referencias PubMed/UpToDate</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('quiz')">
            <span class="tool-card-icon">‚ùì</span>
            <h3>Evaluaciones</h3>
            <p>Quiz interactivos para aprendizaje continuo en pediatr√≠a</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('interacciones')">
            <span class="tool-card-icon">‚ö†Ô∏è</span>
            <h3>Interacciones Medicamentosas</h3>
            <p>Verifica posibles interacciones entre medicamentos</p>
          </div>
        </div>

        <div id="correctorTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
              <div>
                <h3 style="margin: 0 0 6px 0;"  data-i18n="herramientas.corrector_texto">Corrector de Texto</h3>
                <p class="text-muted" style="margin: 0;">Herramientas inteligentes de formato y correcci√≥n</p>
              </div>
              <button class="btn sm" onclick="toggleExcelView()">
                <span id="excelViewIcon">üìä</span> <span id="excelViewText">Vista Tabla</span>
              </button>
            </div>
            
            <div id="normalTextView">
              <div style="display: flex; gap: 8px; margin-bottom: 8px; justify-content: flex-end;">
                <button class="btn sm secondary" onclick="limpiarTexto()" title="Limpiar" style="padding: 8px 12px; font-size: 13px;">Limpiar</button>
                <button class="btn sm success" onclick="copiarTexto()" title="Copiar" style="padding: 8px 12px; font-size: 13px;">Copiar</button>
              </div>
              <div style="position: relative;">
                <textarea id="textInput" class="text-editor" placeholder="Pega aqu√≠ el texto a procesar..." oninput="actualizarContadores(); autoExpandTextarea()" style="min-height: 180px; max-height: 600px; font-size: 15px; line-height: 1.6; resize: none; overflow-y: auto; width: 100%;"></textarea>
              </div>
              
              <div style="margin: 16px 0; padding: 16px; background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), rgba(var(--primary-rgb), 0.02)); border-radius: 12px; border: 1px solid rgba(var(--primary-rgb), 0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                <div style="text-align: center;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="charCounter">0</div>
                  <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Caracteres</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="wordCounter">0</div>
                  <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Palabras</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="lineCounter">0</div>
                  <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">L√≠neas</div>
                </div>
              </div>
            </div>
            
            <div id="excelView" style="display:none;">
              <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, rgba(33,150,243,0.1), rgba(59,130,246,0.05));border-left:4px solid #2196f3;border-radius:6px;">
                <p style="margin:0;font-size:13px;color:var(--text);"><strong>Clic+Arrastra:</strong> selecciona celdas | <strong>Ctrl/Cmd+Clic:</strong> m√∫ltiples celdas | <strong>Ctrl/Cmd+V:</strong> pega datos | <strong>Doble clic:</strong> edita celda</p>
              </div>
              
              <div style="margin-bottom:12px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
                <div style="display:flex;gap:6px;">
                  <button class="btn sm" onclick="addExcelRow()" style="font-size:13px;padding:8px 12px;">Agregar Fila</button>
                  <button class="btn sm" onclick="addExcelColumn()" style="font-size:13px;padding:8px 12px;">Agregar Columna</button>
                  <button class="btn sm secondary" onclick="deleteLastRow()" style="font-size:13px;padding:8px 12px;">Eliminar Fila</button>
                  <button class="btn sm secondary" onclick="deleteLastColumn()" style="font-size:13px;padding:8px 12px;">Eliminar Columna</button>
                </div>
                <div style="flex:1;min-width:150px;"></div>
                <div style="display:flex;gap:6px;">
                  <button class="btn sm success" onclick="copyExcelTable()" style="font-size:13px;padding:8px 12px;">Copiar Tabla</button>
                  <button class="btn sm secondary" onclick="clearExcelTable()" style="font-size:13px;padding:8px 12px;">Limpiar</button>
                </div>
              </div>
              
              <div style="overflow:auto;max-height:600px;border:2px solid var(--border);border-radius:8px;background:var(--card);box-shadow:0 4px 12px rgba(0,0,0,0.08);">
                <table id="excelTable" style="width:100%;border-collapse:collapse;background:var(--card);user-select:text;">
                  <tbody id="excelTableBody"></tbody>
                </table>
              </div>
            </div>
            
            <div style="margin-top: 20px;">
              <h4 style="margin: 0 0 12px 0; font-size: 16px; color: var(--text);">‚ö° Transformaciones R√°pidas</h4>
              
              <div style="margin-bottom: 20px;">
                <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">üî§ Formato de Texto</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                  <button class="btn sm" onclick="aplicarOperacion('mayusculas')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">MAY√öSCULAS</button>
                  <button class="btn sm" onclick="aplicarOperacion('minusculas')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">min√∫sculas</button>
                  <button class="btn sm" onclick="aplicarOperacion('capitalizar')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">T√≠tulo</button>
                  <button class="btn sm" onclick="aplicarOperacion('oracion')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">Oraci√≥n</button>
                </div>
              </div>
              
              <div style="margin-bottom: 20px;">
                <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">‚ú® Correcci√≥n</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                  <button class="btn sm" onclick="aplicarOperacion('espacios')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">Espacios</button>
                  <button class="btn sm" onclick="aplicarOperacion('eliminarSaltos')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">Saltos</button>
                  <button class="btn sm" onclick="aplicarOperacion('duplicar')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">Duplicadas</button>
                  <button class="btn sm" onclick="aplicarOperacion('invertir')" style="padding: 10px 12px; font-size: 13px; font-weight: 500;">Invertir</button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div id="gasesTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>ü´Å Ventilaci√≥n</h3>
            <p class="text-muted">Interpreta resultados de gasometr√≠a arterial y calcula el √≠ndice de oxigenaci√≥n.</p>
            <div class="gsa-grid">
              <div class="gsa-input-card">
                <label>pH <small class="range-indicator">(7.35-7.45)</small></label>
                <input type="number" id="gsaPH" step="0.01" placeholder="7.40" class="interactive-input">
                <div class="input-status" id="statusPH"></div>
              </div>
              <div class="gsa-input-card">
                <label>PaCO‚ÇÇ <small class="range-indicator">(35-45 mmHg)</small></label>
                <input type="number" id="gsaPaCO2" step="0.1" placeholder="40" class="interactive-input">
                <div class="input-status" id="statusPaCO2"></div>
              </div>
              <div class="gsa-input-card">
                <label>PaO‚ÇÇ <small class="range-indicator">(80-95 mmHg)</small></label>
                <input type="number" id="gsaPaO2" step="0.1" placeholder="90" class="interactive-input">
                <div class="input-status" id="statusPaO2"></div>
              </div>
              <div class="gsa-input-card">
                <label>HCO‚ÇÉ <small class="range-indicator">(22-26 mEq/L)</small></label>
                <input type="number" id="gsaHCO3" step="0.1" placeholder="24" class="interactive-input">
                <div class="input-status" id="statusHCO3"></div>
              </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
              <button class="btn primary" onclick="interpretarGSA()">üîç Interpretar Resultado</button>
              <button class="btn" onclick="limpiarGSA()">üóëÔ∏è Limpiar</button>
            </div>
            <div id="gsaResult" style="display:none; margin-top: 16px;"></div>
            
            <hr style="margin: 24px 0; border: none; border-top: 2px solid var(--border);">
            
            <h4 style="margin: 0 0 12px 0; color: var(--primary);">üìä √çndice de Oxigenaci√≥n (IO)</h4>
            <p class="text-muted" style="margin-bottom: 16px;">Calcula el √≠ndice de oxigenaci√≥n usando la f√≥rmula: IO = (FiO‚ÇÇ √ó MAP) / PaO‚ÇÇ</p>
            
            <div class="gsa-grid">
              <div class="gsa-input-card">
                <label>FiO‚ÇÇ <small class="range-indicator">(%)</small></label>
                <input type="number" id="ioFiO2" step="1" placeholder="21-100" min="21" max="100" class="interactive-input">
                <div class="input-status" id="statusFiO2"></div>
              </div>
              <div class="gsa-input-card">
                <label>MAP <small class="range-indicator">(cmH‚ÇÇO)</small></label>
                <input type="number" id="ioMAP" step="0.1" placeholder="5-20" class="interactive-input">
                <div class="input-status" id="statusMAP"></div>
              </div>
              <div class="gsa-input-card">
                <label>PaO‚ÇÇ <small class="range-indicator">(mmHg)</small></label>
                <input type="number" id="ioPaO2" step="0.1" placeholder="80-95" class="interactive-input">
                <div class="input-status" id="statusIOPaO2"></div>
              </div>
            </div>
            
            <div style="margin-top: 12px; display: flex; gap: 8px;">
              <button class="btn primary" onclick="calcularIO()">üßÆ Calcular √çndice</button>
              <button class="btn" onclick="limpiarIO()">üóëÔ∏è Limpiar</button>
            </div>
            <div id="ioResult" style="display:none; margin-top: 16px;"></div>
          </section>
        </div>

        <div id="infusionesTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <div style="display:grid;grid-template-columns:1fr 320px;gap:20px;">
            <section class="card glass tool-section">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div>
                  <h3 style="margin:0;">Calculadora de Infusiones</h3>
                  <p class="text-muted" style="margin:4px 0 0 0;">Calcula dosis de sedoanalgesia, vasopresores, inotr√≥picos</p>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button class="btn sm secondary" onclick="toggleMultiMed()" id="btnMultiMed" title="Multi-medicamento">‚ûï Multi</button>
                  <a href="admin.html" id="adminInfusionesLink" class="btn sm" style="display:none;text-decoration:none;">Gestionar</a>
                </div>
              </div>
              
              <div class="infusion-calculator">
                <div class="medication-select">
                  <label><strong>Seleccionar medicamento:</strong></label>
                  <select id="medicationSelect" onchange="loadMedication()" style="margin-bottom:12px;">
                    <option value="">Seleccionar medicamento</option>
                  </select>
                  <label style="margin-top:12px;"><strong>Presentaci√≥n:</strong></label>
                  <select id="presentationSelect" onchange="loadPresentation()" style="margin-bottom:12px;">
                    <option value="">Seleccionar presentaci√≥n</option>
                  </select>
                </div>

                <div id="medicationInfo" style="display:none;">
                  <div class="infusion-section">
                    <h4>üìã Informaci√≥n del Medicamento</h4>
                    <p id="presentacion" style="margin:0;"></p>
                    <p id="medicationDetails" style="margin:8px 0 0 0; color:var(--muted); font-size:13px;"></p>
                    <div id="doseRangeInfo" style="margin-top:8px;padding:8px 12px;background:rgba(var(--primary-rgb),0.1);border-radius:8px;font-size:13px;display:none;">
                      <strong>üéØ Rango pedi√°trico:</strong> <span id="doseRangeText"></span>
                    </div>
                  </div>

                  <div class="infusion-section">
                    <h4>üíâ Datos del Paciente y Dosis</h4>
                    <div style="margin-bottom:12px;">
                      <label style="font-size:13px;color:var(--muted);margin-bottom:6px;display:block;">‚ö° Peso r√°pido:</label>
                      <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button type="button" class="btn sm secondary quick-weight-btn" onclick="setQuickWeight(2)">2kg</button>
                        <button type="button" class="btn sm secondary quick-weight-btn" onclick="setQuickWeight(3)">3kg</button>
                        <button type="button" class="btn sm secondary quick-weight-btn" onclick="setQuickWeight(5)">5kg</button>
                        <button type="button" class="btn sm secondary quick-weight-btn" onclick="setQuickWeight(10)">10kg</button>
                        <button type="button" class="btn sm secondary quick-weight-btn" onclick="setQuickWeight(15)">15kg</button>
                        <button type="button" class="btn sm secondary quick-weight-btn" onclick="setQuickWeight(20)">20kg</button>
                        <button type="button" class="btn sm secondary quick-weight-btn" onclick="setQuickWeight(30)">30kg</button>
                      </div>
                    </div>
                    <div class="gsa-grid">
                      <div class="gsa-input-card">
                        <label>Peso <small class="range-indicator">(kg)</small></label>
                        <input type="number" id="peso" step="0.1" placeholder="Ej: 3.5" class="interactive-input">
                        <div class="input-status" id="statusPeso"></div>
                      </div>
                      <div class="gsa-input-card">
                        <label id="dosisLabel">Dosis</label>
                        <input type="number" id="dosis" step="0.01" placeholder="Ej: 1" class="interactive-input">
                        <div class="input-status" id="statusDosis"></div>
                      </div>
                    </div>
                    <div id="doseValidationAlert" style="display:none;margin-top:8px;padding:10px 14px;border-radius:8px;font-size:13px;"></div>
                    <div id="dosisCalculada" style="margin-top:12px;"></div>
                  </div>

                  <div class="infusion-section">
                    <h4>üíß Selecci√≥n de Diluci√≥n</h4>
                    <div id="dilucionOptions" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:8px;"></div>
                    <div id="dosisInfusion" style="margin-top:12px;"></div>
                  </div>

                  <div id="calculationSteps" class="infusion-section" style="display:none;">
                    <h4>üìä Paso a Paso del C√°lculo</h4>
                    <div id="calculationStepsContent" style="font-size:13px;line-height:1.8;"></div>
                  </div>

                  <div id="ordenMedica" class="infusion-result" style="display:none;">
                    <h5>üìù ORDEN M√âDICA</h5>
                    <div id="ordenMedicaContent"></div>
                  </div>

                  <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn" onclick="clearInfusion()">üóëÔ∏è Limpiar</button>
                    <button class="btn success" onclick="copyInfusionOrder()">üìã Copiar Orden</button>
                    <button class="btn primary" onclick="addToMultiMed()">‚ûï Agregar a Multi</button>
                    <button class="btn secondary" onclick="saveCalculationToHistory()">üíæ Guardar</button>
                  </div>
                </div>
              </div>

              <div id="multiMedSection" style="display:none;margin-top:20px;padding-top:20px;border-top:2px dashed var(--border);">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <h4 style="margin:0;color:var(--primary);">üíä Multi-medicamento</h4>
                  <button class="btn sm danger" onclick="clearMultiMed()">Limpiar todo</button>
                </div>
                <div id="multiMedList" style="display:flex;flex-direction:column;gap:8px;"></div>
                <div id="multiMedCompatibility" style="margin-top:12px;display:none;"></div>
                <div style="margin-top:12px;display:flex;gap:8px;">
                  <button class="btn success" onclick="copyAllMultiMedOrders()">üìã Copiar Todas</button>
                  <button class="btn primary" onclick="checkMultiMedCompatibility()">‚ö†Ô∏è Verificar Compatibilidad</button>
                </div>
              </div>

              <div id="unitConverterSection" style="margin-top:20px;padding-top:20px;border-top:2px dashed var(--border);">
                <h4 style="margin:0 0 12px 0;color:var(--primary);">üîÑ Convertidor de Unidades</h4>
                <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:end;">
                  <div>
                    <label style="font-size:12px;color:var(--muted);">Valor</label>
                    <input type="number" id="unitConvertValue" step="0.001" placeholder="Ej: 1000" class="interactive-input" oninput="convertUnits()">
                  </div>
                  <div style="display:flex;flex-direction:column;gap:4px;padding-bottom:8px;">
                    <button class="btn sm secondary" onclick="swapUnits()">‚áÑ</button>
                  </div>
                  <div>
                    <label style="font-size:12px;color:var(--muted);">Resultado</label>
                    <input type="text" id="unitConvertResult" readonly class="interactive-input" style="background:var(--bg);">
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;gap:8px;">
                  <select id="unitFrom" class="interactive-input" style="flex:1;" onchange="convertUnits()">
                    <option value="mcg">mcg (microgramos)</option>
                    <option value="mg">mg (miligramos)</option>
                    <option value="g">g (gramos)</option>
                    <option value="UI">UI (unidades)</option>
                  </select>
                  <select id="unitTo" class="interactive-input" style="flex:1;" onchange="convertUnits()">
                    <option value="mg">mg (miligramos)</option>
                    <option value="mcg">mcg (microgramos)</option>
                    <option value="g">g (gramos)</option>
                    <option value="UI">UI (unidades)</option>
                  </select>
                </div>
              </div>
            </section>

            <aside style="display:flex;flex-direction:column;gap:16px;">
              <div class="card glass" style="padding:16px;">
                <h4 style="margin:0 0 12px 0;font-size:15px;display:flex;align-items:center;gap:8px;">
                  <span>üìú</span> Historial
                  <button class="btn sm secondary" onclick="clearCalculationHistory()" style="margin-left:auto;font-size:11px;padding:4px 8px;">Limpiar</button>
                </h4>
                <div id="calculationHistory" style="max-height:300px;overflow-y:auto;">
                  <p style="color:var(--muted);font-size:13px;text-align:center;margin:0;">Sin c√°lculos recientes</p>
                </div>
              </div>

              <div class="card glass" style="padding:16px;">
                <h4 style="margin:0 0 12px 0;font-size:15px;">üìä Rangos Pedi√°tricos</h4>
                <div style="font-size:12px;line-height:1.8;">
                  <div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <strong>Fentanilo:</strong> 1-5 mcg/kg/h
                  </div>
                  <div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <strong>Midazolam:</strong> 0.05-0.2 mg/kg/h
                  </div>
                  <div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <strong>Morfina:</strong> 0.01-0.04 mg/kg/h
                  </div>
                  <div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <strong>Dopamina:</strong> 5-20 mcg/kg/min
                  </div>
                  <div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <strong>Dobutamina:</strong> 5-20 mcg/kg/min
                  </div>
                  <div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <strong>Adrenalina:</strong> 0.05-0.3 mcg/kg/min
                  </div>
                  <div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <strong>Norepinefrina:</strong> 0.05-0.5 mcg/kg/min
                  </div>
                  <div style="padding:6px 0;">
                    <strong>Milrinone:</strong> 0.25-0.75 mcg/kg/min
                  </div>
                </div>
              </div>

              <div class="card glass" style="padding:16px;">
                <h4 style="margin:0 0 12px 0;font-size:15px;">‚ö†Ô∏è Compatibilidades</h4>
                <div style="font-size:12px;line-height:1.6;color:var(--muted);">
                  <p style="margin:0 0 8px 0;"><span style="color:#ef4444;">‚óè</span> <strong>Incompatibles:</strong></p>
                  <ul style="margin:0 0 12px 0;padding-left:16px;">
                    <li>Dopamina + Bicarbonato</li>
                    <li>Adrenalina + Bicarbonato</li>
                    <li>Fenito√≠na + Dextrosa</li>
                  </ul>
                  <p style="margin:0 0 8px 0;"><span style="color:#10b981;">‚óè</span> <strong>Compatibles:</strong></p>
                  <ul style="margin:0;padding-left:16px;">
                    <li>Fentanilo + Midazolam</li>
                    <li>Dopamina + Dobutamina</li>
                  </ul>
                </div>
              </div>
            </aside>
          </div>

          <style>
            @media (max-width: 900px) {
              #infusionesTool > div:first-of-type {
                grid-template-columns: 1fr !important;
              }
              #infusionesTool aside {
                order: -1;
              }
            }
            .quick-weight-btn.active {
              background: var(--primary) !important;
              color: white !important;
            }
            .dose-indicator {
              display: inline-flex;
              align-items: center;
              gap: 4px;
              padding: 4px 10px;
              border-radius: 20px;
              font-size: 12px;
              font-weight: 600;
            }
            .dose-low {
              background: rgba(59, 130, 246, 0.15);
              color: #3b82f6;
            }
            .dose-normal {
              background: rgba(16, 185, 129, 0.15);
              color: #10b981;
            }
            .dose-high {
              background: rgba(245, 158, 11, 0.15);
              color: #f59e0b;
            }
            .dose-danger {
              background: rgba(239, 68, 68, 0.15);
              color: #ef4444;
            }
            .history-item {
              padding: 10px;
              background: var(--bg);
              border-radius: 8px;
              margin-bottom: 8px;
              font-size: 12px;
              border-left: 3px solid var(--primary);
              cursor: pointer;
              transition: all 0.2s;
            }
            .history-item:hover {
              transform: translateX(4px);
              background: rgba(var(--primary-rgb), 0.1);
            }
            .multi-med-item {
              padding: 12px;
              background: var(--bg);
              border-radius: 8px;
              border-left: 4px solid var(--primary);
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .compatibility-warning {
              padding: 12px;
              background: rgba(239, 68, 68, 0.1);
              border-left: 4px solid #ef4444;
              border-radius: 8px;
              color: #ef4444;
              font-size: 13px;
            }
            .compatibility-ok {
              padding: 12px;
              background: rgba(16, 185, 129, 0.1);
              border-left: 4px solid #10b981;
              border-radius: 8px;
              color: #10b981;
              font-size: 13px;
            }
          </style>
        </div>

        <div id="iaTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section" style="display:flex;flex-direction:column;height:calc(100vh - 180px);padding:0;overflow:hidden;background:linear-gradient(135deg, var(--card) 0%, rgba(255,255,255,0.5) 100%);">
            <div style="padding:20px;border-bottom:1px solid var(--border);background:linear-gradient(90deg, rgba(var(--primary-rgb), 0.05), transparent);">
              <div style="display:flex;align-items:center;justify-content:space-between;">
                <div>
                  <h3 style="margin:0;display:flex;align-items:center;gap:12px;font-size:22px;">
                    <span style="font-size:28px;">ü§ñ</span>
                    <span data-i18n="ia.titulo"  data-i18n="herramientas.ia_medica">Asistente M√©dico IA</span>
                  </h3>
                  <div style="margin:8px 0 0 40px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    <span style="background:linear-gradient(135deg, var(--primary), #9b59b6);color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;box-shadow:0 4px 12px rgba(var(--primary-rgb), 0.3);">‚ö° Groq Mixtral 8x7B</span>
                    <p class="text-muted" style="margin:0;font-size:12px;" data-i18n="ia.subtitle">Respuestas m√©dicas precisas en tiempo real</p>
                  </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button class="btn sm secondary" onclick="limpiarChatIA()" title="Nueva conversaci√≥n" style="transition:all 0.3s;"><span data-i18n="ia.limpiar">üóëÔ∏è Nueva</span></button>
                  <a href="https://www.openevidence.com/" target="_blank" class="btn sm secondary" style="text-decoration:none;transition:all 0.3s;">üìö Evidence</a>
                  <div style="display:flex;gap:4px;margin-left:12px;padding-left:12px;border-left:1px solid var(--border);">
                    <button class="lang-btn" data-lang="es" title="Espa√±ol" style="padding: 6px 12px; border-radius: 6px; background: var(--primary); color: white; border: none; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">ES</button>
                    <button class="lang-btn" data-lang="en" title="English" style="padding: 6px 12px; border-radius: 6px; background: transparent; color: var(--text); border: none; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">EN</button>
                    <button class="lang-btn" data-lang="pt" title="Portugu√™s" style="padding: 6px 12px; border-radius: 6px; background: transparent; color: var(--text); border: none; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">PT</button>
                  </div>
                </div>
              </div>
            </div>

            <div style="background:linear-gradient(90deg, rgba(251,191,36,0.15) 0%, transparent);border-bottom:1px solid rgba(251,191,36,0.3);padding:14px 20px;display:flex;align-items:center;gap:12px;">
              <span style="font-size:18px;">‚ö†Ô∏è</span>
              <div>
                <p style="margin:0;font-size:13px;color:var(--text);font-weight:600;">Herramienta de apoyo cl√≠nico</p>
                <p style="margin:4px 0 0 0;font-size:12px;color:var(--muted);">Verifica siempre con fuentes m√©dicas confiables. No sustituye el criterio profesional.</p>
              </div>
            </div>
            
            <div id="iaChatMessages" style="flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:20px;scroll-behavior:smooth;">
              <div style="text-align:center;color:var(--muted);padding:60px 20px;">
                <div style="font-size:64px;margin-bottom:16px;animation:bounce 2s infinite;">üí¨</div>
                <h4 style="margin:0 0 8px 0;color:var(--text);font-size:20px;font-weight:600;">¬øEn qu√© puedo ayudarte?</h4>
                <p style="margin:8px 0 0 0;font-size:14px;line-height:1.6;">Preg√∫ntame sobre tratamientos, dosificaciones, diagn√≥sticos, gu√≠as cl√≠nicas o cualquier tema de salud pedi√°trica y neonatolog√≠a.</p>
                <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:20px;">
                  <span style="background:rgba(var(--primary-rgb), 0.1);color:var(--primary);padding:8px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:all 0.3s;" onclick="document.getElementById('iaChatInput').value='¬øCu√°l es la dosis de amoxicilina para un ni√±o de 5 a√±os?'; document.getElementById('iaChatInput').focus();">üíä <span data-i18n="ia.dosispediatrica">Dosis pedi√°tricas</span></span>
                  <span style="background:rgba(var(--primary-rgb), 0.1);color:var(--primary);padding:8px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:all 0.3s;" onclick="document.getElementById('iaChatInput').value='¬øC√≥mo tratar deshidrataci√≥n en neonatos?'; document.getElementById('iaChatInput').focus();">üë∂ <span data-i18n="ia.neonatologia">Neonatolog√≠a</span></span>
                  <span style="background:rgba(var(--primary-rgb), 0.1);color:var(--primary);padding:8px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:all 0.3s;" onclick="document.getElementById('iaChatInput').value='¬øCu√°les son las contraindicaciones de la penicilina?'; document.getElementById('iaChatInput').focus();">‚öïÔ∏è <span data-i18n="ia.contraindicaciones">Contraindicaciones</span></span>
                </div>
              </div>
            </div>

            <div style="padding:20px;border-top:1px solid var(--border);background:var(--card);backdrop-filter:blur(10px);">
              <div style="display:flex;gap:12px;align-items:flex-end;">
                <textarea id="iaChatInput" rows="1" data-i18n-placeholder="ia.placeholder" placeholder="Escribe tu pregunta m√©dica..." style="flex:1;resize:none;min-height:48px;max-height:120px;padding:14px 16px;border:2px solid var(--border);border-radius:16px;font-size:14px;line-height:1.5;background:var(--card);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;transition:all 0.3s;" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();enviarMensajeIA();}" oninput="this.style.height='48px';this.style.height=this.scrollHeight+'px';" onmouseenter="this.style.borderColor='var(--primary)'" onmouseleave="this.style.borderColor='var(--border)'"></textarea>
                <button class="btn primary" id="btnEnviarIA" onclick="enviarMensajeIA()" style="padding:14px 24px;height:48px;border-radius:16px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.3s;box-shadow:0 4px 12px rgba(var(--primary-rgb), 0.3);">
                  <span id="btnEnviarIAText" style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:18px;">‚ú®</span>
                    <span style="display:none;" id="btnEnviarIAMobile"  data-i18n="common.enviar">Enviar</span>
                  </span>
                </button>
              </div>
              <p style="margin:12px 0 0 0;font-size:11px;color:var(--muted);text-align:center;">Respuestas alimentadas por Groq API ‚Ä¢ Verificadas por profesionales</p>
            </div>
          </section>

          <script src="src/utils/languageSwitcher.js"></script>

          <style>
            @keyframes bounce {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-10px); }
            }
            
            @keyframes slideIn {
              from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
              }
              to {
                opacity: 1;
                transform: translateY(0) scale(1);
              }
            }
            
            @keyframes pulse-glow {
              0%, 100% { box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.4); }
              50% { box-shadow: 0 0 0 8px rgba(var(--primary-rgb), 0); }
            }
            
            @keyframes bounce {
              0%, 80%, 100% { transform: translateY(0); }
              40% { transform: translateY(-8px); }
            }
            
            #iaChatMessages > div:not(:first-child) {
              animation: slideIn 0.3s ease-out;
            }
            
            #btnEnviarIA:hover:not(:disabled) {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(var(--primary-rgb), 0.4);
            }
            
            #btnEnviarIA:active:not(:disabled) {
              transform: translateY(0);
            }
            
            #btnEnviarIA:disabled {
              opacity: 0.6;
              cursor: not-allowed;
            }
            
            #iaChatInput:focus {
              border-color: var(--primary);
              box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
            }
          </style>
          <script src="src/utils/aiChat.js"></script>
        </div>

        <div id="guiasTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>üìö Gu√≠as Cl√≠nicas M√©dicas</h3>
            <p class="text-muted">Biblioteca indexada de protocolos m√©dicos con referencias a PubMed y UpToDate</p>
            
            <div style="margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;" id="guidesGrid">
              <div style="text-align:center;padding:40px;color:var(--muted);">Cargando gu√≠as...</div>
            </div>
          </section>
        </div>

        <div id="quizTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>‚ùì Evaluaciones Interactivas</h3>
            <p class="text-muted">Quiz para aprendizaje continuo en pediatr√≠a, neonatolog√≠a y farmacolog√≠a</p>
            
            <div style="margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;" id="quizzesGrid">
              <div style="text-align:center;padding:40px;color:var(--muted);">Cargando evaluaciones...</div>
            </div>
          </section>
        </div>

        <div id="interaccionesTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>‚ö†Ô∏è Verificador de Interacciones Medicamentosas</h3>
            <p class="text-muted">Herramienta para verificar posibles interacciones entre medicamentos. Agrega los medicamentos que el paciente est√° tomando para revisar.</p>
            
            <div style="background: rgba(251,191,36,0.1); border-left: 4px solid #fbbf24; padding: 16px; border-radius: 6px; margin: 16px 0;">
              <p style="margin: 0; font-size: 14px; color: var(--text);">
                <strong>‚ö†Ô∏è Importante:</strong> Esta herramienta es de apoyo cl√≠nico. Siempre verifica con fuentes actualizadas y tu criterio profesional antes de tomar decisiones terap√©uticas.
              </p>
            </div>
            
            <div style="margin-top: 16px;">
              <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <input type="text" id="drugInputInteraction" placeholder="Nombre del medicamento..." style="flex: 1; padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
                <button class="btn primary" onclick="agregarMedicamentoInteraction()"  data-i18n="common.agregar">Agregar</button>
              </div>
              
              <div id="medicamentosListaInteraction" style="margin-bottom: 16px;"></div>
              
              <div style="display: flex; gap: 8px;">
                <button class="btn success" onclick="verificarInteracciones()">üîç Verificar Interacciones</button>
                <button class="btn secondary" onclick="limpiarInteracciones()">üóëÔ∏è Limpiar Todo</button>
              </div>
            </div>

            <div id="interaccionesResult" style="display:none; margin-top: 20px; padding: 20px; background: var(--bg); border-radius: 8px; border-left: 4px solid var(--primary);">
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">üìä Resultados del An√°lisis</h4>
              <div id="interaccionesResultContent"></div>
            </div>
            
            <div style="margin-top: 24px; padding: 16px; background: var(--bg); border-radius: 8px;">
              <h4 style="margin: 0 0 12px 0; font-size: 14px;">Recursos Recomendados:</h4>
              <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8;">
                <li><a href="https://www.drugs.com/drug_interactions.html" target="_blank" style="color: var(--primary);">Drugs.com Drug Interactions Checker</a></li>
                <li><a href="https://reference.medscape.com/drug-interactionchecker" target="_blank" style="color: var(--primary);">Medscape Drug Interaction Checker</a></li>
                <li><a href="https://www.uptodate.com/contents/search" target="_blank" style="color: var(--primary);">UpToDate - Base de Datos de Medicamentos</a></li>
              </ul>
            </div>
          </section>
        </div>

        <div id="plantillasTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3  data-i18n="herramientas.plantillas">Plantillas</h3>
            <p class="text-muted">Guarda plantillas de evoluci√≥n por patolog√≠a y grupo etario (m√°x. 10MB por archivo).</p>
            
            <div style="margin-top: 16px;">
              <label style="display: block; margin-bottom: 8px;">
                <strong>Subir nueva plantilla:</strong>
              </label>
              <div style="display: flex; gap: 8px; align-items: end;">
                <div style="flex: 1;">
                  <label>Nombre de la plantilla</label>
                  <input type="text" id="docName" placeholder="Ej: Evoluci√≥n Neumon√≠a Pediatr√≠a">
                </div>
                <div style="flex: 1;">
                  <label>Categor√≠a</label>
                  <select id="docCategory">
                    <option value="">Seleccionar categor√≠a</option>
                    <option value="pediatria">Pediatr√≠a</option>
                    <option value="adultos">Adultos</option>
                    <option value="geriatria">Geriatr√≠a</option>
                    <option value="neonatologia">Neonatolog√≠a</option>
                    <option value="infusiones">Infusiones</option>
                    <option value="otras">Otras</option>
                  </select>
                </div>
              </div>
              <div style="margin-top: 12px;">
                <textarea id="docContent" class="text-editor" placeholder="Escribe o pega el contenido de la plantilla aqu√≠..."></textarea>
              </div>
              <div id="adminPlantillaOption" style="margin-top: 12px; display: none;">
                <label class="switch">
                  <input id="plantillaGlobal" type="checkbox">
                  <span class="slider"></span>
                  <span>Plantilla predefinida (visible para todos los usuarios)</span>
                </label>
              </div>
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="btn primary" onclick="guardarDocumento()">Guardar Plantilla</button>
                <button class="btn" onclick="limpiarFormDoc()">Limpiar Formulario</button>
              </div>
            </div>

            <div style="margin-top: 24px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; padding: 16px; background: linear-gradient(135deg, rgba(0,139,139,0.05), rgba(0,128,128,0.1)); border-radius: 12px; border: 1px solid var(--border);">
                <div style="flex: 1; min-width: 200px;">
                  <strong id="plantillasCounter" style="font-size: 16px; color: var(--primary);">Plantillas guardadas: 0</strong>
                </div>
                <select id="filterCategory" onchange="filtrarDocumentos()" style="padding: 10px 14px; border-radius: 10px; border: 2px solid var(--border); background: var(--card); font-weight: 500; cursor: pointer; transition: all 0.2s;">
                  <option value="">üìÇ Todas las categor√≠as</option>
                  <option value="pediatria">üë∂ Pediatr√≠a</option>
                  <option value="adultos">üë®‚Äç‚öïÔ∏è Adultos</option>
                  <option value="geriatria">üë¥ Geriatr√≠a</option>
                  <option value="neonatologia">üëº Neonatolog√≠a</option>
                  <option value="infusiones">üíâ Infusiones</option>
                  <option value="otras">üìã Otras</option>
                </select>
                <input type="search" id="searchDoc" placeholder="üîç Buscar plantilla..." onkeyup="filtrarDocumentos()" style="padding: 10px 14px; border-radius: 10px; border: 2px solid var(--border); min-width: 250px; background: var(--card); transition: all 0.2s;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(0,139,139,0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
              </div>
              <div id="docList" class="doc-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px;"></div>
            </div>
          </section>
        </div>
        <footer class="app-footer">
          <div class="footer-links">
            <a href="privacidad.html">Pol√≠tica de Privacidad</a>
            <span class="separator">|</span>
            <a href="terminos.html">T√©rminos y Condiciones</a>
            <span class="separator">|</span>
            <a href="aviso-legal.html">Aviso Legal</a>
            <span class="separator">|</span>
            <a href="cookies.html">Cookies</a>
          </div>
          <p class="trademark">NBR¬Æ 2025 | Med Tools Hub</p>
          <p class="contact">contacto@medtoolshub.cloud</p>
        </footer>
      </main>
    </div>
  </div>

  <div id="editModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index:1000; padding:20px; animation: fadeIn 0.2s ease;">
    <div style="max-width: 1000px; margin: 20px auto; background: var(--card); border-radius: 16px; padding: 32px; max-height: calc(100vh - 80px); overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border);">
        <h3 id="editDocTitle" style="margin: 0; font-size: 24px; color: var(--primary);">Editar Plantilla</h3>
        <button onclick="cerrarEditor()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--muted); transition: all 0.2s;" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--muted)'">&times;</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text);">Nombre de la plantilla</label>
          <input type="text" id="editDocName" style="width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; transition: all 0.2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text);">Categor√≠a</label>
          <select id="editDocCategory" style="width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; transition: all 0.2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
            <option value="">Seleccionar categor√≠a</option>
            <option value="pediatria">üë∂ Pediatr√≠a</option>
            <option value="adultos">üë®‚Äç‚öïÔ∏è Adultos</option>
            <option value="geriatria">üë¥ Geriatr√≠a</option>
            <option value="neonatologia">üëº Neonatolog√≠a</option>
            <option value="infusiones">üíâ Infusiones</option>
            <option value="otras">üìã Otras</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text);">Contenido</label>
        <textarea id="editDocContent" class="text-editor" style="min-height: 300px; font-size: 14px; line-height: 1.6; border: 2px solid var(--border); transition: all 0.2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"></textarea>
      </div>
      <div id="editAdminPlantillaOption" style="margin-bottom: 16px; display: none;">
        <label class="switch">
          <input id="editPlantillaGlobal" type="checkbox">
          <span class="slider"></span>
          <span>Plantilla predefinida (visible para todos los usuarios)</span>
        </label>
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn secondary" onclick="cerrarEditor()"  data-i18n="common.cancelar">Cancelar</button>
        <button class="btn primary" onclick="guardarEdicion()">üíæ Guardar Cambios</button>
      </div>
    </div>
  </div>
  
  <div id="previewModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index:1000; padding:20px; animation: fadeIn 0.2s ease;">
    <div style="max-width: 900px; margin: 20px auto; background: var(--card); border-radius: 16px; padding: 32px; max-height: calc(100vh - 80px); overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border);">
        <div>
          <h3 id="previewDocTitle" style="margin: 0 0 4px 0; font-size: 24px; color: var(--primary);">Vista Previa</h3>
          <p id="previewDocMeta" style="margin: 0; font-size: 14px; color: var(--muted);"></p>
        </div>
        <button onclick="cerrarPreview()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--muted); transition: all 0.2s;" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--muted)'">&times;</button>
      </div>
      <div id="previewDocContent" style="background: rgba(var(--primary-rgb), 0.03); padding: 24px; border-radius: 12px; border: 1px solid var(--border); min-height: 300px; white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; line-height: 1.8; color: var(--text);"></div>
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn secondary" onclick="cerrarPreview()">Cerrar</button>
        <button class="btn success" onclick="copiarContenidoPreview()">üìã Copiar Contenido</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    let documentos = [];
    let editandoDocId = null;
    let currentUser = null;
    let infusionMedications = [];

    window.initHerramientas = async function() {
      const session = await checkSession();
      currentUser = session;
      
      if (session.role === 'admin') {
        document.getElementById('adminPlantillaOption').style.display = 'block';
        document.getElementById('editAdminPlantillaOption').style.display = 'block';
        document.getElementById('adminInfusionesLink').style.display = 'inline-block';
      }
      
      document.addEventListener('mouseup', handleCellMouseUp);
      
      loadInfusionMedications();
      loadToolsStatus();
      showMenu();
    }

    function showMenu() {
      document.getElementById('toolMenu').style.display = 'grid';
      document.getElementById('correctorTool').style.display = 'none';
      document.getElementById('gasesTool').style.display = 'none';
      document.getElementById('infusionesTool').style.display = 'none';
      document.getElementById('plantillasTool').style.display = 'none';
      document.getElementById('iaTool').style.display = 'none';
      document.getElementById('interaccionesTool').style.display = 'none';
    }

    let toolsStatusCache = null;
    
    async function loadToolsStatus() {
      try {
        toolsStatusCache = await api('/tools/status');
      } catch (err) {
        console.error('Error loading tools status:', err);
        toolsStatusCache = {};
      }
    }
    
    window.showTool = function(tool) {
      if (toolsStatusCache === null) {
        setTimeout(() => window.showTool(tool), 100);
        return;
      }
      
      document.querySelectorAll('[id$="Tool"]').forEach(el => el.style.display = 'none');
      document.getElementById('toolMenu').style.display = 'none';
      
      if (currentUser && currentUser.role !== 'admin' && toolsStatusCache[tool] && !toolsStatusCache[tool].enabled) {
        alert(`‚ö†Ô∏è La herramienta "${toolsStatusCache[tool].name}" no est√° disponible temporalmente. Estamos trabajando en mejoras.`);
        document.getElementById('toolMenu').style.display = 'grid';
        return;
      }
      
      const toolMap = {
        'corrector': 'correctorTool',
        'gases': 'gasesTool',
        'infusiones': 'infusionesTool',
        'plantillas': 'plantillasTool',
        'ia': 'iaTool',
        'interacciones': 'interaccionesTool',
        'guias': 'guiasTool',
        'quiz': 'quizTool'
      };
      
      const toolId = toolMap[tool];
      if (toolId) {
        document.getElementById(toolId).style.display = 'block';
        if (tool === 'plantillas') cargarDocumentos();
        if (tool === 'guias' && window.cargarGuiasClinicas) cargarGuiasClinicas();
        if (tool === 'quiz' && window.cargarQuizzes) cargarQuizzes();
      }
    }

    function actualizarContadores() {
      const texto = document.getElementById('textInput').value;
      const chars = texto.length;
      const words = texto.trim() === '' ? 0 : texto.trim().split(/\s+/).length;
      const lines = texto === '' ? 0 : texto.split('\n').length;
      
      document.getElementById('charCounter').textContent = chars;
      document.getElementById('wordCounter').textContent = words;
      document.getElementById('lineCounter').textContent = lines;
    }

    function aplicarOperacion(tipo) {
      const input = document.getElementById('textInput');
      let texto = input.value;
      
      switch(tipo) {
        case 'espacios':
          texto = texto
            .replace(/\s+/g, ' ')
            .replace(/^\s+|\s+$/g, '')
            .replace(/\s+([.,;:!?])/g, '$1')
            .replace(/([.,;:!?])(\w)/g, '$1 $2');
          break;
        case 'mayusculas':
          texto = texto.toUpperCase();
          break;
        case 'minusculas':
          texto = texto.toLowerCase();
          break;
        case 'capitalizar':
          texto = texto.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
          break;
        case 'oracion':
          texto = texto.toLowerCase().replace(/(^\w|[.!?]\s+\w)/g, l => l.toUpperCase());
          break;
        case 'invertir':
          texto = texto.split('').reverse().join('');
          break;
        case 'eliminarSaltos':
          texto = texto.replace(/\n+/g, ' ').replace(/\s+/g, ' ').trim();
          break;
        case 'duplicar':
          const lineas = texto.split('\n');
          const unicas = [...new Set(lineas)];
          texto = unicas.join('\n');
          break;
      }
      
      input.value = texto;
      actualizarContadores();
      showToast('Operaci√≥n aplicada correctamente', 'success');
    }

    function limpiarTexto() {
      document.getElementById('textInput').value = '';
      actualizarContadores();
    }

    function copiarTexto() {
      const texto = document.getElementById('textInput').value;
      if (!texto) {
        showToast('No hay texto para copiar', 'error');
        return;
      }
      navigator.clipboard.writeText(texto).then(() => {
        showToast('Texto copiado al portapapeles', 'success');
      }).catch(() => {
        showToast('Error al copiar texto', 'error');
      });
    }

    function autoExpandTextarea() {
      const textarea = document.getElementById('textInput');
      if (!textarea) return;
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 600) + 'px';
    }

    function toggleExcelView() {
      const normalView = document.getElementById('normalTextView');
      const excelView = document.getElementById('excelView');
      const icon = document.getElementById('excelViewIcon');
      const text = document.getElementById('excelViewText');
      
      if (excelView.style.display === 'none') {
        normalView.style.display = 'none';
        excelView.style.display = 'block';
        icon.textContent = 'üìù';
        text.textContent = 'Vista Normal';
        
        const textContent = document.getElementById('textInput').value;
        if (textContent) {
          parseTextToTable(textContent);
        } else {
          initEmptyTable();
        }
      } else {
        excelView.style.display = 'none';
        normalView.style.display = 'block';
        icon.textContent = 'üìä';
        text.textContent = 'Vista Tabla';
      }
    }

    let selectedCells = [];
    let isDragging = false;
    let dragStartCell = null;
    let hasDragged = false;

    function selectCell(td, isAdding = false) {
      if (!isAdding && selectedCells.indexOf(td) === -1) {
        selectedCells.forEach(cell => {
          cell.style.backgroundColor = 'var(--card)';
          cell.style.outline = 'none';
        });
        selectedCells = [];
      }
      
      const cellIndex = selectedCells.indexOf(td);
      if (cellIndex === -1) {
        selectedCells.push(td);
        td.style.backgroundColor = 'rgba(33, 150, 243, 0.1)';
        td.style.outline = '2px solid #2196f3';
      }
    }

    function handleCellClick(td, event) {
      if (hasDragged) {
        hasDragged = false;
        return;
      }
      
      const isCtrlOrCmd = event.ctrlKey || event.metaKey;
      
      if (!isCtrlOrCmd) {
        selectedCells.forEach(cell => {
          cell.style.backgroundColor = 'var(--card)';
          cell.style.outline = 'none';
        });
        selectedCells = [];
      }
      
      const cellIndex = selectedCells.indexOf(td);
      if (cellIndex > -1) {
        td.style.backgroundColor = 'var(--card)';
        td.style.outline = 'none';
        selectedCells.splice(cellIndex, 1);
      } else {
        selectedCells.push(td);
        td.style.backgroundColor = 'rgba(33, 150, 243, 0.1)';
        td.style.outline = '2px solid #2196f3';
      }
      
      if (selectedCells.length === 1 && !isCtrlOrCmd) {
        td.focus();
        const range = document.createRange();
        range.selectNodeContents(td);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    function handleCellMouseDown(td, event) {
      if (event.button !== 0) return;
      
      isDragging = true;
      dragStartCell = td;
      hasDragged = false;
      
      const isCtrlOrCmd = event.ctrlKey || event.metaKey;
      
      if (!isCtrlOrCmd) {
        selectedCells.forEach(cell => {
          cell.style.backgroundColor = 'var(--card)';
          cell.style.outline = 'none';
        });
        selectedCells = [];
      }
      
      selectCell(td, isCtrlOrCmd);
      
      event.preventDefault();
    }

    function handleCellMouseEnter(td, event) {
      if (isDragging && dragStartCell) {
        hasDragged = true;
        selectCell(td, true);
      }
    }

    function handleCellMouseUp(event) {
      if (isDragging) {
        isDragging = false;
        dragStartCell = null;
      }
    }

    document.addEventListener('keydown', function(event) {
      if ((event.ctrlKey || event.metaKey) && event.key === 'c') {
        if (selectedCells.length > 0 && document.getElementById('excelView').style.display !== 'none') {
          event.preventDefault();
          copySelectedCells();
        }
      }
    });

    function parseTextToTable(text) {
      const tbody = document.getElementById('excelTableBody');
      tbody.innerHTML = '';
      
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length === 0) {
        initEmptyTable();
        return;
      }
      
      let delimiter = '\t';
      if (!text.includes('\t')) {
        const firstLine = lines[0];
        if (firstLine.includes('|')) {
          delimiter = '|';
        } else if (firstLine.match(/\s{2,}/)) {
          delimiter = /\s{2,}/;
        } else {
          delimiter = '  ';
        }
      }
      
      lines.forEach((line, rowIndex) => {
        const cells = typeof delimiter === 'string' ? 
          line.split(delimiter) : 
          line.split(delimiter);
        const tr = document.createElement('tr');
        
        cells.forEach((cellText, colIndex) => {
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.textContent = cellText.trim();
          td.style.border = '1px solid #e2e8f0';
          td.style.padding = '8px 12px';
          td.style.minWidth = '80px';
          td.style.cursor = 'pointer';
          td.style.backgroundColor = 'var(--card)';
          td.style.transition = 'background-color 0.2s';
          
          td.addEventListener('click', function(e) {
            handleCellClick(td, e);
          });
          
          td.addEventListener('mousedown', function(e) {
            handleCellMouseDown(td, e);
          });
          
          td.addEventListener('mouseenter', function(e) {
            handleCellMouseEnter(td, e);
          });
          
          td.addEventListener('dblclick', function() {
            const text = td.textContent.trim();
            if (text) {
              navigator.clipboard.writeText(text).then(() => {
                showToast('Celda copiada: ' + text.substring(0, 30) + (text.length > 30 ? '...' : ''), 'success');
              });
            }
          });
          
          td.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            
            if (pastedText.includes('\t') || pastedText.includes('\n')) {
              const tbody = document.getElementById('excelTableBody');
              const currentRow = td.parentElement;
              const rowIndex = Array.from(tbody.rows).indexOf(currentRow);
              const colIndex = Array.from(currentRow.cells).indexOf(td);
              
              const lines = pastedText.split('\n').filter(line => line);
              lines.forEach((line, lineIdx) => {
                const cells = line.split('\t');
                const targetRowIndex = rowIndex + lineIdx;
                
                while (tbody.rows.length <= targetRowIndex) {
                  addExcelRow();
                }
                
                const targetRow = tbody.rows[targetRowIndex];
                cells.forEach((cellText, cellIdx) => {
                  const targetColIndex = colIndex + cellIdx;
                  
                  while (targetRow.cells.length <= targetColIndex) {
                    addCellToRow(targetRow);
                  }
                  
                  targetRow.cells[targetColIndex].textContent = cellText.trim();
                });
              });
              
              showToast('Datos pegados en la tabla', 'success');
            } else {
              td.textContent = pastedText;
            }
          });
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
    }

    function copySelectedCells() {
      if (selectedCells.length === 0) {
        showToast('Selecciona al menos una celda primero', 'error');
        return;
      }
      
      const tbody = document.getElementById('excelTableBody');
      const rows = Array.from(tbody.rows);
      
      const cellPositions = selectedCells.map(cell => {
        const row = cell.parentElement;
        const rowIndex = rows.indexOf(row);
        const colIndex = Array.from(row.cells).indexOf(cell);
        return { cell, rowIndex, colIndex, text: cell.textContent.trim() };
      });
      
      cellPositions.sort((a, b) => {
        if (a.rowIndex !== b.rowIndex) return a.rowIndex - b.rowIndex;
        return a.colIndex - b.colIndex;
      });
      
      const minRow = Math.min(...cellPositions.map(p => p.rowIndex));
      const maxRow = Math.max(...cellPositions.map(p => p.rowIndex));
      const minCol = Math.min(...cellPositions.map(p => p.colIndex));
      const maxCol = Math.max(...cellPositions.map(p => p.colIndex));
      
      let clipboardText = '';
      for (let r = minRow; r <= maxRow; r++) {
        const rowCells = [];
        for (let c = minCol; c <= maxCol; c++) {
          const cellPos = cellPositions.find(p => p.rowIndex === r && p.colIndex === c);
          rowCells.push(cellPos ? cellPos.text : '');
        }
        clipboardText += rowCells.join('\t') + '\n';
      }
      
      navigator.clipboard.writeText(clipboardText.trim()).then(() => {
        showToast(`${selectedCells.length} celda(s) copiada(s) en formato tabla`, 'success');
      }).catch(() => {
        showToast('Error al copiar celdas', 'error');
      });
    }

    function addCellToRow(row) {
      const td = document.createElement('td');
      td.contentEditable = 'true';
      td.style.border = '1px solid #e2e8f0';
      td.style.padding = '8px 12px';
      td.style.minWidth = '80px';
      td.style.cursor = 'pointer';
      td.style.backgroundColor = 'var(--card)';
      td.style.transition = 'background-color 0.2s';
      
      td.addEventListener('click', function(e) {
        handleCellClick(td, e);
      });
      
      td.addEventListener('mousedown', function(e) {
        handleCellMouseDown(td, e);
      });
      
      td.addEventListener('mouseenter', function(e) {
        handleCellMouseEnter(td, e);
      });
      
      td.addEventListener('dblclick', function() {
        const text = td.textContent.trim();
        if (text) {
          navigator.clipboard.writeText(text).then(() => {
            showToast('Celda copiada: ' + text.substring(0, 30) + (text.length > 30 ? '...' : ''), 'success');
          });
        }
      });
      
      td.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        
        if (pastedText.includes('\t') || pastedText.includes('\n')) {
          const tbody = document.getElementById('excelTableBody');
          const currentRow = td.parentElement;
          const rowIndex = Array.from(tbody.rows).indexOf(currentRow);
          const colIndex = Array.from(currentRow.cells).indexOf(td);
          
          const lines = pastedText.split('\n').filter(line => line);
          lines.forEach((line, lineIdx) => {
            const cells = line.split('\t');
            const targetRowIndex = rowIndex + lineIdx;
            
            while (tbody.rows.length <= targetRowIndex) {
              addExcelRow();
            }
            
            const targetRow = tbody.rows[targetRowIndex];
            cells.forEach((cellText, cellIdx) => {
              const targetColIndex = colIndex + cellIdx;
              
              while (targetRow.cells.length <= targetColIndex) {
                addCellToRow(targetRow);
              }
              
              targetRow.cells[targetColIndex].textContent = cellText.trim();
            });
          });
          
          showToast('Datos pegados en la tabla', 'success');
        } else {
          td.textContent = pastedText;
        }
      });
      
      row.appendChild(td);
      return td;
    }

    function initEmptyTable() {
      const tbody = document.getElementById('excelTableBody');
      tbody.innerHTML = '';
      
      for (let i = 0; i < 5; i++) {
        addExcelRow();
      }
    }

    function addExcelRow() {
      const tbody = document.getElementById('excelTableBody');
      const tr = document.createElement('tr');
      const colCount = tbody.rows.length > 0 ? tbody.rows[0].cells.length : 3;
      
      for (let i = 0; i < (colCount || 3); i++) {
        addCellToRow(tr);
      }
      
      tbody.appendChild(tr);
    }

    function addExcelColumn() {
      const tbody = document.getElementById('excelTableBody');
      const rows = tbody.rows;
      
      if (rows.length === 0) {
        initEmptyTable();
        return;
      }
      
      for (let row of rows) {
        addCellToRow(row);
      }
    }

    function clearExcelTable() {
      const tbody = document.getElementById('excelTableBody');
      tbody.innerHTML = '';
      initEmptyTable();
    }

    function copyExcelTable() {
      const tbody = document.getElementById('excelTableBody');
      const rows = tbody.rows;
      
      if (rows.length === 0) {
        showToast('La tabla est√° vac√≠a', 'error');
        return;
      }
      
      let text = '';
      for (let row of rows) {
        const cells = Array.from(row.cells).map(cell => cell.textContent.trim());
        text += cells.join('\t') + '\n';
      }
      
      navigator.clipboard.writeText(text).then(() => {
        showToast('Tabla copiada al portapapeles', 'success');
      }).catch(() => {
        showToast('Error al copiar tabla', 'error');
      });
    }

    function validateGSAInput(field, value, min, max) {
      const statusEl = document.getElementById(`status${field}`);
      if (!statusEl) return;
      
      if (value === '' || isNaN(value)) {
        statusEl.textContent = '';
        statusEl.style.color = '';
        return;
      }
      
      const numValue = parseFloat(value);
      if (numValue < min) {
        statusEl.textContent = '‚Üì Bajo';
        statusEl.style.color = '#ef4444';
      } else if (numValue > max) {
        statusEl.textContent = '‚Üë Alto';
        statusEl.style.color = '#f59e0b';
      } else {
        statusEl.textContent = '‚úì Normal';
        statusEl.style.color = '#10b981';
      }
    }

    function interpretarGSA() {
      const pH = parseFloat(document.getElementById('gsaPH').value);
      const paCO2 = parseFloat(document.getElementById('gsaPaCO2').value);
      const paO2 = parseFloat(document.getElementById('gsaPaO2').value);
      const hco3 = parseFloat(document.getElementById('gsaHCO3').value);

      if (isNaN(pH) || isNaN(paCO2) || isNaN(hco3)) {
        alert('Por favor, completa al menos pH, PaCO‚ÇÇ y HCO‚ÇÉ');
        return;
      }

      let diagnostico = '';
      let estado = '';
      let oxigenacion = '';

      if (pH >= 7.35 && pH <= 7.45) {
        if (paCO2 >= 35 && paCO2 <= 45 && hco3 >= 22 && hco3 <= 26) {
          diagnostico = 'Normal';
          estado = 'Sin alteraciones';
        } else if (paCO2 > 45 && hco3 > 26) {
          diagnostico = 'Acidosis Respiratoria';
          estado = 'Compensada';
        } else if (paCO2 < 35 && hco3 < 22) {
          diagnostico = 'Alcalosis Respiratoria';
          estado = 'Compensada';
        } else if (paCO2 < 35 && hco3 > 26) {
          diagnostico = 'Alcalosis Metab√≥lica';
          estado = 'Compensada';
        } else if (paCO2 > 45 && hco3 < 22) {
          diagnostico = 'Acidosis Metab√≥lica';
          estado = 'Compensada';
        }
      } else if (pH < 7.35) {
        if (paCO2 > 45 && hco3 >= 22 && hco3 <= 26) {
          diagnostico = 'Acidosis Respiratoria';
          estado = 'Aguda';
        } else if (paCO2 > 45 && hco3 > 26) {
          diagnostico = 'Acidosis Respiratoria';
          estado = 'Parcialmente Compensada';
        } else if (hco3 < 22 && paCO2 >= 35 && paCO2 <= 45) {
          diagnostico = 'Acidosis Metab√≥lica';
          estado = 'Aguda';
        } else if (hco3 < 22 && paCO2 < 35) {
          diagnostico = 'Acidosis Metab√≥lica';
          estado = 'Parcialmente Compensada';
        }
      } else if (pH > 7.45) {
        if (paCO2 < 35 && hco3 >= 22 && hco3 <= 26) {
          diagnostico = 'Alcalosis Respiratoria';
          estado = 'Aguda';
        } else if (paCO2 < 35 && hco3 < 22) {
          diagnostico = 'Alcalosis Respiratoria';
          estado = 'Parcialmente Compensada';
        } else if (hco3 > 26 && paCO2 >= 35 && paCO2 <= 45) {
          diagnostico = 'Alcalosis Metab√≥lica';
          estado = 'Aguda';
        } else if (hco3 > 26 && paCO2 > 45) {
          diagnostico = 'Alcalosis Metab√≥lica';
          estado = 'Parcialmente Compensada';
        }
      }

      if (!isNaN(paO2)) {
        if (paO2 < 60) {
          oxigenacion = 'Hipoxemia severa';
        } else if (paO2 < 80) {
          oxigenacion = 'Hipoxemia moderada';
        } else if (paO2 >= 80 && paO2 <= 95) {
          oxigenacion = 'Normal';
        } else {
          oxigenacion = 'Hiperoxia';
        }
      }

      let html = '<div class="gsa-result">';
      html += '<h4>üìä Interpretaci√≥n de Gasometr√≠a</h4>';
      html += `<p><strong>Diagn√≥stico:</strong> ${diagnostico || 'No determinado'}</p>`;
      if (estado) html += `<p><strong>Estado:</strong> ${estado}</p>`;
      if (oxigenacion) html += `<p><strong>Oxigenaci√≥n:</strong> ${oxigenacion}</p>`;
      html += '<hr style="margin: 12px 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">';
      html += '<p style="font-size: 14px;"><strong>Valores ingresados:</strong></p>';
      html += `<p style="font-size: 14px;">‚Ä¢ pH: ${pH.toFixed(2)} ${pH < 7.35 ? '‚Üì' : pH > 7.45 ? '‚Üë' : '‚úì'}</p>`;
      html += `<p style="font-size: 14px;">‚Ä¢ PaCO‚ÇÇ: ${paCO2.toFixed(1)} mmHg ${paCO2 < 35 ? '‚Üì' : paCO2 > 45 ? '‚Üë' : '‚úì'}</p>`;
      if (!isNaN(paO2)) html += `<p style="font-size: 14px;">‚Ä¢ PaO‚ÇÇ: ${paO2.toFixed(1)} mmHg ${paO2 < 80 ? '‚Üì' : paO2 > 95 ? '‚Üë' : '‚úì'}</p>`;
      html += `<p style="font-size: 14px;">‚Ä¢ HCO‚ÇÉ: ${hco3.toFixed(1)} mEq/L ${hco3 < 22 ? '‚Üì' : hco3 > 26 ? '‚Üë' : '‚úì'}</p>`;
      html += '</div>';

      document.getElementById('gsaResult').innerHTML = html;
      document.getElementById('gsaResult').style.display = 'block';
    }

    function limpiarGSA() {
      document.getElementById('gsaPH').value = '';
      document.getElementById('gsaPaCO2').value = '';
      document.getElementById('gsaPaO2').value = '';
      document.getElementById('gsaHCO3').value = '';
      document.getElementById('statusPH').textContent = '';
      document.getElementById('statusPaCO2').textContent = '';
      document.getElementById('statusPaO2').textContent = '';
      document.getElementById('statusHCO3').textContent = '';
      document.getElementById('gsaResult').style.display = 'none';
    }

    document.getElementById('gsaPH')?.addEventListener('input', (e) => {
      validateGSAInput('PH', e.target.value, 7.35, 7.45);
    });
    document.getElementById('gsaPaCO2')?.addEventListener('input', (e) => {
      validateGSAInput('PaCO2', e.target.value, 35, 45);
    });
    document.getElementById('gsaPaO2')?.addEventListener('input', (e) => {
      validateGSAInput('PaO2', e.target.value, 80, 95);
    });
    document.getElementById('gsaHCO3')?.addEventListener('input', (e) => {
      validateGSAInput('HCO3', e.target.value, 22, 26);
    });

    function calcularIO() {
      const fio2Percent = parseFloat(document.getElementById('ioFiO2').value);
      const map = parseFloat(document.getElementById('ioMAP').value);
      const pao2 = parseFloat(document.getElementById('ioPaO2').value);

      if (isNaN(fio2Percent) || isNaN(map) || isNaN(pao2)) {
        alert('Por favor, completa todos los campos (FiO‚ÇÇ, MAP y PaO‚ÇÇ)');
        return;
      }

      if (pao2 <= 0) {
        alert('PaO‚ÇÇ debe ser mayor que 0');
        return;
      }

      const fio2 = fio2Percent / 100;
      const io = (fio2 * 100 * map) / pao2;

      let interpretacion = '';
      let severidad = '';
      let color = '';

      if (io < 4) {
        interpretacion = 'Oxigenaci√≥n normal';
        severidad = 'Sin compromiso respiratorio';
        color = '#10b981';
      } else if (io >= 4 && io < 8) {
        interpretacion = 'Hipoxemia leve';
        severidad = 'Monitoreo y optimizaci√≥n ventilatoria';
        color = '#3b82f6';
      } else if (io >= 8 && io < 16) {
        interpretacion = 'Hipoxemia moderada';
        severidad = 'Vigilancia estrecha y ajustes ventilatorios';
        color = '#f59e0b';
      } else if (io >= 16 && io < 25) {
        interpretacion = 'Hipoxemia severa';
        severidad = 'Considerar estrategias avanzadas de ventilaci√≥n';
        color = '#ef4444';
      } else {
        interpretacion = 'Hipoxemia cr√≠tica';
        severidad = 'Valorar VAFO, ECMO u otras terapias de rescate';
        color = '#991b1b';
      }

      let html = '<div class="gsa-result" style="border-left: 4px solid ' + color + ';">';
      html += '<h4>üìä √çndice de Oxigenaci√≥n</h4>';
      html += `<p style="font-size: 24px; font-weight: 700; margin: 12px 0; color: ${color};">IO = ${io.toFixed(2)}</p>`;
      html += `<p><strong>Interpretaci√≥n:</strong> ${interpretacion}</p>`;
      html += `<p><strong>Recomendaci√≥n:</strong> ${severidad}</p>`;
      html += '<hr style="margin: 12px 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">';
      html += '<p style="font-size: 14px;"><strong>Valores ingresados:</strong></p>';
      html += `<p style="font-size: 14px;">‚Ä¢ FiO‚ÇÇ: ${fio2Percent}% (${fio2.toFixed(2)})</p>`;
      html += `<p style="font-size: 14px;">‚Ä¢ MAP: ${map.toFixed(1)} cmH‚ÇÇO</p>`;
      html += `<p style="font-size: 14px;">‚Ä¢ PaO‚ÇÇ: ${pao2.toFixed(1)} mmHg</p>`;
      html += '<hr style="margin: 12px 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">';
      html += '<p style="font-size: 13px; opacity: 0.9;"><strong>F√≥rmula:</strong> IO = (FiO‚ÇÇ √ó MAP √ó 100) / PaO‚ÇÇ</p>';
      html += '<p style="font-size: 12px; opacity: 0.8;">IO < 4: Normal | 4-8: Leve | 8-16: Moderado | 16-25: Severo | > 25: Cr√≠tico</p>';
      html += '</div>';

      document.getElementById('ioResult').innerHTML = html;
      document.getElementById('ioResult').style.display = 'block';
    }

    function limpiarIO() {
      document.getElementById('ioFiO2').value = '';
      document.getElementById('ioMAP').value = '';
      document.getElementById('ioPaO2').value = '';
      document.getElementById('statusFiO2').textContent = '';
      document.getElementById('statusMAP').textContent = '';
      document.getElementById('statusIOPaO2').textContent = '';
      document.getElementById('ioResult').style.display = 'none';
    }

    document.getElementById('ioFiO2')?.addEventListener('input', (e) => {
      const statusEl = document.getElementById('statusFiO2');
      const value = parseFloat(e.target.value);
      if (isNaN(value) || value === '') {
        statusEl.textContent = '';
      } else if (value < 21) {
        statusEl.textContent = '‚Üì Bajo';
        statusEl.style.color = '#ef4444';
      } else if (value >= 21 && value <= 40) {
        statusEl.textContent = '‚úì Bajo';
        statusEl.style.color = '#10b981';
      } else if (value > 40 && value <= 60) {
        statusEl.textContent = '‚ö† Moderado';
        statusEl.style.color = '#f59e0b';
      } else {
        statusEl.textContent = '‚ö† Alto';
        statusEl.style.color = '#ef4444';
      }
    });

    document.getElementById('ioMAP')?.addEventListener('input', (e) => {
      const statusEl = document.getElementById('statusMAP');
      const value = parseFloat(e.target.value);
      if (isNaN(value) || value === '') {
        statusEl.textContent = '';
      } else if (value < 5) {
        statusEl.textContent = '‚Üì Bajo';
        statusEl.style.color = '#ef4444';
      } else if (value >= 5 && value <= 15) {
        statusEl.textContent = '‚úì Normal';
        statusEl.style.color = '#10b981';
      } else {
        statusEl.textContent = '‚Üë Alto';
        statusEl.style.color = '#f59e0b';
      }
    });

    document.getElementById('ioPaO2')?.addEventListener('input', (e) => {
      const statusEl = document.getElementById('statusIOPaO2');
      const value = parseFloat(e.target.value);
      if (isNaN(value) || value === '') {
        statusEl.textContent = '';
      } else if (value < 60) {
        statusEl.textContent = '‚Üì Hipoxemia severa';
        statusEl.style.color = '#ef4444';
      } else if (value >= 60 && value < 80) {
        statusEl.textContent = '‚Üì Hipoxemia moderada';
        statusEl.style.color = '#f59e0b';
      } else if (value >= 80 && value <= 95) {
        statusEl.textContent = '‚úì Normal';
        statusEl.style.color = '#10b981';
      } else {
        statusEl.textContent = '‚Üë Hiperoxia';
        statusEl.style.color = '#f59e0b';
      }
    });

    async function loadInfusionMedications() {
      try {
        const response = await fetch('/api/medications/infusions/list');
        if (!response.ok) throw new Error('Failed to load medications');
        infusionMedications = await response.json();
        
        // Cargar presentaciones para cada medicamento
        for (let med of infusionMedications) {
          const presResponse = await fetch(`/api/medications/presentations/${med.id}`);
          if (presResponse.ok) {
            med.presentations = await presResponse.json();
          }
        }
      } catch (err) {
        console.warn('Error loading medications from server, using defaults:', err);
        // Fallback a valores por defecto
        infusionMedications = [
          {
            id: 1,
            nombre: 'FENTANILO',
            dosis: '1MCG/KG/HORA',
            unidad: 'mcg/kg/h',
            presentations: [{
              id: 1,
              descripcion: '500MCG/10ML = 50MCG/ML',
              diluciones: ['12CC', '24CC', '50CC', '100CC'],
              concentracion: 50
            }]
          },
          {
            id: 2,
            nombre: 'MIDAZOLAM',
            dosis: '0.1MG/KG/HORA',
            unidad: 'mg/kg/h',
            presentations: [{
              id: 2,
              descripcion: '15MG/3ML = 5MG/1ML',
              diluciones: ['12CC', '24CC', '50CC', '100CC'],
              concentracion: 5
            }]
          },
          {
            id: 3,
            nombre: 'MORFINA',
            dosis: '0.1MG/KG/HORA',
            unidad: 'mg/kg/h',
            presentations: [{
              id: 3,
              descripcion: '10MG/ML',
              diluciones: ['12CC', '24CC', '50CC', '100CC'],
              concentracion: 10
            }]
          },
          {
            id: 4,
            nombre: 'DOPAMINA',
            dosis: '5MCG/KG/MIN',
            unidad: 'mcg/kg/min',
            presentations: [{
              id: 4,
              descripcion: '200MG/5ML = 40MG/ML',
              diluciones: ['12CC', '24CC', '50CC', '100CC'],
              concentracion: 40
            }]
          },
          {
            id: 5,
            nombre: 'ADRENALINA',
            dosis: '0.1MCG/KG/MIN',
            unidad: 'mcg/kg/min',
            presentations: [{
              id: 5,
              descripcion: '1MG/ML',
              diluciones: ['12CC', '24CC', '50CC', '100CC'],
              concentracion: 1000
            }]
          },
          {
            id: 6,
            nombre: 'DOBUTAMINA',
            dosis: '5MCG/KG/MIN',
            unidad: 'mcg/kg/min',
            presentations: [{
              id: 6,
              descripcion: '250MG/10ML = 25MG/ML',
              diluciones: ['12CC', '24CC', '50CC', '100CC'],
              concentracion: 12.5
            }]
          }
        ];
      }
      
      const select = document.getElementById('medicationSelect');
      if (!select) return;
      select.innerHTML = '<option value="">Seleccionar medicamento</option>';
      infusionMedications.forEach((med, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = med.nombre;
        select.appendChild(option);
      });
    }

    function loadMedication() {
      const select = document.getElementById('medicationSelect');
      const index = parseInt(select.value);
      
      if (isNaN(index) || !infusionMedications[index]) {
        document.getElementById('medicationInfo').style.display = 'none';
        return;
      }
      
      const med = infusionMedications[index];
      if (!med.presentations) med.presentations = [];
      
      const presSelect = document.getElementById('presentationSelect');
      presSelect.innerHTML = '<option value="">Seleccionar presentaci√≥n</option>';
      if (med.presentations.length > 0) {
        med.presentations.forEach((pres, i) => {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = pres.descripcion;
          presSelect.appendChild(option);
        });
        presSelect.value = 0;
      }
      
      loadPresentation();
      
      let details = `Dosis: ${med.dosis}`;
      if (med.grupo) details += ` ‚Ä¢ Grupo: ${med.grupo}`;
      if (med.comentarios) details += `<br>${med.comentarios}`;
      document.getElementById('medicationDetails').innerHTML = details;
      
      const unidad = med.unidad || 'mcg/kg/h';
      document.getElementById('dosisLabel').innerHTML = `Dosis <small class="range-indicator">(${unidad})</small>`;
      
      document.getElementById('dosis').value = '';
      document.getElementById('peso').value = '';
      document.getElementById('statusPeso').textContent = '';
      document.getElementById('statusDosis').textContent = '';
      document.getElementById('dosisCalculada').innerHTML = '';
      document.getElementById('dosisInfusion').innerHTML = '';
      document.getElementById('ordenMedica').style.display = 'none';
    }

    function loadPresentation() {
      const medSelect = document.getElementById('medicationSelect');
      const presSelect = document.getElementById('presentationSelect');
      const medIndex = parseInt(medSelect.value);
      const presIndex = parseInt(presSelect.value);
      
      if (isNaN(medIndex) || isNaN(presIndex)) {
        document.getElementById('medicationInfo').style.display = 'none';
        return;
      }
      
      const med = infusionMedications[medIndex];
      if (!med || !med.presentations || !med.presentations[presIndex]) {
        document.getElementById('medicationInfo').style.display = 'none';
        return;
      }
      
      const pres = med.presentations[presIndex];
      
      document.getElementById('medicationInfo').style.display = 'block';
      document.getElementById('presentacion').innerHTML = `<strong>${pres.descripcion}</strong>`;
      
      const dilucionOptions = document.getElementById('dilucionOptions');
      dilucionOptions.innerHTML = '';
      if (pres.diluciones && Array.isArray(pres.diluciones)) {
        pres.diluciones.forEach((dil, i) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn sm secondary';
          btn.textContent = dil;
          btn.setAttribute('data-dilution-index', i);
          btn.onclick = function() {
            document.querySelectorAll('#dilucionOptions .btn').forEach(b => {
              b.classList.remove('primary');
              b.classList.add('secondary');
              b.removeAttribute('data-selected');
            });
            this.classList.remove('secondary');
            this.classList.add('primary');
            this.setAttribute('data-selected', 'true');
            calculateInfusion();
          };
          dilucionOptions.appendChild(btn);
        });
      }
      
      document.getElementById('dosis').value = '';
      document.getElementById('peso').value = '';
      document.getElementById('dosisCalculada').innerHTML = '';
      document.getElementById('dosisInfusion').innerHTML = '';
      document.getElementById('ordenMedica').style.display = 'none';
    }

    function calculateInfusion() {
      const select = document.getElementById('medicationSelect');
      const presSelect = document.getElementById('presentationSelect');
      const medIndex = parseInt(select.value);
      const presIndex = parseInt(presSelect.value);
      
      if (isNaN(medIndex) || isNaN(presIndex)) return;
      
      const med = infusionMedications[medIndex];
      if (!med || !med.presentations || !med.presentations[presIndex]) return;
      
      const pres = med.presentations[presIndex];
      const dosis = parseFloat(document.getElementById('dosis').value);
      const peso = parseFloat(document.getElementById('peso').value);
      
      if (isNaN(dosis) || isNaN(peso)) {
        document.getElementById('dosisCalculada').innerHTML = '';
        document.getElementById('dosisInfusion').innerHTML = '';
        document.getElementById('ordenMedica').style.display = 'none';
        return;
      }
      
      const unidadDosis = med.unidad || 'mcg/kg/h';
      const esPorMinuto = unidadDosis.includes('/min');
      const esMcg = unidadDosis.includes('mcg');
      const esUI = unidadDosis.includes('UI');
      
      const selectedButton = document.querySelector('#dilucionOptions .btn[data-selected="true"]');
      if (!selectedButton) {
        return;
      }
      
      const selectedDilutionIndex = parseInt(selectedButton.getAttribute('data-dilution-index') || '-1');
      
      let concentracionMedicamento;
      if (pres.concentraciones && Array.isArray(pres.concentraciones) && selectedDilutionIndex >= 0 && pres.concentraciones[selectedDilutionIndex] !== undefined) {
        concentracionMedicamento = pres.concentraciones[selectedDilutionIndex];
      } else if (pres.concentracion !== undefined && pres.concentracion !== null) {
        concentracionMedicamento = pres.concentracion;
      } else {
        const match = pres.descripcion.match(/([\d.]+)\s*(MCG|MG|UI)\/\s*(\d*)\s*ML/i);
        if (match) {
          concentracionMedicamento = parseFloat(match[1]);
        } else {
          console.warn('No se pudo determinar la concentraci√≥n de la presentaci√≥n');
          document.getElementById('dosisInfusion').innerHTML = '<p style="color:#ef4444;">Error: No se pudo determinar la concentraci√≥n</p>';
          return;
        }
      }
      
      // Determinar unidad basada en descripci√≥n
      let unidadConcentracion = 'MCG';
      if (pres.descripcion.includes('MG/')) unidadConcentracion = 'MG';
      else if (pres.descripcion.includes('UI/')) unidadConcentracion = 'UI';
      
      let dosisPorHora = dosis * peso;
      if (esPorMinuto) {
        dosisPorHora = dosisPorHora * 60;
      }
      let dosisPorDia = dosisPorHora * 24;
      
      let concentracionEnUnidadDosis;
      if (esUI && unidadConcentracion === 'UI') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (esMcg && unidadConcentracion === 'MCG') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (esMcg && unidadConcentracion === 'MG') {
        concentracionEnUnidadDosis = concentracionMedicamento * 1000;
      } else if (!esMcg && !esUI && unidadConcentracion === 'MG') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (!esMcg && !esUI && unidadConcentracion === 'MCG') {
        concentracionEnUnidadDosis = concentracionMedicamento / 1000;
      } else {
        concentracionEnUnidadDosis = concentracionMedicamento;
      }
      
      let unidadMostrar = esUI ? 'UI' : (esMcg ? 'MCG' : 'MG');
      let unidadHora = esUI ? 'UI/hora' : (esMcg ? 'mcg/hora' : 'mg/hora');
      
      document.getElementById('dosisCalculada').innerHTML = `
        <p><strong>${unidadMostrar}/DIA:</strong> ${dosisPorDia.toFixed(1)} ${unidadMostrar}</p>
        <p><strong>Dosis:</strong> ${dosisPorHora.toFixed(2)} ${unidadHora}</p>
      `;
      
      const dilucionText = selectedButton.textContent;
      const dilucionTotal = parseFloat(dilucionText.replace(/[^0-9.]/g, ''));
      
      const concentracionPorMl = concentracionEnUnidadDosis;
      
      const ccMedicamento = dosisPorDia / concentracionPorMl;
      const ccDiluyente = Math.max(0, dilucionTotal - ccMedicamento);
      
      const concentracionFinal = dosisPorDia / dilucionTotal;
      let razonCcHora = dosisPorHora / concentracionFinal;
      
      document.getElementById('dosisInfusion').innerHTML = `
        <p><strong>CC de ${med.nombre}:</strong> ${ccMedicamento.toFixed(1)} CC</p>
        <p><strong>CC de diluyente (SS 0.9%):</strong> ${ccDiluyente.toFixed(1)} CC</p>
        <p style="font-size:13px;color:var(--muted);margin-top:8px;">Concentraci√≥n final: ${concentracionFinal.toFixed(2)} ${unidadMostrar}/CC</p>
      `;
      
      window.razonSeleccionada = razonCcHora;
      
      const ordenMedica = document.getElementById('ordenMedica');
      ordenMedica.classList.add('updating');
      setTimeout(() => ordenMedica.classList.remove('updating'), 500);
      
      document.getElementById('ordenMedicaContent').innerHTML = `
        <p><strong>ORDEN M√âDICA:</strong></p>
        <p id="ordenTexto">${med.nombre.toUpperCase()} ${ccMedicamento.toFixed(1)}CC + ${ccDiluyente.toFixed(1)}CC DE SS 0.9% PASAR A RAZ√ìN DE ${razonCcHora.toFixed(1)}CC/HORA</p>
      `;
      ordenMedica.style.display = 'block';
    }

    function clearInfusion() {
      document.getElementById('medicationSelect').value = '';
      document.getElementById('dosis').value = '';
      document.getElementById('peso').value = '';
      document.getElementById('medicationInfo').style.display = 'none';
      document.getElementById('ordenMedica').style.display = 'none';
    }


    function copyInfusionOrder() {
      const ordenContent = document.getElementById('ordenMedicaContent');
      
      if (!ordenContent || ordenContent.innerHTML === '') {
        alert('Por favor calcula primero la infusi√≥n');
        return;
      }
      
      const ordenText = ordenContent.querySelector('p:last-child').textContent;
      
      navigator.clipboard.writeText(ordenText).then(() => {
        alert('Orden m√©dica copiada al portapapeles');
      }).catch(() => {
        alert('No se pudo copiar al portapapeles');
      });
    }

    function validateInfusionInput(field, value) {
      const statusEl = document.getElementById(`status${field}`);
      if (!statusEl) return;
      
      if (value === '' || isNaN(value)) {
        statusEl.textContent = '';
        statusEl.style.color = '';
        return;
      }
      
      const numValue = parseFloat(value);
      
      if (field === 'Peso') {
        if (numValue <= 0) {
          statusEl.textContent = '‚ö†Ô∏è Debe ser mayor a 0';
          statusEl.style.color = '#ef4444';
        } else if (numValue < 0.5) {
          statusEl.textContent = '‚ö†Ô∏è Peso muy bajo';
          statusEl.style.color = '#f59e0b';
        } else if (numValue > 150) {
          statusEl.textContent = '‚ö†Ô∏è Peso muy alto';
          statusEl.style.color = '#f59e0b';
        } else {
          statusEl.textContent = '‚úì OK';
          statusEl.style.color = '#10b981';
        }
      } else if (field === 'Dosis') {
        if (numValue <= 0) {
          statusEl.textContent = '‚ö†Ô∏è Debe ser mayor a 0';
          statusEl.style.color = '#ef4444';
        } else if (numValue > 100) {
          statusEl.textContent = '‚ö†Ô∏è Dosis muy alta';
          statusEl.style.color = '#f59e0b';
        } else {
          statusEl.textContent = '‚úì OK';
          statusEl.style.color = '#10b981';
        }
      }
    }

    document.getElementById('peso')?.addEventListener('input', (e) => {
      validateInfusionInput('Peso', e.target.value);
      validateDoseRange();
      calculateInfusion();
    });
    
    document.getElementById('dosis')?.addEventListener('input', (e) => {
      validateInfusionInput('Dosis', e.target.value);
      validateDoseRange();
      calculateInfusion();
    });

    const PEDIATRIC_DOSE_RANGES = {
      'FENTANILO': { min: 1, max: 5, unit: 'mcg/kg/h', category: 'Sedoanalgesia' },
      'MIDAZOLAM': { min: 0.05, max: 0.2, unit: 'mg/kg/h', category: 'Sedoanalgesia' },
      'MORFINA': { min: 0.01, max: 0.04, unit: 'mg/kg/h', category: 'Sedoanalgesia' },
      'DOPAMINA': { min: 5, max: 20, unit: 'mcg/kg/min', category: 'Vasopresor' },
      'DOBUTAMINA': { min: 5, max: 20, unit: 'mcg/kg/min', category: 'Inotropico' },
      'ADRENALINA': { min: 0.05, max: 0.3, unit: 'mcg/kg/min', category: 'Vasopresor' },
      'NOREPINEFRINA': { min: 0.05, max: 0.5, unit: 'mcg/kg/min', category: 'Vasopresor' },
      'MILRINONE': { min: 0.25, max: 0.75, unit: 'mcg/kg/min', category: 'Inotropico' },
      'VASOPRESINA': { min: 0.0003, max: 0.002, unit: 'UI/kg/min', category: 'Vasopresor' },
      'KETAMINA': { min: 0.5, max: 2, unit: 'mg/kg/h', category: 'Sedoanalgesia' },
      'PROPOFOL': { min: 1, max: 4, unit: 'mg/kg/h', category: 'Sedoanalgesia' },
      'DEXMEDETOMIDINA': { min: 0.2, max: 0.7, unit: 'mcg/kg/h', category: 'Sedoanalgesia' }
    };

    const DRUG_INCOMPATIBILITIES = [
      { drugs: ['DOPAMINA', 'BICARBONATO'], severity: 'high', message: 'Incompatibles: precipita' },
      { drugs: ['ADRENALINA', 'BICARBONATO'], severity: 'high', message: 'Incompatibles: inactiva' },
      { drugs: ['NOREPINEFRINA', 'BICARBONATO'], severity: 'high', message: 'Incompatibles: inactiva' },
      { drugs: ['FENITOINA', 'DEXTROSA'], severity: 'high', message: 'Incompatibles: precipita' },
      { drugs: ['MIDAZOLAM', 'FUROSEMIDA'], severity: 'medium', message: 'Evitar mezcla directa' },
      { drugs: ['DOPAMINA', 'FUROSEMIDA'], severity: 'medium', message: 'Evitar mezcla directa' }
    ];

    const DRUG_COMPATIBILITIES = [
      { drugs: ['FENTANILO', 'MIDAZOLAM'], compatible: true, message: 'Compatibles para sedoanalgesia' },
      { drugs: ['DOPAMINA', 'DOBUTAMINA'], compatible: true, message: 'Compatibles' },
      { drugs: ['ADRENALINA', 'NOREPINEFRINA'], compatible: true, message: 'Compatibles' },
      { drugs: ['FENTANILO', 'KETAMINA'], compatible: true, message: 'Compatibles para analgesia' }
    ];

    let multiMedList = [];
    let calculationHistory = [];

    function initCalculatorEnhancements() {
      loadCalculationHistory();
      renderCalculationHistory();
    }

    function setQuickWeight(weight) {
      document.getElementById('peso').value = weight;
      document.querySelectorAll('.quick-weight-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === weight + 'kg') {
          btn.classList.add('active');
        }
      });
      validateInfusionInput('Peso', weight);
      validateDoseRange();
      calculateInfusion();
    }

    function showDoseRangeForMedication(medName) {
      const rangeInfo = document.getElementById('doseRangeInfo');
      const rangeText = document.getElementById('doseRangeText');
      
      if (!rangeInfo || !rangeText) return;
      
      const range = PEDIATRIC_DOSE_RANGES[medName.toUpperCase()];
      if (range) {
        rangeText.innerHTML = `<strong>${range.min} - ${range.max} ${range.unit}</strong> (${range.category})`;
        rangeInfo.style.display = 'block';
      } else {
        rangeInfo.style.display = 'none';
      }
    }

    function validateDoseRange() {
      const select = document.getElementById('medicationSelect');
      const medIndex = parseInt(select.value);
      const alertEl = document.getElementById('doseValidationAlert');
      const dosisEl = document.getElementById('statusDosis');
      
      if (isNaN(medIndex) || !infusionMedications[medIndex] || !alertEl) return;
      
      const med = infusionMedications[medIndex];
      const dosis = parseFloat(document.getElementById('dosis').value);
      
      if (isNaN(dosis)) {
        alertEl.style.display = 'none';
        return;
      }
      
      const range = PEDIATRIC_DOSE_RANGES[med.nombre.toUpperCase()];
      if (!range) {
        alertEl.style.display = 'none';
        return;
      }
      
      let status = 'normal';
      let message = '';
      let bgColor = '';
      let textColor = '';
      
      if (dosis < range.min) {
        status = 'low';
        message = `‚ö†Ô∏è DOSIS BAJA: ${dosis} ${range.unit} est√° por debajo del rango m√≠nimo (${range.min} ${range.unit})`;
        bgColor = 'rgba(59, 130, 246, 0.15)';
        textColor = '#3b82f6';
        if (dosisEl) {
          dosisEl.innerHTML = '<span class="dose-indicator dose-low">‚Üì Baja</span>';
        }
      } else if (dosis > range.max) {
        status = 'high';
        message = `üö® DOSIS ALTA: ${dosis} ${range.unit} supera el rango m√°ximo (${range.max} ${range.unit})`;
        bgColor = 'rgba(239, 68, 68, 0.15)';
        textColor = '#ef4444';
        if (dosisEl) {
          dosisEl.innerHTML = '<span class="dose-indicator dose-danger">‚Üë Alta</span>';
        }
      } else {
        status = 'normal';
        message = `‚úì Dosis dentro del rango pedi√°trico (${range.min}-${range.max} ${range.unit})`;
        bgColor = 'rgba(16, 185, 129, 0.15)';
        textColor = '#10b981';
        if (dosisEl) {
          dosisEl.innerHTML = '<span class="dose-indicator dose-normal">‚úì Normal</span>';
        }
      }
      
      alertEl.style.display = 'block';
      alertEl.style.background = bgColor;
      alertEl.style.color = textColor;
      alertEl.style.borderLeft = `4px solid ${textColor}`;
      alertEl.innerHTML = message;
    }

    function showCalculationSteps(med, pres, peso, dosis, ccMedicamento, ccDiluyente, dilucionTotal, concentracionFinal, razonCcHora, concentracion, unidadMostrar, esMcg, esUI) {
      const stepsEl = document.getElementById('calculationSteps');
      const contentEl = document.getElementById('calculationStepsContent');
      
      if (!stepsEl || !contentEl) return;
      
      const unidadDosis = med.unidad || 'mcg/kg/h';
      const esPorMinuto = unidadDosis.includes('/min');
      
      let dosisPorHora = dosis * peso;
      if (esPorMinuto) dosisPorHora = dosisPorHora * 60;
      let dosisPorDia = dosisPorHora * 24;
      
      let unidadSimple = esUI ? 'UI' : (esMcg ? 'mcg' : 'mg');
      let unidadConcentracionDisplay = esUI ? 'UI/mL' : (esMcg ? 'mcg/mL' : 'mg/mL');
      
      // Informaci√≥n de presentaci√≥n seleccionada
      const presInfo = pres?.descripcion ? `<br><small style="color:var(--muted);">Presentaci√≥n: ${pres.descripcion}</small>` : '';
      const dilucionInfo = dilucionTotal ? `<br><small style="color:var(--muted);">Diluci√≥n: ${dilucionTotal}CC</small>` : '';
      
      contentEl.innerHTML = `
        <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px;border-left:4px solid var(--primary);">
          <strong>MEDICAMENTO:</strong> ${med.nombre} ${presInfo}
          <br><strong>PACIENTE:</strong> ${peso} kg | <strong>DOSIS:</strong> ${dosis} ${unidadDosis}
        </div>
        
        <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px;">
          <strong>1. Dosis por hora:</strong><br>
          <small style="color:var(--muted);">F√≥rmula:</small> ${dosis} ${unidadDosis} √ó ${peso} kg = <strong>${dosisPorHora.toFixed(2)} ${unidadSimple}/hora</strong>
          ${esPorMinuto ? `<br><small style="color:var(--muted);">(convertido de /min a /hora: √ó 60)</small>` : ''}
        </div>
        
        <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px;">
          <strong>2. Dosis por d√≠a:</strong><br>
          <small style="color:var(--muted);">F√≥rmula:</small> ${dosisPorHora.toFixed(2)} ${unidadSimple}/hora √ó 24 horas = <strong>${dosisPorDia.toFixed(1)} ${unidadSimple}/d√≠a</strong>
        </div>
        
        <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px;">
          <strong>3. Concentraci√≥n de presentaci√≥n:</strong><br>
          <small style="color:var(--muted);">Valor:</small> <strong>${concentracion.toFixed(1)} ${unidadConcentracionDisplay}</strong>
        </div>
        
        <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px;">
          <strong>4. CC de medicamento a usar:</strong><br>
          <small style="color:var(--muted);">F√≥rmula:</small> ${dosisPorDia.toFixed(1)} ${unidadSimple} √∑ ${concentracion.toFixed(1)} ${unidadConcentracionDisplay} = <strong>${ccMedicamento.toFixed(1)} CC</strong>
        </div>
        
        <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px;">
          <strong>5. CC de diluyente (SS 0.9%): </strong><br>
          <small style="color:var(--muted);">F√≥rmula:</small> ${dilucionTotal} CC - ${ccMedicamento.toFixed(1)} CC = <strong>${ccDiluyente.toFixed(1)} CC</strong> ${dilucionInfo}
        </div>
        
        <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px;">
          <strong>6. Concentraci√≥n final en mezcla:</strong><br>
          <small style="color:var(--muted);">F√≥rmula:</small> ${dosisPorDia.toFixed(1)} ${unidadSimple} √∑ ${dilucionTotal} CC = <strong>${concentracionFinal.toFixed(3)} ${unidadSimple}/CC</strong>
        </div>
        
        <div style="background:rgba(var(--primary-rgb),0.1);padding:12px;border-radius:8px;border-left:4px solid var(--primary);">
          <strong>7. Velocidad de infusi√≥n (CC/HORA):</strong><br>
          <small style="color:var(--muted);">F√≥rmula:</small> ${dosisPorHora.toFixed(2)} ${unidadSimple}/hora √∑ ${concentracionFinal.toFixed(3)} ${unidadSimple}/CC = <strong style="font-size:16px;color:var(--primary);">${razonCcHora.toFixed(1)} CC/hora</strong>
        </div>
      `;
      
      stepsEl.style.display = 'block';
    }

    function loadCalculationHistory() {
      try {
        const saved = localStorage.getItem('infusion_calc_history');
        calculationHistory = saved ? JSON.parse(saved) : [];
      } catch (e) {
        calculationHistory = [];
      }
    }

    function saveCalculationHistory() {
      try {
        calculationHistory = calculationHistory.slice(0, 5);
        localStorage.setItem('infusion_calc_history', JSON.stringify(calculationHistory));
      } catch (e) {
        console.error('Error saving history:', e);
      }
    }

    function saveCalculationToHistory() {
      const ordenContent = document.getElementById('ordenMedicaContent');
      if (!ordenContent || ordenContent.innerHTML === '') {
        alert('Primero realiza un c√°lculo');
        return;
      }
      
      const select = document.getElementById('medicationSelect');
      const medIndex = parseInt(select.value);
      if (isNaN(medIndex) || !infusionMedications[medIndex]) return;
      
      const med = infusionMedications[medIndex];
      const peso = parseFloat(document.getElementById('peso').value);
      const dosis = parseFloat(document.getElementById('dosis').value);
      const ordenText = ordenContent.querySelector('p:last-child')?.textContent || '';
      
      const entry = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('es-CO'),
        medication: med.nombre,
        peso: peso,
        dosis: dosis,
        unidad: med.unidad,
        orden: ordenText
      };
      
      calculationHistory.unshift(entry);
      calculationHistory = calculationHistory.slice(0, 5);
      saveCalculationHistory();
      renderCalculationHistory();
      
      if (typeof showToast === 'function') {
        showToast('C√°lculo guardado en historial', 'success');
      } else {
        alert('C√°lculo guardado en historial');
      }
    }

    function renderCalculationHistory() {
      const container = document.getElementById('calculationHistory');
      if (!container) return;
      
      if (calculationHistory.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:13px;text-align:center;margin:0;">Sin c√°lculos recientes</p>';
        return;
      }
      
      container.innerHTML = calculationHistory.map(entry => `
        <div class="history-item" onclick="loadHistoryEntry(${entry.id})" title="Clic para cargar">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <strong style="color:var(--primary);">${entry.medication}</strong>
            <small style="color:var(--muted);">${entry.timestamp}</small>
          </div>
          <div style="color:var(--text);">
            ${entry.peso}kg @ ${entry.dosis} ${entry.unidad}
          </div>
        </div>
      `).join('');
    }

    function loadHistoryEntry(id) {
      const entry = calculationHistory.find(e => e.id === id);
      if (!entry) return;
      
      const medIndex = infusionMedications.findIndex(m => m.nombre === entry.medication);
      if (medIndex >= 0) {
        document.getElementById('medicationSelect').value = medIndex;
        loadMedication();
        
        setTimeout(() => {
          document.getElementById('peso').value = entry.peso;
          document.getElementById('dosis').value = entry.dosis;
          validateInfusionInput('Peso', entry.peso);
          validateInfusionInput('Dosis', entry.dosis);
          validateDoseRange();
          
          const firstDilBtn = document.querySelector('#dilucionOptions .btn');
          if (firstDilBtn) {
            firstDilBtn.click();
          }
        }, 100);
      }
    }

    function clearCalculationHistory() {
      if (confirm('¬øLimpiar todo el historial de c√°lculos?')) {
        calculationHistory = [];
        localStorage.removeItem('infusion_calc_history');
        renderCalculationHistory();
      }
    }

    function toggleMultiMed() {
      const section = document.getElementById('multiMedSection');
      const btn = document.getElementById('btnMultiMed');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.classList.remove('secondary');
        btn.classList.add('primary');
      } else {
        section.style.display = 'none';
        btn.classList.remove('primary');
        btn.classList.add('secondary');
      }
    }

    function addToMultiMed() {
      const ordenContent = document.getElementById('ordenMedicaContent');
      if (!ordenContent || ordenContent.innerHTML === '') {
        alert('Primero realiza un c√°lculo');
        return;
      }
      
      const select = document.getElementById('medicationSelect');
      const medIndex = parseInt(select.value);
      if (isNaN(medIndex) || !infusionMedications[medIndex]) return;
      
      const med = infusionMedications[medIndex];
      const peso = parseFloat(document.getElementById('peso').value);
      const dosis = parseFloat(document.getElementById('dosis').value);
      const ordenText = ordenContent.querySelector('p:last-child')?.textContent || '';
      
      if (multiMedList.some(m => m.medication === med.nombre)) {
        alert('Este medicamento ya est√° en la lista');
        return;
      }
      
      multiMedList.push({
        id: Date.now(),
        medication: med.nombre,
        peso: peso,
        dosis: dosis,
        unidad: med.unidad,
        orden: ordenText
      });
      
      renderMultiMedList();
      document.getElementById('multiMedSection').style.display = 'block';
      document.getElementById('btnMultiMed').classList.remove('secondary');
      document.getElementById('btnMultiMed').classList.add('primary');
      
      if (typeof showToast === 'function') {
        showToast(`${med.nombre} agregado a multi-medicamento`, 'success');
      }
    }

    function renderMultiMedList() {
      const container = document.getElementById('multiMedList');
      if (!container) return;
      
      if (multiMedList.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:13px;text-align:center;">No hay medicamentos agregados</p>';
        return;
      }
      
      container.innerHTML = multiMedList.map(entry => `
        <div class="multi-med-item">
          <div>
            <strong style="color:var(--primary);">${entry.medication}</strong>
            <div style="font-size:12px;color:var(--muted);">${entry.dosis} ${entry.unidad} @ ${entry.peso}kg</div>
          </div>
          <button class="btn sm danger" onclick="removeFromMultiMed(${entry.id})" style="font-size:11px;padding:4px 8px;">‚úï</button>
        </div>
      `).join('');
    }

    function removeFromMultiMed(id) {
      multiMedList = multiMedList.filter(m => m.id !== id);
      renderMultiMedList();
      document.getElementById('multiMedCompatibility').style.display = 'none';
    }

    function clearMultiMed() {
      multiMedList = [];
      renderMultiMedList();
      document.getElementById('multiMedCompatibility').style.display = 'none';
    }

    function copyAllMultiMedOrders() {
      if (multiMedList.length === 0) {
        alert('No hay medicamentos en la lista');
        return;
      }
      
      const orders = multiMedList.map(m => m.orden).join('\n');
      navigator.clipboard.writeText(orders).then(() => {
        if (typeof showToast === 'function') {
          showToast('Todas las √≥rdenes copiadas', 'success');
        } else {
          alert('√ìrdenes copiadas al portapapeles');
        }
      }).catch(() => {
        alert('Error al copiar');
      });
    }

    function checkMultiMedCompatibility() {
      const container = document.getElementById('multiMedCompatibility');
      if (!container || multiMedList.length < 2) {
        if (container) {
          container.innerHTML = '<p class="compatibility-ok">Agrega al menos 2 medicamentos para verificar compatibilidad</p>';
          container.style.display = 'block';
        }
        return;
      }
      
      const medications = multiMedList.map(m => m.medication.toUpperCase());
      let warnings = [];
      let compatibilities = [];
      
      for (let i = 0; i < medications.length; i++) {
        for (let j = i + 1; j < medications.length; j++) {
          const pair = [medications[i], medications[j]];
          
          const incompatible = DRUG_INCOMPATIBILITIES.find(inc => 
            inc.drugs.every(d => pair.includes(d.toUpperCase()))
          );
          
          if (incompatible) {
            warnings.push({
              drugs: pair,
              message: incompatible.message,
              severity: incompatible.severity
            });
          }
          
          const compatible = DRUG_COMPATIBILITIES.find(comp => 
            comp.drugs.every(d => pair.includes(d.toUpperCase()))
          );
          
          if (compatible) {
            compatibilities.push({
              drugs: pair,
              message: compatible.message
            });
          }
        }
      }
      
      let html = '';
      
      if (warnings.length > 0) {
        html += '<div class="compatibility-warning" style="margin-bottom:8px;">';
        html += '<strong>üö® ALERTAS DE INCOMPATIBILIDAD:</strong><br>';
        warnings.forEach(w => {
          html += `‚Ä¢ ${w.drugs.join(' + ')}: ${w.message}<br>`;
        });
        html += '</div>';
      }
      
      if (compatibilities.length > 0) {
        html += '<div class="compatibility-ok">';
        html += '<strong>‚úì Compatibilidades confirmadas:</strong><br>';
        compatibilities.forEach(c => {
          html += `‚Ä¢ ${c.drugs.join(' + ')}: ${c.message}<br>`;
        });
        html += '</div>';
      }
      
      if (warnings.length === 0 && compatibilities.length === 0) {
        html = '<div class="compatibility-ok">No se encontraron interacciones conocidas entre estos medicamentos. Verificar siempre con fuentes actualizadas.</div>';
      }
      
      container.innerHTML = html;
      container.style.display = 'block';
    }

    function convertUnits() {
      const value = parseFloat(document.getElementById('unitConvertValue').value);
      const fromUnit = document.getElementById('unitFrom').value;
      const toUnit = document.getElementById('unitTo').value;
      const resultEl = document.getElementById('unitConvertResult');
      
      if (isNaN(value) || !resultEl) {
        if (resultEl) resultEl.value = '';
        return;
      }
      
      const conversions = {
        'mcg_mg': 0.001,
        'mcg_g': 0.000001,
        'mg_mcg': 1000,
        'mg_g': 0.001,
        'g_mcg': 1000000,
        'g_mg': 1000,
        'UI_UI': 1,
        'mcg_mcg': 1,
        'mg_mg': 1,
        'g_g': 1
      };
      
      const key = `${fromUnit}_${toUnit}`;
      const factor = conversions[key];
      
      if (factor !== undefined) {
        const result = value * factor;
        resultEl.value = `${result.toFixed(6).replace(/\.?0+$/, '')} ${toUnit}`;
      } else if (fromUnit === 'UI' || toUnit === 'UI') {
        resultEl.value = 'UI no se puede convertir directamente';
      } else {
        resultEl.value = 'Conversi√≥n no disponible';
      }
    }

    function swapUnits() {
      const fromEl = document.getElementById('unitFrom');
      const toEl = document.getElementById('unitTo');
      const temp = fromEl.value;
      fromEl.value = toEl.value;
      toEl.value = temp;
      convertUnits();
    }

    async function saveCalculationToDatabase() {
      const ordenContent = document.getElementById('ordenMedicaContent');
      if (!ordenContent || ordenContent.innerHTML === '') {
        alert('Primero realiza un c√°lculo');
        return;
      }
      
      const select = document.getElementById('medicationSelect');
      const medIndex = parseInt(select.value);
      if (isNaN(medIndex) || !infusionMedications[medIndex]) return;
      
      const med = infusionMedications[medIndex];
      const peso = parseFloat(document.getElementById('peso').value);
      const dosis = parseFloat(document.getElementById('dosis').value);
      const ordenText = ordenContent.querySelector('p:last-child')?.textContent || '';
      
      const patientId = prompt('Ingrese ID o nombre del paciente para auditor√≠a:');
      if (!patientId) return;
      
      try {
        const response = await fetch('/api/medications/calculations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patient_id: patientId,
            medication: med.nombre,
            peso: peso,
            dosis: dosis,
            unidad: med.unidad,
            orden: ordenText,
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          if (typeof showToast === 'function') {
            showToast('C√°lculo guardado en base de datos', 'success');
          } else {
            alert('C√°lculo guardado exitosamente');
          }
        } else {
          throw new Error('Error al guardar');
        }
      } catch (e) {
        console.error('Error saving to DB:', e);
        alert('Error al guardar en base de datos. El c√°lculo se guard√≥ localmente.');
        saveCalculationToHistory();
      }
    }

    if (document.getElementById('infusionesTool')) {
      initCalculatorEnhancements();
    }

    const origLoadMedication = loadMedication;
    loadMedication = function() {
      origLoadMedication();
      const select = document.getElementById('medicationSelect');
      const medIndex = parseInt(select.value);
      if (!isNaN(medIndex) && infusionMedications[medIndex]) {
        showDoseRangeForMedication(infusionMedications[medIndex].nombre);
      }
      document.getElementById('calculationSteps').style.display = 'none';
      document.getElementById('doseValidationAlert').style.display = 'none';
    };

    const origCalculateInfusion = calculateInfusion;
    calculateInfusion = function() {
      const select = document.getElementById('medicationSelect');
      const presSelect = document.getElementById('presentationSelect');
      const medIndex = parseInt(select.value);
      const presIndex = parseInt(presSelect.value);
      
      if (isNaN(medIndex) || isNaN(presIndex)) return;
      
      const med = infusionMedications[medIndex];
      if (!med || !med.presentations || !med.presentations[presIndex]) return;
      
      const pres = med.presentations[presIndex];
      const dosis = parseFloat(document.getElementById('dosis').value);
      const peso = parseFloat(document.getElementById('peso').value);
      
      if (isNaN(dosis) || isNaN(peso)) {
        document.getElementById('dosisCalculada').innerHTML = '';
        document.getElementById('dosisInfusion').innerHTML = '';
        document.getElementById('ordenMedica').style.display = 'none';
        document.getElementById('calculationSteps').style.display = 'none';
        return;
      }
      
      const unidadDosis = med.unidad || 'mcg/kg/h';
      const esPorMinuto = unidadDosis.includes('/min');
      const esMcg = unidadDosis.includes('mcg');
      const esUI = unidadDosis.includes('UI');
      
      const selectedButton = document.querySelector('#dilucionOptions .btn[data-selected="true"]');
      if (!selectedButton) {
        return;
      }
      
      const selectedDilutionIndex = parseInt(selectedButton.getAttribute('data-dilution-index') || '-1');
      
      let concentracionMedicamento;
      if (pres.concentraciones && Array.isArray(pres.concentraciones) && selectedDilutionIndex >= 0 && pres.concentraciones[selectedDilutionIndex] !== undefined) {
        concentracionMedicamento = pres.concentraciones[selectedDilutionIndex];
      } else if (pres.concentracion !== undefined && pres.concentracion !== null) {
        concentracionMedicamento = pres.concentracion;
      } else {
        const match = pres.descripcion.match(/([\d.]+)\s*(MCG|MG|UI)\/\s*(\d*)\s*ML/i);
        if (match) {
          concentracionMedicamento = parseFloat(match[1]);
        } else {
          console.warn('No se pudo determinar la concentraci√≥n');
          document.getElementById('calculationSteps').style.display = 'none';
          return;
        }
      }
      
      let unidadConcentracion = 'MCG';
      if (pres.descripcion.includes('MG/')) unidadConcentracion = 'MG';
      else if (pres.descripcion.includes('UI/')) unidadConcentracion = 'UI';
      
      let dosisPorHora = dosis * peso;
      if (esPorMinuto) {
        dosisPorHora = dosisPorHora * 60;
      }
      let dosisPorDia = dosisPorHora * 24;
      
      let concentracionEnUnidadDosis;
      if (esUI && unidadConcentracion === 'UI') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (esMcg && unidadConcentracion === 'MCG') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (esMcg && unidadConcentracion === 'MG') {
        concentracionEnUnidadDosis = concentracionMedicamento * 1000;
      } else if (!esMcg && !esUI && unidadConcentracion === 'MG') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (!esMcg && !esUI && unidadConcentracion === 'MCG') {
        concentracionEnUnidadDosis = concentracionMedicamento / 1000;
      } else {
        concentracionEnUnidadDosis = concentracionMedicamento;
      }
      
      let unidadMostrar = esUI ? 'UI' : (esMcg ? 'MCG' : 'MG');
      let unidadHora = esUI ? 'UI/hora' : (esMcg ? 'mcg/hora' : 'mg/hora');
      
      document.getElementById('dosisCalculada').innerHTML = `
        <p><strong>${unidadMostrar}/DIA:</strong> ${dosisPorDia.toFixed(1)} ${unidadMostrar}</p>
        <p><strong>Dosis:</strong> ${dosisPorHora.toFixed(2)} ${unidadHora}</p>
      `;
      
      const dilucionText = selectedButton.textContent;
      const dilucionTotal = parseFloat(dilucionText.replace(/[^0-9.]/g, ''));
      
      const concentracionPorMl = concentracionEnUnidadDosis;
      
      const ccMedicamento = dosisPorDia / concentracionPorMl;
      const ccDiluyente = Math.max(0, dilucionTotal - ccMedicamento);
      
      const concentracionFinal = dosisPorDia / dilucionTotal;
      let razonCcHora = dosisPorHora / concentracionFinal;
      
      document.getElementById('dosisInfusion').innerHTML = `
        <p><strong>CC de ${med.nombre}:</strong> ${ccMedicamento.toFixed(1)} CC</p>
        <p><strong>CC de diluyente (SS 0.9%):</strong> ${ccDiluyente.toFixed(1)} CC</p>
        <p style="font-size:13px;color:var(--muted);margin-top:8px;">Concentraci√≥n final: ${concentracionFinal.toFixed(2)} ${unidadMostrar}/CC</p>
      `;
      
      window.razonSeleccionada = razonCcHora;
      
      const ordenMedica = document.getElementById('ordenMedica');
      ordenMedica.classList.add('updating');
      setTimeout(() => ordenMedica.classList.remove('updating'), 500);
      
      document.getElementById('ordenMedicaContent').innerHTML = `
        <p><strong>ORDEN M√âDICA:</strong></p>
        <p id="ordenTexto">${med.nombre.toUpperCase()} ${ccMedicamento.toFixed(1)}CC + ${ccDiluyente.toFixed(1)}CC DE SS 0.9% PASAR A RAZ√ìN DE ${razonCcHora.toFixed(1)}CC/HORA</p>
      `;
      ordenMedica.style.display = 'block';
      
      // Mostrar paso a paso del c√°lculo
      showCalculationSteps(med, pres, peso, dosis, ccMedicamento, ccDiluyente, dilucionTotal, concentracionFinal, razonCcHora, concentracionPorMl, unidadMostrar, esMcg, esUI);
      validateDoseRange();
    };

    async function guardarDocumento() {
      const nombre = document.getElementById('docName').value.trim();
      const categoria = document.getElementById('docCategory').value;
      const contenido = document.getElementById('docContent').value.trim();
      const isGlobal = document.getElementById('plantillaGlobal')?.checked || false;

      if (!nombre) {
        alert('Por favor, ingresa un nombre para la plantilla');
        return;
      }
      if (!categoria) {
        alert('Por favor, selecciona una categor√≠a');
        return;
      }
      if (!contenido) {
        alert('Por favor, ingresa el contenido de la plantilla');
        return;
      }

      const tamanio = new Blob([contenido]).size;
      if (tamanio > 10 * 1024 * 1024) {
        alert('La plantilla excede el tama√±o m√°ximo de 10MB');
        return;
      }

      try {
        const response = await fetch('/api/plantillas', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            nombre: nombre,
            categoria: categoria,
            contenido: contenido,
            global: isGlobal
          })
        });

        const data = await response.json();

        if (response.ok) {
          limpiarFormDoc();
          cargarDocumentos();
          alert('Plantilla guardada exitosamente');
        } else {
          alert('Error: ' + (data.error || 'No se pudo guardar la plantilla'));
        }
      } catch (err) {
        console.error('Error guardando plantilla:', err);
        alert('Error al guardar la plantilla');
      }
    }

    function limpiarFormDoc() {
      document.getElementById('docName').value = '';
      document.getElementById('docCategory').value = '';
      document.getElementById('docContent').value = '';
      if (document.getElementById('plantillaGlobal')) {
        document.getElementById('plantillaGlobal').checked = false;
      }
    }

    async function cargarDocumentos() {
      try {
        documentos = await api('/plantillas');
        mostrarDocumentos();
      } catch (err) {
        console.error('Error cargando plantillas:', err);
        documentos = [];
        mostrarDocumentos();
      }
    }

    function mostrarDocumentos(filtrados = null) {
      const lista = filtrados || documentos;
      const container = document.getElementById('docList');
      const counter = document.getElementById('plantillasCounter');
      
      if (counter) {
        counter.textContent = `Plantillas guardadas: ${lista.length}`;
      }
      
      if (lista.length === 0) {
        container.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
            <p style="margin: 0; font-size: 16px;">No hay plantillas guardadas</p>
          </div>
        `;
        return;
      }

      const getCategoryIcon = (cat) => {
        const icons = {
          'pediatria': 'üë∂',
          'adultos': 'üë®‚Äç‚öïÔ∏è',
          'geriatria': 'üë¥',
          'neonatologia': 'üëº',
          'infusiones': 'üíâ',
          'otras': 'üìã'
        };
        return icons[cat] || 'üìÑ';
      };

      container.innerHTML = lista.map((doc, index) => {
        const fecha = new Date(doc.fecha || doc.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        const tamanioKB = (doc.tamanio / 1024).toFixed(1);
        const esPropia = doc.creador === currentUser?.username;
        const esAdmin = currentUser?.role === 'admin';
        const puedeEditar = esPropia || esAdmin;
        const icon = getCategoryIcon(doc.categoria);
        
        const categoryColors = {
          'pediatria': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          'adultos': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
          'geriatria': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
          'neonatologia': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
          'infusiones': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
          'otras': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
        };
        
        const categoryGradient = categoryColors[doc.categoria] || categoryColors['otras'];
        
        return `
          <div class="doc-item plantilla-card" style="
            background: var(--card);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            animation: fadeIn 0.3s ease-in-out ${index * 0.05}s both;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          " onmouseenter="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 12px 28px rgba(0,139,139,0.2)'; this.style.borderColor='var(--primary)';" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'; this.style.borderColor='transparent';">
            <div style="height: 6px; background: ${categoryGradient};"></div>
            <div style="padding: 20px;">
              ${doc.global ? '<div style="position: absolute; top: 18px; right: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 14px; border-radius: 20px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">‚ú® PREDEFINIDA</div>' : ''}
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 14px;">
                <div style="font-size: 48px; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">${icon}</div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 700; font-size: 17px; color: var(--text); margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${doc.nombre}">${doc.nombre}</div>
                  <div style="display: inline-block; background: ${categoryGradient}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                    ${doc.categoria.charAt(0).toUpperCase() + doc.categoria.slice(1)}
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 12px; font-size: 12px; color: var(--muted); margin-bottom: 18px; flex-wrap: wrap;">
                <span style="display: flex; align-items: center; gap: 4px;">üì¶ <strong>${tamanioKB} KB</strong></span>
                <span>‚Ä¢</span>
                <span style="display: flex; align-items: center; gap: 4px;">üìÖ <strong>${fecha}</strong></span>
                ${!doc.global ? `<span>‚Ä¢</span><span style="display: flex; align-items: center; gap: 4px;">üë§ <strong>${doc.creador}</strong></span>` : ''}
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${puedeEditar ? `<button class="btn sm primary" onclick="event.stopPropagation(); editarDocumento(${doc.id})" style="flex: 1; min-width: 90px; font-weight: 600;">‚úèÔ∏è Editar</button>` : ''}
                <button class="btn sm success" onclick="event.stopPropagation(); descargarDocumento(${doc.id})" style="flex: 1; min-width: 90px; font-weight: 600;">‚¨áÔ∏è Descargar</button>
                ${puedeEditar ? `<button class="btn danger sm" onclick="event.stopPropagation(); eliminarDocumento(${doc.id})" style="min-width: 50px; font-weight: 600;">üóëÔ∏è</button>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    `;
    document.head.appendChild(style);

    function filtrarDocumentos() {
      const categoria = document.getElementById('filterCategory').value;
      const busqueda = document.getElementById('searchDoc').value.toLowerCase();
      
      let filtrados = documentos;
      
      if (categoria) {
        filtrados = filtrados.filter(doc => doc.categoria === categoria);
      }
      
      if (busqueda) {
        filtrados = filtrados.filter(doc => 
          doc.nombre.toLowerCase().includes(busqueda) ||
          doc.contenido.toLowerCase().includes(busqueda)
        );
      }
      
      mostrarDocumentos(filtrados);
    }

    function editarDocumento(id) {
      const doc = documentos.find(d => d.id === id);
      if (!doc) return;
      
      editandoDocId = id;
      document.getElementById('editDocName').value = doc.nombre;
      document.getElementById('editDocCategory').value = doc.categoria;
      document.getElementById('editDocContent').value = doc.contenido;
      
      if (currentUser?.role === 'admin' && doc.global) {
        document.getElementById('editPlantillaGlobal').checked = true;
      } else {
        document.getElementById('editPlantillaGlobal').checked = false;
      }
      
      document.getElementById('editModal').style.display = 'block';
    }

    function cerrarEditor() {
      editandoDocId = null;
      document.getElementById('editModal').style.display = 'none';
    }

    async function guardarEdicion() {
      if (!editandoDocId) return;
      
      const nombre = document.getElementById('editDocName').value.trim();
      const categoria = document.getElementById('editDocCategory').value;
      const contenido = document.getElementById('editDocContent').value.trim();
      const isGlobal = document.getElementById('editPlantillaGlobal')?.checked || false;
      
      if (!nombre || !categoria || !contenido) {
        alert('Por favor, completa todos los campos');
        return;
      }
      
      const tamanio = new Blob([contenido]).size;
      if (tamanio > 10 * 1024 * 1024) {
        alert('La plantilla excede el tama√±o m√°ximo de 10MB');
        return;
      }
      
      try {
        const response = await fetch(`/api/plantillas/${editandoDocId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            nombre: nombre,
            categoria: categoria,
            contenido: contenido,
            global: isGlobal
          })
        });

        const data = await response.json();

        if (response.ok) {
          cerrarEditor();
          cargarDocumentos();
          alert('Plantilla actualizada exitosamente');
        } else {
          alert('Error: ' + (data.error || 'No se pudo actualizar la plantilla'));
        }
      } catch (err) {
        console.error('Error actualizando plantilla:', err);
        alert('Error al actualizar la plantilla');
      }
    }

    function descargarDocumento(id) {
      const doc = documentos.find(d => d.id === id);
      if (!doc) return;
      
      const blob = new Blob([doc.contenido], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${doc.nombre}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function eliminarDocumento(id) {
      const doc = documentos.find(d => d.id === id);
      if (!doc) return;
      
      if (!confirm(`¬øEst√°s seguro de eliminar la plantilla "${doc.nombre}"?`)) return;
      
      try {
        const response = await fetch(`/api/plantillas/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          cargarDocumentos();
          alert('Plantilla eliminada');
        } else {
          alert('Error: ' + (data.error || 'No se pudo eliminar la plantilla'));
        }
      } catch (err) {
        console.error('Error eliminando plantilla:', err);
        alert('Error al eliminar la plantilla');
      }
    }

    let turnos = [];
    let calendarioMesActual = new Date().getMonth();
    let calendarioAnioActual = new Date().getFullYear();

    function guardarTurno() {
      const fecha = document.getElementById('turnoFecha').value;
      const horaInicio = document.getElementById('turnoHoraInicio').value;
      const horaFin = document.getElementById('turnoHoraFin').value;
      const valor = parseFloat(document.getElementById('turnoValor').value) || 0;
      const lugar = document.getElementById('turnoLugar').value.trim();
      const tipo = document.getElementById('turnoTipo').value;
      const paymentType = document.getElementById('turnoPaymentType').value;
      const notas = document.getElementById('turnoNotas').value.trim();

      if (!fecha || !horaInicio || !horaFin) {
        alert('Por favor completa fecha, hora de inicio y hora de fin');
        return;
      }

      const turno = {
        id: Date.now(),
        fecha,
        horaInicio,
        horaFin,
        valor,
        lugar,
        tipo,
        paymentType,
        notas,
        creador: currentUser?.username || 'unknown',
        isExchange: false
      };

      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      const turnosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      turnosExistentes.push(turno);
      localStorage.setItem(storageKey, JSON.stringify(turnosExistentes));

      cerrarFormTurno();
      cargarTurnos();
      alert('Turno guardado exitosamente');
    }

    function limpiarFormTurno() {
      document.getElementById('turnoFecha').value = '';
      document.getElementById('turnoHoraInicio').value = '';
      document.getElementById('turnoHoraFin').value = '';
      document.getElementById('turnoValor').value = '';
      document.getElementById('turnoLugar').value = '';
      document.getElementById('turnoTipo').value = 'guardia';
      document.getElementById('turnoPaymentType').value = 'ops';
      document.getElementById('turnoNotas').value = '';
    }

    function cerrarFormTurno() {
      document.getElementById('formTurnoContainer').style.display = 'none';
      limpiarFormTurno();
    }

    function abrirFormTurno(fecha = null) {
      if (fecha) {
        document.getElementById('turnoFecha').value = fecha;
        
        const turnosDia = turnos.filter(t => t.fecha === fecha);
        const turnosDiaActual = document.getElementById('turnosDiaActual');
        const listaTurnosDia = document.getElementById('listaTurnosDia');
        
        if (turnosDia.length > 0) {
          turnosDiaActual.style.display = 'block';
          const fechaObj = new Date(fecha);
          const opciones = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
          const fechaFormateada = fechaObj.toLocaleDateString('es-ES', opciones);
          document.getElementById('tituloFormTurno').textContent = `Agregar turno - ${fechaFormateada}`;
          
          listaTurnosDia.innerHTML = turnosDia.map(t => {
            const colorTipo = {
              'guardia': '#ff8c00',
              'consulta': '#10b981',
              'cirugia': '#ef4444',
              'otro': '#6366f1'
            }[t.tipo] || '#6366f1';
            
            return `
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                <div style="width: 4px; height: 40px; background: ${colorTipo}; border-radius: 2px;"></div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 13px;">${t.horaInicio} - ${t.horaFin} | ${t.tipo.toUpperCase()}</div>
                  <div style="font-size: 12px; color: var(--muted);">${t.lugar}${t.valor > 0 ? ' | $' + t.valor.toFixed(2) : ''}</div>
                </div>
                <button class="btn danger sm" onclick="eliminarTurno(${t.id})"  data-i18n="common.eliminar">Eliminar</button>
              </div>
            `;
          }).join('');
        } else {
          turnosDiaActual.style.display = 'none';
          document.getElementById('tituloFormTurno').textContent = 'Agregar Turno';
        }
      }
      document.getElementById('formTurnoContainer').style.display = 'block';
    }

    function cargarTurnos() {
      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      turnos = JSON.parse(localStorage.getItem(storageKey) || '[]');
      renderizarCalendario();
    }

    function cambiarMesCalendario(delta) {
      calendarioMesActual += delta;
      if (calendarioMesActual > 11) {
        calendarioMesActual = 0;
        calendarioAnioActual++;
      } else if (calendarioMesActual < 0) {
        calendarioMesActual = 11;
        calendarioAnioActual--;
      }
      renderizarCalendario();
    }

    function renderizarCalendario() {
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      
      document.getElementById('calendarioMesAnio').textContent = `${meses[calendarioMesActual]} ${calendarioAnioActual}`;
      
      const primerDia = new Date(calendarioAnioActual, calendarioMesActual, 1).getDay();
      const ultimoDia = new Date(calendarioAnioActual, calendarioMesActual + 1, 0).getDate();
      
      const calendarioHTML = [];
      
      diasSemana.forEach(dia => {
        calendarioHTML.push(`<div style="text-align:center;font-weight:700;padding:8px;background:var(--primary);color:white;border-radius:6px;font-size:12px;">${dia}</div>`);
      });
      
      for (let i = 0; i < primerDia; i++) {
        calendarioHTML.push('<div style="min-height:80px;background:rgba(128,128,128,0.1);border-radius:6px;"></div>');
      }
      
      const turnosDelMes = turnos.filter(t => {
        const fechaTurno = new Date(t.fecha);
        return fechaTurno.getMonth() === calendarioMesActual && fechaTurno.getFullYear() === calendarioAnioActual;
      });
      
      const now = new Date();
      const colombiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
      const hoyDia = colombiaTime.getDate();
      const hoyMes = colombiaTime.getMonth();
      const hoyAnio = colombiaTime.getFullYear();
      
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = `${calendarioAnioActual}-${String(calendarioMesActual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const turnosDia = turnosDelMes.filter(t => t.fecha === fecha);
        const esHoy = (dia === hoyDia && calendarioMesActual === hoyMes && calendarioAnioActual === hoyAnio);
        
        let diaHTML = `<div onclick="abrirFormTurno('${fecha}')" style="min-height:80px;padding:4px;border-radius:6px;cursor:pointer;transition:all 0.2s;background:${esHoy ? 'rgba(0,139,139,0.15)' : 'var(--card)'};border:${esHoy ? '2px solid var(--primary)' : '1px solid var(--border)'};" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none';">`;
        diaHTML += `<div style="font-weight:700;margin-bottom:4px;color:${esHoy ? 'var(--primary)' : 'var(--text)'};">${dia}</div>`;
        
        turnosDia.forEach(turno => {
          const colorTipo = {
            'guardia': '#ff8c00',
            'consulta': '#10b981',
            'cirugia': '#ef4444',
            'otro': '#6366f1'
          }[turno.tipo] || '#6366f1';
          
          const exchangeIcon = turno.isExchange ? 'üîÑ ' : '';
          const paymentIcon = turno.paymentType === 'nomina' ? 'üí∞' : 'üìä';
          const tooltipText = `${turno.tipo} - ${turno.lugar} ${turno.horaInicio}-${turno.horaFin}${turno.isExchange ? ' (INTERCAMBIO)' : ''} | ${turno.paymentType === 'nomina' ? 'N√≥mina' : 'OPS'}`;
          const borderStyle = turno.isExchange ? `border: 2px dashed white;` : '';
          
          diaHTML += `<div style="background:${colorTipo};color:white;font-size:10px;padding:2px 4px;border-radius:4px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;${borderStyle}" title="${tooltipText}">${exchangeIcon}${paymentIcon} ${turno.horaInicio} ${turno.tipo}</div>`;
        });
        
        diaHTML += '</div>';
        calendarioHTML.push(diaHTML);
      }
      
      document.getElementById('calendarioTurnos').innerHTML = calendarioHTML.join('');
      
      actualizarResumenMensual(turnosDelMes);
    }
    
    function actualizarResumenMensual(turnosMes) {
      const now = new Date();
      const mesActual = now.getMonth();
      const anioActual = now.getFullYear();
      
      const turnosMesActual = turnosMes.filter(t => {
        const fechaTurno = new Date(t.fecha);
        return fechaTurno.getMonth() === mesActual && fechaTurno.getFullYear() === anioActual;
      });
      
      const total = turnosMesActual.length;
      const valorTotal = turnosMesActual.reduce((sum, t) => sum + t.valor, 0);
      
      const porUbicacion = {};
      turnosMesActual.forEach(t => {
        const ubicacion = t.lugar || 'Sin ubicaci√≥n';
        if (!porUbicacion[ubicacion]) {
          porUbicacion[ubicacion] = {
            count: 0,
            valor: 0,
            nomina: 0,
            ops: 0,
            valorNomina: 0,
            valorOps: 0
          };
        }
        porUbicacion[ubicacion].count++;
        porUbicacion[ubicacion].valor += t.valor || 0;
        
        const paymentType = t.paymentType || 'ops';
        if (paymentType === 'nomina') {
          porUbicacion[ubicacion].nomina++;
          porUbicacion[ubicacion].valorNomina += t.valor || 0;
        } else {
          porUbicacion[ubicacion].ops++;
          porUbicacion[ubicacion].valorOps += t.valor || 0;
        }
      });
      
      const totalNomina = turnosMesActual.filter(t => (t.paymentType || 'ops') === 'nomina').length;
      const totalOps = turnosMesActual.filter(t => (t.paymentType || 'ops') === 'ops').length;
      const valorNomina = turnosMesActual.filter(t => (t.paymentType || 'ops') === 'nomina').reduce((sum, t) => sum + t.valor, 0);
      const valorOps = turnosMesActual.filter(t => (t.paymentType || 'ops') === 'ops').reduce((sum, t) => sum + t.valor, 0);
      
      let html = '<div style="margin-bottom: 16px;">';
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">';
      html += `<div style="padding: 12px; background: linear-gradient(135deg, var(--g1), var(--g2)); border-radius: 8px; color: white;">
        <div style="font-size: 12px; opacity: 0.9;">Total Turnos</div>
        <div style="font-size: 24px; font-weight: 700;">${total}</div>
      </div>`;
      html += `<div style="padding: 12px; background: linear-gradient(135deg, var(--g1), var(--g2)); border-radius: 8px; color: white;">
        <div style="font-size: 12px; opacity: 0.9;">Valor Total</div>
        <div style="font-size: 24px; font-weight: 700;">$${valorTotal.toFixed(2)}</div>
      </div>`;
      html += '</div>';
      
      html += '<div style="margin-bottom: 16px;">';
      html += '<h5 style="margin: 0 0 8px 0; color: var(--primary);">Por Tipo de Pago</h5>';
      html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';
      html += `<div style="padding: 10px; background: rgba(0,139,139,0.1); border-radius: 6px; border-left: 3px solid #10b981;">
        <div style="font-weight: 600; color: #10b981;">üí∞ N√≥mina</div>
        <div style="font-size: 13px; margin-top: 4px;">Turnos: ${totalNomina} | Valor: $${valorNomina.toFixed(2)}</div>
      </div>`;
      html += `<div style="padding: 10px; background: rgba(0,139,139,0.1); border-radius: 6px; border-left: 3px solid #f59e0b;">
        <div style="font-weight: 600; color: #f59e0b;">üìä OPS</div>
        <div style="font-size: 13px; margin-top: 4px;">Turnos: ${totalOps} | Valor: $${valorOps.toFixed(2)}</div>
      </div>`;
      html += '</div>';
      html += '</div>';
      
      if (Object.keys(porUbicacion).length > 0) {
        html += '<div>';
        html += '<h5 style="margin: 0 0 8px 0; color: var(--primary);">Desglose por Ubicaci√≥n</h5>';
        Object.keys(porUbicacion).sort().forEach(ubicacion => {
          const data = porUbicacion[ubicacion];
          html += `<div style="padding: 10px; background: rgba(0,139,139,0.05); border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--primary);">
            <div style="font-weight: 600; margin-bottom: 6px;">üìç ${ubicacion}</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 13px;">
              <div>Total: ${data.count} turnos</div>
              <div>Valor: $${data.valor.toFixed(2)}</div>
              <div style="color: #10b981;">N√≥mina: ${data.nomina} ($${data.valorNomina.toFixed(2)})</div>
              <div style="color: #f59e0b;">OPS: ${data.ops} ($${data.valorOps.toFixed(2)})</div>
            </div>
          </div>`;
        });
        html += '</div>';
      }
      
      html += '</div>';
      
      document.getElementById('resumenTurnos').innerHTML = html;
    }

    function eliminarTurno(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este turno?')) return;

      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      const turnosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const filtered = turnosExistentes.filter(t => t.id !== id);
      localStorage.setItem(storageKey, JSON.stringify(filtered));

      cargarTurnos();
      alert('Turno eliminado');
    }

    let cambiosTurno = [];

    function mostrarVistaCalendario() {
      document.getElementById('vistaCalendario').style.display = 'block';
      document.getElementById('vistaNomina').style.display = 'none';
      document.getElementById('vistaOPS').style.display = 'none';
      document.getElementById('vistaCambios').style.display = 'none';
      
      document.getElementById('btnVistaCalendario').style.background = 'var(--primary)';
      document.getElementById('btnVistaCalendario').style.color = 'white';
      document.getElementById('btnVistaCalendario').classList.remove('secondary');
      
      document.getElementById('btnVistaNomina').style.background = '';
      document.getElementById('btnVistaNomina').style.color = '';
      document.getElementById('btnVistaNomina').classList.add('secondary');
      
      document.getElementById('btnVistaOPS').style.background = '';
      document.getElementById('btnVistaOPS').style.color = '';
      document.getElementById('btnVistaOPS').classList.add('secondary');
      
      document.getElementById('btnVistaCambios').style.background = '';
      document.getElementById('btnVistaCambios').style.color = '';
      document.getElementById('btnVistaCambios').classList.add('secondary');
    }

    function mostrarVistaCambios() {
      document.getElementById('vistaCalendario').style.display = 'none';
      document.getElementById('vistaNomina').style.display = 'none';
      document.getElementById('vistaOPS').style.display = 'none';
      document.getElementById('vistaCambios').style.display = 'block';
      
      document.getElementById('btnVistaCalendario').style.background = '';
      document.getElementById('btnVistaCalendario').style.color = '';
      document.getElementById('btnVistaCalendario').classList.add('secondary');
      
      document.getElementById('btnVistaNomina').style.background = '';
      document.getElementById('btnVistaNomina').style.color = '';
      document.getElementById('btnVistaNomina').classList.add('secondary');
      
      document.getElementById('btnVistaOPS').style.background = '';
      document.getElementById('btnVistaOPS').style.color = '';
      document.getElementById('btnVistaOPS').classList.add('secondary');
      
      document.getElementById('btnVistaCambios').style.background = 'var(--primary)';
      document.getElementById('btnVistaCambios').style.color = 'white';
      document.getElementById('btnVistaCambios').classList.remove('secondary');
      
      cargarCambios();
    }

    function guardarCambioTurno() {
      const medico = document.getElementById('cambioMedico').value.trim();
      const miTurno = document.getElementById('cambioMiTurno').value;
      const turnoAsumido = document.getElementById('cambioTurnoAsumido').value;
      const tipo = document.getElementById('cambioTipo').value;
      const notas = document.getElementById('cambioNotas').value.trim();

      if (!medico || !miTurno || !turnoAsumido) {
        alert('Por favor completa todos los campos requeridos');
        return;
      }

      const cambio = {
        id: Date.now(),
        medico,
        miTurno,
        turnoAsumido,
        tipo,
        notas,
        fecha: new Date().toISOString(),
        creador: currentUser?.username || 'unknown'
      };

      const storageKey = 'cambios_turno_' + (currentUser?.username || 'local');
      const cambiosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      cambiosExistentes.push(cambio);
      localStorage.setItem(storageKey, JSON.stringify(cambiosExistentes));

      const turnoIntercambiado = {
        id: Date.now() + 1,
        fecha: turnoAsumido,
        horaInicio: '00:00',
        horaFin: '23:59',
        valor: 0,
        lugar: `Cambio con ${medico}`,
        tipo: tipo,
        paymentType: 'ops',
        notas: `Intercambio de turno. Mi turno original: ${new Date(miTurno).toLocaleDateString('es-ES')}. ${notas}`,
        creador: currentUser?.username || 'unknown',
        isExchange: true,
        exchangeDetails: {
          medico: medico,
          miTurno: miTurno,
          cambioId: cambio.id
        }
      };

      const storageKeyTurnos = 'turnos_' + (currentUser?.username || 'local');
      const turnosExistentes = JSON.parse(localStorage.getItem(storageKeyTurnos) || '[]');
      turnosExistentes.push(turnoIntercambiado);
      localStorage.setItem(storageKeyTurnos, JSON.stringify(turnosExistentes));

      limpiarFormCambio();
      cargarCambios();
      cargarTurnos();
      alert('Cambio de turno registrado exitosamente y agregado al calendario');
    }

    function limpiarFormCambio() {
      document.getElementById('cambioMedico').value = '';
      document.getElementById('cambioMiTurno').value = '';
      document.getElementById('cambioTurnoAsumido').value = '';
      document.getElementById('cambioTipo').value = 'guardia';
      document.getElementById('cambioNotas').value = '';
    }

    function cargarCambios() {
      const storageKey = 'cambios_turno_' + (currentUser?.username || 'local');
      cambiosTurno = JSON.parse(localStorage.getItem(storageKey) || '[]');
      mostrarCambios();
    }

    function mostrarCambios() {
      const listaCambios = document.getElementById('listaCambios');
      
      if (cambiosTurno.length === 0) {
        listaCambios.innerHTML = '<p class="text-muted">No hay cambios de turno registrados</p>';
        return;
      }

      cambiosTurno.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      listaCambios.innerHTML = cambiosTurno.map(cambio => {
        const miTurnoFecha = new Date(cambio.miTurno).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
        const turnoAsumidoFecha = new Date(cambio.turnoAsumido).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
        
        const colorTipo = {
          'guardia': '#ff8c00',
          'consulta': '#10b981',
          'cirugia': '#ef4444',
          'otro': '#6366f1'
        }[cambio.tipo] || '#6366f1';

        return `
          <div class="doc-item" style="border-left: 4px solid ${colorTipo};">
            <div style="flex: 1;">
              <div class="doc-name">Cambio con: ${cambio.medico}</div>
              <div class="doc-meta">
                <span style="color: #ef4444;">‚û° Cedo: ${miTurnoFecha}</span> | 
                <span style="color: #10b981;">‚û° Asumo: ${turnoAsumidoFecha}</span> | 
                <span style="background: ${colorTipo}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${cambio.tipo.toUpperCase()}</span>
              </div>
              ${cambio.notas ? `<div class="doc-meta" style="margin-top: 4px; font-style: italic;">${cambio.notas}</div>` : ''}
            </div>
            <button class="btn sm danger" onclick="eliminarCambio(${cambio.id})"  data-i18n="common.eliminar">Eliminar</button>
          </div>
        `;
      }).join('');
    }

    function eliminarCambio(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este cambio de turno?')) return;

      const storageKey = 'cambios_turno_' + (currentUser?.username || 'local');
      const cambiosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const filtered = cambiosExistentes.filter(c => c.id !== id);
      localStorage.setItem(storageKey, JSON.stringify(filtered));

      cargarCambios();
      alert('Cambio de turno eliminado');
    }

    function mostrarVistaNomina() {
      document.getElementById('vistaCalendario').style.display = 'none';
      document.getElementById('vistaNomina').style.display = 'block';
      document.getElementById('vistaOPS').style.display = 'none';
      document.getElementById('vistaCambios').style.display = 'none';
      
      document.getElementById('btnVistaCalendario').classList.add('secondary');
      document.getElementById('btnVistaCalendario').style.background = '';
      document.getElementById('btnVistaCalendario').style.color = '';
      
      document.getElementById('btnVistaNomina').classList.remove('secondary');
      document.getElementById('btnVistaNomina').style.background = 'var(--primary)';
      document.getElementById('btnVistaNomina').style.color = 'white';
      
      document.getElementById('btnVistaOPS').classList.add('secondary');
      document.getElementById('btnVistaOPS').style.background = '';
      document.getElementById('btnVistaOPS').style.color = '';
      
      document.getElementById('btnVistaCambios').classList.add('secondary');
      document.getElementById('btnVistaCambios').style.background = '';
      document.getElementById('btnVistaCambios').style.color = '';
    }

    function mostrarVistaOPS() {
      document.getElementById('vistaCalendario').style.display = 'none';
      document.getElementById('vistaNomina').style.display = 'none';
      document.getElementById('vistaOPS').style.display = 'block';
      document.getElementById('vistaCambios').style.display = 'none';
      
      document.getElementById('btnVistaCalendario').classList.add('secondary');
      document.getElementById('btnVistaCalendario').style.background = '';
      document.getElementById('btnVistaCalendario').style.color = '';
      
      document.getElementById('btnVistaNomina').classList.add('secondary');
      document.getElementById('btnVistaNomina').style.background = '';
      document.getElementById('btnVistaNomina').style.color = '';
      
      document.getElementById('btnVistaOPS').classList.remove('secondary');
      document.getElementById('btnVistaOPS').style.background = 'var(--primary)';
      document.getElementById('btnVistaOPS').style.color = 'white';
      
      document.getElementById('btnVistaCambios').classList.add('secondary');
      document.getElementById('btnVistaCambios').style.background = '';
      document.getElementById('btnVistaCambios').style.color = '';
    }

    function generarTurnosNomina() {
      const salario = parseFloat(document.getElementById('nominaSalarioFijo').value);
      const lugar = document.getElementById('nominaLugar').value.trim();
      const horaInicio = document.getElementById('nominaHoraInicio').value;
      const horaFin = document.getElementById('nominaHoraFin').value;
      const tipo = document.getElementById('nominaTipo').value;

      const diasSeleccionados = [];
      for (let i = 0; i <= 6; i++) {
        if (document.getElementById(`nominaDia${i}`).checked) {
          diasSeleccionados.push(i);
        }
      }

      if (!salario || salario <= 0) {
        alert('Por favor ingresa un salario mensual v√°lido');
        return;
      }

      if (!lugar) {
        alert('Por favor ingresa el lugar de trabajo');
        return;
      }

      if (diasSeleccionados.length === 0) {
        alert('Por favor selecciona al menos un d√≠a de trabajo');
        return;
      }

      const now = new Date();
      const mesActual = now.getMonth();
      const anioActual = now.getFullYear();
      const ultimoDia = new Date(anioActual, mesActual + 1, 0).getDate();

      const turnosACrear = [];
      let totalDiasEnMes = 0;

      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = new Date(anioActual, mesActual, dia);
        const diaSemana = fecha.getDay();

        if (diasSeleccionados.includes(diaSemana)) {
          totalDiasEnMes++;
        }
      }

      if (totalDiasEnMes === 0) {
        alert('No hay d√≠as de trabajo en el mes actual con los d√≠as seleccionados');
        return;
      }

      const valorPorTurno = salario / totalDiasEnMes;

      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = new Date(anioActual, mesActual, dia);
        const diaSemana = fecha.getDay();

        if (diasSeleccionados.includes(diaSemana)) {
          const fechaStr = `${anioActual}-${String(mesActual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
          
          turnosACrear.push({
            id: Date.now() + Math.random(),
            fecha: fechaStr,
            horaInicio: horaInicio,
            horaFin: horaFin,
            valor: valorPorTurno,
            lugar: lugar,
            tipo: tipo,
            paymentType: 'nomina',
            notas: `Turno de n√≥mina - Salario mensual: $${salario.toFixed(2)}`,
            creador: currentUser?.username || 'unknown',
            isExchange: false
          });
        }
      }

      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      const turnosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      const turnosExistentesFiltrados = turnosExistentes.filter(t => {
        const fechaTurno = new Date(t.fecha);
        return !(fechaTurno.getMonth() === mesActual && 
                 fechaTurno.getFullYear() === anioActual && 
                 t.paymentType === 'nomina');
      });

      const nuevosTurnos = [...turnosExistentesFiltrados, ...turnosACrear];
      localStorage.setItem(storageKey, JSON.stringify(nuevosTurnos));

      cargarTurnos();
      mostrarVistaCalendario();
      alert(`‚úì Se han generado ${turnosACrear.length} turnos de n√≥mina para el mes actual.\n\nC√°lculo:\nSalario mensual: $${salario.toFixed(2)}\nTurnos generados: ${turnosACrear.length}\nValor por turno: $${valorPorTurno.toFixed(2)}\nTotal: $${(valorPorTurno * turnosACrear.length).toFixed(2)}`);
    }

    function limpiarConfigNomina() {
      document.getElementById('nominaSalarioFijo').value = '';
      document.getElementById('nominaLugar').value = '';
      document.getElementById('nominaHoraInicio').value = '08:00';
      document.getElementById('nominaHoraFin').value = '17:00';
      document.getElementById('nominaTipo').value = 'consulta';
      
      for (let i = 0; i <= 6; i++) {
        document.getElementById(`nominaDia${i}`).checked = false;
      }
    }

    function generarSecuenciaOPS() {
      const fechaInicio = document.getElementById('opsSecFechaInicio').value;
      const cantidad = parseInt(document.getElementById('opsSecCantidad').value);
      const frecuencia = parseInt(document.getElementById('opsSecFrecuencia').value);
      const horaInicio = document.getElementById('opsSecHoraInicio').value;
      const horaFin = document.getElementById('opsSecHoraFin').value;
      const valor = parseFloat(document.getElementById('opsSecValor').value) || 0;
      const lugar = document.getElementById('opsSecLugar').value.trim();
      const tipo = document.getElementById('opsSecTipo').value;

      if (!fechaInicio) {
        alert('Por favor selecciona una fecha de inicio');
        return;
      }

      if (!cantidad || cantidad < 1 || cantidad > 31) {
        alert('Por favor ingresa un n√∫mero v√°lido de turnos (entre 1 y 31)');
        return;
      }

      if (!lugar) {
        alert('Por favor ingresa el lugar');
        return;
      }

      const turnosACrear = [];
      const fechaBase = new Date(fechaInicio + 'T00:00:00');

      for (let i = 0; i < cantidad; i++) {
        const fecha = new Date(fechaBase);
        fecha.setDate(fechaBase.getDate() + (i * frecuencia));
        
        const anio = fecha.getFullYear();
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const dia = String(fecha.getDate()).padStart(2, '0');
        const fechaStr = `${anio}-${mes}-${dia}`;

        turnosACrear.push({
          id: Date.now() + Math.random(),
          fecha: fechaStr,
          horaInicio: horaInicio,
          horaFin: horaFin,
          valor: valor,
          lugar: lugar,
          tipo: tipo,
          paymentType: 'ops',
          notas: `Turno OPS (secuencia ${i + 1}/${cantidad})`,
          creador: currentUser?.username || 'unknown',
          isExchange: false
        });
      }

      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      const turnosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const nuevosTurnos = [...turnosExistentes, ...turnosACrear];
      localStorage.setItem(storageKey, JSON.stringify(nuevosTurnos));

      cargarTurnos();
      mostrarVistaCalendario();
      alert(`‚úì Se han generado ${cantidad} turnos OPS en secuencia.\nValor total: $${(valor * cantidad).toFixed(2)}`);
    }

    function limpiarSecuenciaOPS() {
      document.getElementById('opsSecFechaInicio').value = '';
      document.getElementById('opsSecCantidad').value = '4';
      document.getElementById('opsSecFrecuencia').value = '3';
      document.getElementById('opsSecHoraInicio').value = '07:00';
      document.getElementById('opsSecHoraFin').value = '19:00';
      document.getElementById('opsSecValor').value = '';
      document.getElementById('opsSecLugar').value = '';
      document.getElementById('opsSecTipo').value = 'guardia';
    }

    let chatMessages = [];

    function agregarMensajeChat(role, content, streaming = false) {
      const messagesContainer = document.getElementById('iaChatMessages');
      const welcomeMsg = messagesContainer.querySelector('div[style*="text-align:center"]');
      if (welcomeMsg) welcomeMsg.remove();
      
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `display:flex;gap:12px;${role === 'user' ? 'justify-content:flex-end;' : ''}`;
      
      const avatar = document.createElement('div');
      avatar.style.cssText = 'width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px;' + (role === 'user' ? 'background:linear-gradient(135deg,var(--g1),var(--g2));' : 'background:var(--card);border:2px solid var(--primary);');
      avatar.textContent = role === 'user' ? 'üë®‚Äç‚öïÔ∏è' : 'ü§ñ';
      
      const bubble = document.createElement('div');
      bubble.style.cssText = `max-width:75%;padding:12px 16px;border-radius:16px;${role === 'user' ? 'border-bottom-right-radius:4px;' : 'border-bottom-left-radius:4px;'}background:${role === 'user' ? 'linear-gradient(135deg,var(--g1),var(--g2))' : 'var(--card)'};color:${role === 'user' ? '#ffffff' : 'var(--text)'};${role === 'assistant' ? 'border:1px solid var(--border);' : ''}line-height:1.6;font-size:14px;white-space:pre-wrap;word-wrap:break-word;`;
      bubble.textContent = content;
      
      if (role === 'user') {
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
      } else {
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
      }
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      return bubble;
    }

    async function enviarMensajeIA() {
      const input = document.getElementById('iaChatInput');
      const prompt = input.value.trim();
      const btnEnviar = document.getElementById('btnEnviarIA');
      const btnText = document.getElementById('btnEnviarIAText');
      
      if (!prompt) return;
      
      chatMessages.push({role: 'user', content: prompt});
      agregarMensajeChat('user', prompt);
      input.value = '';
      input.style.height = '44px';
      
      btnEnviar.disabled = true;
      btnText.textContent = '‚óè‚óè‚óè';
      
      try {
        const bubble = agregarMensajeChat('assistant', '');
        let fullResponse = '';
        
        const response = await fetch('/api/ai/stream', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({messages: chatMessages})
        });
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
          const {done, value} = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n').filter(line => line.trim());
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.substring(6);
              if (data === '[DONE]') continue;
              
              try {
                const json = JSON.parse(data);
                if (json.error) {
                  throw new Error(json.error);
                }
                if (json.content) {
                  fullResponse += json.content;
                  bubble.textContent = fullResponse;
                  const container = document.getElementById('iaChatMessages');
                  container.scrollTop = container.scrollHeight;
                }
              } catch (e) {
                if (!e.message.includes('Unexpected')) console.error('Parse error:', e);
              }
            }
          }
        }
        
        chatMessages.push({role: 'assistant', content: fullResponse});
      } catch (err) {
        console.error('Error en chat IA:', err);
        agregarMensajeChat('assistant', `‚ö†Ô∏è Error: ${err.message}. Por favor, verifica la configuraci√≥n de la IA.`);
      } finally {
        btnEnviar.disabled = false;
        btnText.textContent = 'Enviar';
        input.focus();
      }
    }

    function limpiarChatIA() {
      chatMessages = [];
      const messagesContainer = document.getElementById('iaChatMessages');
      messagesContainer.innerHTML = `
        <div style="text-align:center;color:var(--muted);padding:40px 20px;">
          <div style="font-size:48px;margin-bottom:12px;">üí¨</div>
          <h4 style="margin:0 0 8px 0;color:var(--text);">¬øEn qu√© puedo ayudarte hoy?</h4>
          <p style="margin:0;font-size:14px;">Preg√∫ntame sobre tratamientos, diagn√≥sticos, gu√≠as cl√≠nicas o cualquier tema de salud.</p>
        </div>
      `;
    }

    let medicamentosInteraction = [];

    function agregarMedicamentoInteraction() {
      const input = document.getElementById('drugInputInteraction');
      const medicamento = input.value.trim();
      
      if (!medicamento) {
        alert('Por favor, ingresa el nombre de un medicamento');
        return;
      }
      
      if (medicamentosInteraction.includes(medicamento.toLowerCase())) {
        alert('Este medicamento ya est√° en la lista');
        return;
      }
      
      medicamentosInteraction.push(medicamento.toLowerCase());
      input.value = '';
      actualizarListaMedicamentosInteraction();
    }

    function actualizarListaMedicamentosInteraction() {
      const container = document.getElementById('medicamentosListaInteraction');
      
      if (medicamentosInteraction.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); font-size: 14px; text-align: center; padding: 20px;">No hay medicamentos agregados. Agrega al menos 2 medicamentos para verificar interacciones.</p>';
        return;
      }
      
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
          ${medicamentosInteraction.map((med, index) => `
            <div style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, var(--g1), var(--g2)); color: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="flex: 1; font-weight: 600; font-size: 14px; text-transform: capitalize;">üíä ${med}</div>
              <button onclick="eliminarMedicamentoInteraction(${index})" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚úï</button>
            </div>
          `).join('')}
        </div>
        <p style="margin-top: 12px; font-size: 13px; color: var(--muted);">
          <strong>${medicamentosInteraction.length}</strong> medicamento${medicamentosInteraction.length !== 1 ? 's' : ''} agregado${medicamentosInteraction.length !== 1 ? 's' : ''}
        </p>
      `;
    }

    function eliminarMedicamentoInteraction(index) {
      medicamentosInteraction.splice(index, 1);
      actualizarListaMedicamentosInteraction();
    }

    function verificarInteracciones() {
      if (medicamentosInteraction.length < 2) {
        alert('Agrega al menos 2 medicamentos para verificar interacciones');
        return;
      }
      
      let html = `
        <div style="background: rgba(99,102,241,0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <p style="margin: 0; font-size: 14px; line-height: 1.6;">
            <strong>üìù An√°lisis de ${medicamentosInteraction.length} medicamentos:</strong><br>
            ${medicamentosInteraction.map(m => '<span style="background: rgba(0,139,139,0.15); padding: 2px 8px; border-radius: 4px; margin: 2px; display: inline-block; text-transform: capitalize;">' + m + '</span>').join('')}
          </p>
        </div>
        
        <div style="background: rgba(16,185,129,0.1); border-left: 4px solid #10b981; padding: 16px; border-radius: 6px; margin-bottom: 16px;">
          <p style="margin: 0 0 8px 0; font-weight: 600; color: #10b981;">‚úì Verificaci√≥n B√°sica Completada</p>
          <p style="margin: 0; font-size: 14px;">
            Se ha generado una lista de los medicamentos para verificar. Para un an√°lisis detallado de interacciones, recomendamos consultar las bases de datos especializadas listadas abajo.
          </p>
        </div>
        
        <div style="background: rgba(251,191,36,0.1); border-left: 4px solid #fbbf24; padding: 16px; border-radius: 6px; margin-bottom: 16px;">
          <p style="margin: 0 0 8px 0; font-weight: 600; color: #d97706;">‚ö†Ô∏è Recomendaciones Importantes</p>
          <ul style="margin: 8px 0 0 20px; padding: 0; font-size: 14px; line-height: 1.8;">
            <li>Verifica las interacciones en bases de datos actualizadas</li>
            <li>Considera las caracter√≠sticas del paciente (edad, peso, comorbilidades)</li>
            <li>Revisa dosis, v√≠as de administraci√≥n y tiempos</li>
            <li>Consulta con farmacia cl√≠nica cuando sea necesario</li>
          </ul>
        </div>
        
        <div style="margin-top: 16px;">
          <h5 style="margin: 0 0 12px 0; font-size: 14px; color: var(--primary);">üîó Verifica en bases de datos especializadas:</h5>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <a href="https://www.drugs.com/drug_interactions.html" target="_blank" class="btn secondary" style="text-decoration: none; text-align: center;">Drugs.com Interaction Checker</a>
            <a href="https://reference.medscape.com/drug-interactionchecker" target="_blank" class="btn secondary" style="text-decoration: none; text-align: center;">Medscape Drug Interaction Checker</a>
          </div>
        </div>
      `;
      
      document.getElementById('interaccionesResultContent').innerHTML = html;
      document.getElementById('interaccionesResult').style.display = 'block';
    }

    function limpiarInteracciones() {
      medicamentosInteraction = [];
      document.getElementById('drugInputInteraction').value = '';
      actualizarListaMedicamentosInteraction();
      document.getElementById('interaccionesResult').style.display = 'none';
    }

    document.getElementById('drugInputInteraction')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        agregarMedicamentoInteraction();
      }
    });
  </script>
  <script src="src/utils/offlineMode.js"></script>
  <script src="src/utils/notificationManager.js"></script>
  <script src="src/utils/clinicalGuides.js"></script>
  <script src="src/utils/quizSystem.js"></script>
</body></html>

<script>
function mostrarGuiasClinicas() {
  const guiasHtml = '<div class="tool-card" onclick="showMenu()" style="cursor:pointer;"><span class="tool-card-icon">‚Üê</span><h3>Volver</h3></div>';
  const guidesData = clinicalGuides.guides.map((g, i) => `
    <div class="tool-card" onclick="alert('${g.title}\\n\\n${g.content.replace(/'/g, "\\'").substring(0, 200)}...')">
      <h4>${g.title}</h4>
      <p>${g.shortDesc}</p>
    </div>
  `).join('');
  
  document.getElementById('toolMenu').innerHTML = guiasHtml + guidesData;
}

function mostrarQuizzes() {
  const quizzesHtml = '<div class="tool-card" onclick="showMenu()" style="cursor:pointer;"><span class="tool-card-icon">‚Üê</span><h3>Volver</h3></div>';
  const quizzesData = quizzes.assessments.map((q, i) => `
    <div class="tool-card" onclick="alert('${q.title}\\n${q.questions.length} preguntas\\nDificultad: ${q.difficulty}')">
      <h4>${q.title}</h4>
      <p>${q.questions.length} preguntas</p>
    </div>
  `).join('');
  
  document.getElementById('toolMenu').innerHTML = quizzesHtml + quizzesData;
}
</script>

<script>
function showTool(toolId) {
  document.getElementById('toolMenu').style.display = 'none';
  document.getElementById(toolId + 'Tool').style.display = 'block';
  
  // Cargar contenido espec√≠fico
  if (toolId === 'guias') {
    cargarGuiasClinicas();
  } else if (toolId === 'quiz') {
    cargarQuizzes();
  }
}

function showMenu() {
  document.querySelectorAll('[id$="Tool"]').forEach(el => el.style.display = 'none');
  document.getElementById('toolMenu').style.display = 'grid';
}

// Unified tool control system for ALL tools including new ones
window.showTool = function(toolId) {
  // Hide all tools
  document.querySelectorAll('[id$="Tool"]').forEach(el => el.style.display = 'none');
  
  // Map tool IDs to their element IDs and load functions
  const toolMap = {
    'corrector': { id: 'correctorTool' },
    'gases': { id: 'gasesTool' },
    'infusiones': { id: 'infusionesTool' },
    'plantillas': { id: 'plantillasTool' },
    'ia': { id: 'iaTool' },
    'interacciones': { id: 'interaccionesTool' },
    'guias': { id: 'guiasTool', loader: cargarGuiasClinicas },
    'quiz': { id: 'quizTool', loader: cargarQuizzes }
  };
  
  const toolConfig = toolMap[toolId];
  if (!toolConfig) {
    console.warn('Herramienta no encontrada:', toolId);
    return;
  }
  
  // Show the tool
  const toolElement = document.getElementById(toolConfig.id);
  if (toolElement) {
    toolElement.style.display = 'block';
    
    // Call loader function if exists (for dynamic content)
    if (toolConfig.loader && typeof toolConfig.loader === 'function') {
      toolConfig.loader();
    }
  }
  
  // Hide menu
  document.getElementById('toolMenu').style.display = 'none';
};

function cargarGuiasClinicas() {
  if (typeof clinicalGuides === 'undefined') return;
  const grid = document.getElementById('guidesGrid');
  if (!grid) return;
  
  const html = clinicalGuides.guides.map((guide, idx) => `
    <div class="card glass" style="padding:16px;cursor:pointer;transition:all 0.3s;border:2px solid transparent;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'" onclick="mostrarGuiaDetalle(${idx})">
      <h4 style="margin:0 0 8px 0;color:var(--primary);font-size:15px;">${guide.title}</h4>
      <p style="margin:0;color:var(--muted);font-size:13px;">${guide.shortDesc}</p>
      <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;">
        ${guide.keywords.map(k => `<span style="background:rgba(var(--primary-rgb), 0.1);color:var(--primary);padding:2px 8px;border-radius:12px;font-size:11px;">${k}</span>`).join('')}
      </div>
    </div>
  `).join('');
  grid.innerHTML = html || '<div style="text-align:center;padding:40px;color:var(--muted);">No hay gu√≠as disponibles</div>';
}

function cargarQuizzes() {
  if (typeof quizzes === 'undefined') return;
  const grid = document.getElementById('quizzesGrid');
  if (!grid) return;
  
  const html = quizzes.assessments.map((quiz, idx) => `
    <div class="card glass" style="padding:16px;cursor:pointer;transition:all 0.3s;border:2px solid transparent;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'" onclick="mostrarQuizDetalle(${idx})">
      <h4 style="margin:0 0 8px 0;color:var(--primary);font-size:15px;">${quiz.title}</h4>
      <p style="margin:0;color:var(--muted);font-size:13px;">${quiz.description}</p>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
        <span style="background:rgba(var(--primary-rgb), 0.1);color:var(--primary);padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">${quiz.questions.length} preguntas</span>
        <span style="background:rgba(251,191,36,0.1);color:#f59e0b;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:capitalize;">${quiz.difficulty}</span>
      </div>
    </div>
  `).join('');
  grid.innerHTML = html || '<div style="text-align:center;padding:40px;color:var(--muted);">No hay evaluaciones disponibles</div>';
}

function mostrarGuiaDetalle(idx) {
  if (typeof clinicalGuides === 'undefined' || !clinicalGuides.guides[idx]) return;
  const guide = clinicalGuides.guides[idx];
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
  modal.innerHTML = `
    <div class="card glass" style="max-width:700px;max-height:80vh;overflow-y:auto;padding:24px;border-radius:12px;">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
        <h3 style="margin:0;color:var(--text);">${guide.title}</h3>
        <button onclick="this.closest('[style*=position]').remove()" style="background:transparent;border:none;font-size:24px;cursor:pointer;color:var(--text);">√ó</button>
      </div>
      <div style="color:var(--text);line-height:1.6;">${guide.content}</div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => { if(e.target === modal) modal.remove(); });
}

function mostrarQuizDetalle(idx) {
  if (typeof quizzes === 'undefined' || !quizzes.assessments[idx]) return;
  const quiz = quizzes.assessments[idx];
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
  const questionsHtml = quiz.questions.map((q, i) => `
    <div style="margin-bottom:20px;padding:16px;background:var(--card);border-radius:8px;border-left:4px solid var(--primary);">
      <p style="margin:0 0 12px 0;font-weight:600;color:var(--text);"><strong>Pregunta ${i+1}:</strong> ${q.question}</p>
      <div style="margin-left:16px;">
        ${q.options.map((opt, j) => `
          <label style="display:block;margin:8px 0;cursor:pointer;color:var(--text);">
            <input type="radio" name="q${i}" value="${j}" style="margin-right:8px;">
            ${opt}
            ${j === q.correct ? '<span style="color:var(--success);font-weight:600;"> ‚úì Correcta</span>' : ''}
          </label>
        `).join('')}
      </div>
      <p style="margin:12px 0 0 0;font-size:12px;color:var(--muted);font-style:italic;">${q.explanation}</p>
    </div>
  `).join('');
  modal.innerHTML = `
    <div class="card glass" style="max-width:700px;max-height:80vh;overflow-y:auto;padding:24px;border-radius:12px;">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
        <div>
          <h3 style="margin:0 0 4px 0;color:var(--text);">${quiz.title}</h3>
          <p style="margin:0;color:var(--muted);font-size:13px;">${quiz.questions.length} preguntas - ${quiz.difficulty}</p>
        </div>
        <button onclick="this.closest('[style*=position]').remove()" style="background:transparent;border:none;font-size:24px;cursor:pointer;color:var(--text);">√ó</button>
      </div>
      <div style="color:var(--text);">${questionsHtml}</div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => { if(e.target === modal) modal.remove(); });
}

function aplicarTema(themeName) {
  if (typeof themeCustomizer !== 'undefined') {
    const isDark = localStorage.getItem('theme') === 'dark';
    themeCustomizer.apply(themeName, isDark ? 'dark' : 'light');
    
    // Update active theme card
    document.querySelectorAll('#themesGrid > div').forEach(card => {
      card.style.borderColor = 'transparent';
    });
    event.target.closest('.card').style.borderColor = 'var(--primary)';
  }
}
</script>

<script>
// Override showTool to fix routing
const originalShowTool = window.showTool;
window.showTool = function(toolId) {
  console.log('showTool called:', toolId);
  document.getElementById('toolMenu').style.display = 'none';
  
  // Show the correct tool based on ID
  if (toolId === 'guias') {
    const guiasTool = document.getElementById('guiasTool');
    if (guiasTool) {
      guiasTool.style.display = 'block';
      cargarGuiasClinicas();
    }
  } else if (toolId === 'quiz') {
    const quizTool = document.getElementById('quizTool');
    if (quizTool) {
      quizTool.style.display = 'block';
      cargarQuizzes();
    }
  } else {
    const toolElement = document.getElementById(toolId + 'Tool');
    if (toolElement) {
      toolElement.style.display = 'block';
    }
  }
};
</script>

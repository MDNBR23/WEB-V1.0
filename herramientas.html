<!doctype html><html lang="es" data-theme="light"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#008B8B">
<title>Herramientas ‚Äî NBR WEB</title>
<link rel="stylesheet" href="style.css">
<style>
.tool-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.tool-card {
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  padding: 24px;
}
.tool-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 24px 70px rgba(0,0,0,.4);
}
.tool-card-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
}
.tool-card h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  color: var(--text);
}
.tool-card p {
  margin: 0;
  color: var(--muted);
  font-size: 14px;
}
.tool-section {
  margin-bottom: 24px;
}
.tool-result {
  margin-top: 16px;
  padding: 12px;
  background: var(--bg);
  border-radius: 6px;
  border: 1px solid var(--border);
}
.gsa-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}
.gsa-input-card {
  position: relative;
  padding: 16px;
  background: linear-gradient(135deg, rgba(0,139,139,0.05), rgba(0,128,128,0.05));
  border: 2px solid var(--border);
  border-radius: 12px;
  transition: all 0.3s ease;
}
.gsa-input-card:hover {
  transform: translateY(-2px);
  border-color: var(--primary);
  box-shadow: 0 8px 20px rgba(0,139,139,0.15);
}
.gsa-input-card label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text);
}
.range-indicator {
  color: var(--muted);
  font-size: 12px;
  font-weight: 400;
}
.interactive-input {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.2s ease;
  background: var(--card);
}
.interactive-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,139,139,0.1);
}
.input-status {
  margin-top: 6px;
  font-size: 12px;
  font-weight: 500;
  min-height: 18px;
  transition: all 0.2s ease;
}
.gsa-result {
  padding: 20px;
  background: linear-gradient(135deg, var(--g1), var(--g2));
  color: white;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}
.gsa-result h4 {
  margin: 0 0 12px 0;
  color: white;
  font-size: 18px;
}
.gsa-result p {
  margin: 8px 0;
  font-size: 15px;
  line-height: 1.6;
}
.doc-list {
  margin-top: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.doc-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg);
  border-radius: 6px;
  border: 1px solid var(--border);
}
.doc-item .doc-name {
  flex: 1;
  font-weight: 500;
}
.doc-item .doc-meta {
  color: var(--muted);
  font-size: 13px;
}
.text-editor {
  width: 100%;
  min-height: 300px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: monospace;
  font-size: 14px;
  margin-top: 12px;
}
.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  padding: 10px 18px;
  background: rgba(71,85,105,.85);
  color: #fff;
  border-radius: 12px;
  text-decoration: none !important;
  font-weight: 700;
  transition: all 0.2s;
}
.back-btn:hover {
  background: rgba(51,65,85,.95);
  transform: translateX(-4px);
  text-decoration: none !important;
}
.infusion-calculator {
  display: grid;
  gap: 20px;
}
.infusion-section {
  padding: 16px;
  background: var(--bg);
  border-radius: 8px;
  border: 1px solid var(--border);
}
.infusion-section h4 {
  margin: 0 0 12px 0;
  color: var(--primary);
  font-size: 16px;
  font-weight: 700;
}
.infusion-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}
.infusion-result {
  background: linear-gradient(135deg, var(--g1), var(--g2));
  color: white;
  padding: 16px;
  border-radius: 8px;
  margin-top: 12px;
}
.infusion-result h5 {
  margin: 0 0 8px 0;
  font-size: 18px;
  color: white;
}
.infusion-result p {
  margin: 4px 0;
  font-size: 14px;
}
.medication-select {
  margin-bottom: 16px;
}
.infusion-table {
  width: 100%;
  margin-top: 12px;
  border-collapse: collapse;
}
.infusion-table th,
.infusion-table td {
  padding: 8px;
  border: 1px solid var(--border);
  text-align: left;
}
.infusion-table th {
  background: var(--primary);
  color: white;
  font-weight: 700;
  font-size: 13px;
}
.infusion-table td {
  background: var(--bg);
  font-size: 14px;
}
#medicationSelect {
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  font-size: 15px;
  padding: 12px 14px;
  border-radius: 10px;
  border: 2px solid var(--border);
  background: rgba(255,255,255,.95);
  color: #1a202c;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
}
html[data-theme="dark"] #medicationSelect {
  background: rgba(20,25,42,.85);
  color: #f7fafc;
}
</style>
<script>
  document.documentElement.classList.add('preload');
  window.addEventListener('DOMContentLoaded', function(){
    document.body.classList.add('loaded');
    document.documentElement.classList.remove('preload');
  });
</script>
</head><body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo"><span class="logo-full">NBR WEB</span><span class="logo-short">NBR</span></div>
      <nav>
        <a href="main.html"><span class="icon">üè†</span><span>Principal</span></a>
        <a href="vademecum.html"><span class="icon">üíä</span><span>Vademecum</span></a>
        <a href="herramientas.html" class="active"><span class="icon">üîß</span><span>Herramientas</span></a>
        <a href="sugerencias.html"><span class="icon">üí¨</span><span>Sugerencias</span><span id="sugerenciasBadge" class="sidebar-notification-badge" style="display:none;">0</span></a>
        <a href="configuracion.html"><span class="icon">‚öôÔ∏è</span><span>Configuraci√≥n</span></a>
        <a href="admin.html" id="adminNavLink"><span class="icon">üõ†Ô∏è</span><span>Administraci√≥n</span><span id="adminBadge" class="sidebar-notification-badge" style="display:none;">0</span></a>
      </nav>
    </aside>
    <div class="content">
      <header class="header">
        <button id="btnToggleSidebar" type="button"></button>
        <h2>Herramientas</h2>
        <div class="user-info">
          <img id="avatarTop" alt="">
          <span id="mainUserInfo" class="text-muted"></span>
          <button class="btn danger sm" type="button" onclick="logout()">Salir</button>
        </div>
      </header>
      <main>
        
        <div id="toolMenu" class="tool-menu">
          <div class="card glass tool-card" onclick="showTool('corrector')">
            <span class="tool-card-icon">üìù</span>
            <h3>Corrector de Espacios</h3>
            <p>Elimina espacios m√∫ltiples y normaliza el texto</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('gases')">
            <span class="tool-card-icon">ü©∫</span>
            <h3>Gases Arteriales</h3>
            <p>Interpreta resultados de gasometr√≠a arterial</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('infusiones')">
            <span class="tool-card-icon">üíâ</span>
            <h3>Calculadora</h3>
            <p>Calculadora de sedoanalgesia e infusiones</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('plantillas')">
            <span class="tool-card-icon">üìã</span>
            <h3>Plantillas</h3>
            <p>Gestiona plantillas de evoluci√≥n por patolog√≠a</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('turnos')">
            <span class="tool-card-icon">üìÖ</span>
            <h3>Turnos M√©dicos</h3>
            <p>Organiza turnos con horarios, valores y recordatorios</p>
          </div>
          
          <div class="card glass tool-card" onclick="showTool('ia')">
            <span class="tool-card-icon">ü§ñ</span>
            <h3>IA M√©dica</h3>
            <p>Consulta evidencia m√©dica con IA especializada</p>
          </div>
        </div>

        <div id="correctorTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>Corrector de Espacios de Texto</h3>
            <p class="text-muted">Elimina espacios m√∫ltiples y normaliza el texto.</p>
            <textarea id="textInput" class="text-editor" placeholder="Pega aqu√≠ el texto a corregir..."></textarea>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
              <button class="btn primary" onclick="corregirEspacios()">Corregir Espacios</button>
              <button class="btn" onclick="limpiarTexto()">Limpiar</button>
              <button class="btn" onclick="copiarTexto()">Copiar Resultado</button>
            </div>
            <div id="textResult" class="tool-result" style="display:none;">
              <strong>Resultado:</strong>
              <pre id="textResultContent" style="white-space: pre-wrap; margin-top: 8px;"></pre>
            </div>
          </section>
        </div>

        <div id="gasesTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>ü©∫ Lector de Gases Arteriales</h3>
            <p class="text-muted">Interpreta resultados de gasometr√≠a arterial con an√°lisis detallado.</p>
            <div class="gsa-grid">
              <div class="gsa-input-card">
                <label>pH <small class="range-indicator">(7.35-7.45)</small></label>
                <input type="number" id="gsaPH" step="0.01" placeholder="7.40" class="interactive-input">
                <div class="input-status" id="statusPH"></div>
              </div>
              <div class="gsa-input-card">
                <label>PaCO‚ÇÇ <small class="range-indicator">(35-45 mmHg)</small></label>
                <input type="number" id="gsaPaCO2" step="0.1" placeholder="40" class="interactive-input">
                <div class="input-status" id="statusPaCO2"></div>
              </div>
              <div class="gsa-input-card">
                <label>PaO‚ÇÇ <small class="range-indicator">(80-95 mmHg)</small></label>
                <input type="number" id="gsaPaO2" step="0.1" placeholder="90" class="interactive-input">
                <div class="input-status" id="statusPaO2"></div>
              </div>
              <div class="gsa-input-card">
                <label>HCO‚ÇÉ <small class="range-indicator">(22-26 mEq/L)</small></label>
                <input type="number" id="gsaHCO3" step="0.1" placeholder="24" class="interactive-input">
                <div class="input-status" id="statusHCO3"></div>
              </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
              <button class="btn primary" onclick="interpretarGSA()">üîç Interpretar Resultado</button>
              <button class="btn" onclick="limpiarGSA()">üóëÔ∏è Limpiar</button>
            </div>
            <div id="gsaResult" style="display:none; margin-top: 16px;"></div>
          </section>
        </div>

        <div id="infusionesTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
              <div>
                <h3 style="margin:0;">Calculadora de Infusiones</h3>
                <p class="text-muted" style="margin:4px 0 0 0;">Calcula dosis de sedoanalgesia, vasopresores, inotr√≥picos</p>
              </div>
              <a href="admin.html" id="adminInfusionesLink" class="btn sm" style="display:none;text-decoration:none;">Gestionar medicamentos</a>
            </div>
            
            <div class="infusion-calculator">
              <div class="medication-select">
                <label><strong>Seleccionar medicamento:</strong></label>
                <select id="medicationSelect" onchange="loadMedication()">
                  <option value="">Seleccionar medicamento</option>
                </select>
              </div>

              <div id="medicationInfo" style="display:none;">
                <div class="infusion-section">
                  <h4>Presentaci√≥n</h4>
                  <p id="presentacion"></p>
                </div>

                <div class="infusion-section">
                  <h4>Ingresa dosis del medicamento y peso del paciente</h4>
                  <div class="infusion-grid">
                    <div>
                      <label id="dosisLabel">Dosis</label>
                      <input type="number" id="dosis" step="0.01" oninput="calculateInfusion()">
                    </div>
                    <div>
                      <label>Peso (kg)</label>
                      <input type="number" id="peso" step="0.1" oninput="calculateInfusion()">
                    </div>
                  </div>
                  <div id="dosisCalculada" style="margin-top:12px;"></div>
                </div>

                <div class="infusion-section">
                  <h4>Selecci√≥n de Diluci√≥n</h4>
                  <div id="dilucionOptions"></div>
                  <div id="dosisInfusion" style="margin-top:12px;"></div>
                </div>

                <div id="ordenMedica" class="infusion-result" style="display:none;">
                  <h5>ORDEN M√âDICA</h5>
                  <div id="ordenMedicaContent"></div>
                </div>

                <div style="margin-top:16px; display:flex; gap:8px;">
                  <button class="btn primary" onclick="calculateInfusion()">Calcular</button>
                  <button class="btn" onclick="clearInfusion()">Limpiar</button>
                  <button class="btn success" onclick="copyInfusionOrder()">Copiar Orden M√©dica</button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div id="turnosTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>Gesti√≥n de Turnos M√©dicos</h3>
            <p class="text-muted">Organiza tus turnos m√©dicos con horarios, valor del turno y recordatorios.</p>
            
            <div style="margin-top: 16px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                <div class="field">
                  <label>Fecha del Turno</label>
                  <input type="date" id="turnoFecha">
                </div>
                <div class="field">
                  <label>Hora de Inicio</label>
                  <input type="time" id="turnoHoraInicio">
                </div>
                <div class="field">
                  <label>Hora de Fin</label>
                  <input type="time" id="turnoHoraFin">
                </div>
                <div class="field">
                  <label>Valor del Turno ($)</label>
                  <input type="number" id="turnoValor" step="0.01" placeholder="0.00">
                </div>
                <div class="field">
                  <label>Lugar</label>
                  <input type="text" id="turnoLugar" placeholder="Hospital, Cl√≠nica...">
                </div>
                <div class="field">
                  <label>Tipo de Turno</label>
                  <select id="turnoTipo">
                    <option value="guardia">Guardia</option>
                    <option value="consulta">Consulta</option>
                    <option value="cirugia">Cirug√≠a</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>
              </div>
              <div class="field" style="margin-top: 12px;">
                <label>Notas</label>
                <textarea id="turnoNotas" rows="2" placeholder="Notas adicionales..."></textarea>
              </div>
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="btn primary" onclick="guardarTurno()">Guardar Turno</button>
                <button class="btn" onclick="limpiarFormTurno()">Limpiar</button>
              </div>
            </div>

            <div style="margin-top: 24px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <strong>Turnos Programados:</strong>
                <select id="filterMes" onchange="filtrarTurnos()" style="margin-left: auto;">
                  <option value="">Todos los meses</option>
                </select>
                <input type="search" id="searchTurno" placeholder="Buscar..." onkeyup="filtrarTurnos()">
              </div>
              <div id="turnosList" class="doc-list"></div>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--primary);">
              <h4 style="margin: 0 0 8px 0; color: var(--primary);">Resumen Mensual</h4>
              <p id="resumenTurnos" style="margin: 0; font-size: 14px;">Total de turnos: 0 | Valor total: $0.00</p>
            </div>
          </section>
        </div>

        <div id="iaTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>IA M√©dica - Consulta Evidencia</h3>
            <p class="text-muted">Busca informaci√≥n m√©dica basada en evidencia cient√≠fica.</p>
            
            <div style="margin-top: 16px;">
              <div class="field">
                <label>Pregunta o b√∫squeda</label>
                <textarea id="iaQuery" rows="3" placeholder="Ej: ¬øCu√°l es el tratamiento de primera l√≠nea para neumon√≠a adquirida en la comunidad en pediatr√≠a?"></textarea>
              </div>
              <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center;">
                <button class="btn primary" onclick="buscarIA()">Buscar</button>
                <button class="btn" onclick="limpiarIA()">Limpiar</button>
                <a href="https://www.openevidence.com/" target="_blank" class="btn secondary" style="text-decoration: none;">Ir a Open Evidence</a>
              </div>
            </div>

            <div id="iaResult" style="display:none; margin-top: 16px; padding: 16px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--primary);">
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">Informaci√≥n</h4>
              <div id="iaResultContent"></div>
            </div>
          </section>
        </div>

        <div id="plantillasTool" style="display:none;">
          <a href="javascript:void(0)" class="back-btn" onclick="showMenu()">
            <span>‚Üê</span>
            <span>Volver al men√∫</span>
          </a>
          
          <section class="card glass tool-section">
            <h3>Plantillas</h3>
            <p class="text-muted">Guarda plantillas de evoluci√≥n por patolog√≠a y grupo etario (m√°x. 10MB por archivo).</p>
            
            <div style="margin-top: 16px;">
              <label style="display: block; margin-bottom: 8px;">
                <strong>Subir nueva plantilla:</strong>
              </label>
              <div style="display: flex; gap: 8px; align-items: end;">
                <div style="flex: 1;">
                  <label>Nombre de la plantilla</label>
                  <input type="text" id="docName" placeholder="Ej: Evoluci√≥n Neumon√≠a Pediatr√≠a">
                </div>
                <div style="flex: 1;">
                  <label>Categor√≠a</label>
                  <select id="docCategory">
                    <option value="">Seleccionar categor√≠a</option>
                    <option value="pediatria">Pediatr√≠a</option>
                    <option value="adultos">Adultos</option>
                    <option value="geriatria">Geriatr√≠a</option>
                    <option value="neonatologia">Neonatolog√≠a</option>
                    <option value="infusiones">Infusiones</option>
                    <option value="otras">Otras</option>
                  </select>
                </div>
              </div>
              <div style="margin-top: 12px;">
                <textarea id="docContent" class="text-editor" placeholder="Escribe o pega el contenido de la plantilla aqu√≠..."></textarea>
              </div>
              <div id="adminPlantillaOption" style="margin-top: 12px; display: none;">
                <label class="switch">
                  <input id="plantillaGlobal" type="checkbox">
                  <span class="slider"></span>
                  <span>Plantilla predefinida (visible para todos los usuarios)</span>
                </label>
              </div>
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="btn primary" onclick="guardarDocumento()">Guardar Plantilla</button>
                <button class="btn" onclick="limpiarFormDoc()">Limpiar Formulario</button>
              </div>
            </div>

            <div style="margin-top: 24px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <strong>Plantillas guardadas:</strong>
                <select id="filterCategory" onchange="filtrarDocumentos()" style="margin-left: auto;">
                  <option value="">Todas las categor√≠as</option>
                  <option value="pediatria">Pediatr√≠a</option>
                  <option value="adultos">Adultos</option>
                  <option value="geriatria">Geriatr√≠a</option>
                  <option value="neonatologia">Neonatolog√≠a</option>
                  <option value="infusiones">Infusiones</option>
                  <option value="otras">Otras</option>
                </select>
                <input type="search" id="searchDoc" placeholder="Buscar..." onkeyup="filtrarDocumentos()">
              </div>
              <div id="docList" class="doc-list"></div>
            </div>
          </section>
        </div>

      </main>
    </div>
  </div>

  <div id="editModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px;">
    <div style="max-width: 900px; margin: 40px auto; background: white; border-radius: 8px; padding: 24px; max-height: 90vh; overflow-y: auto;">
      <h3 id="editDocTitle" style="margin-top: 0;">Editar Plantilla</h3>
      <div style="margin-bottom: 12px;">
        <label>Nombre de la plantilla</label>
        <input type="text" id="editDocName" style="width: 100%;">
      </div>
      <div style="margin-bottom: 12px;">
        <label>Categor√≠a</label>
        <select id="editDocCategory" style="width: 100%;">
          <option value="">Seleccionar categor√≠a</option>
          <option value="pediatria">Pediatr√≠a</option>
          <option value="adultos">Adultos</option>
          <option value="geriatria">Geriatr√≠a</option>
          <option value="neonatologia">Neonatolog√≠a</option>
          <option value="infusiones">Infusiones</option>
          <option value="otras">Otras</option>
        </select>
      </div>
      <div style="margin-bottom: 12px;">
        <label>Contenido</label>
        <textarea id="editDocContent" class="text-editor"></textarea>
      </div>
      <div id="editAdminPlantillaOption" style="margin-bottom: 12px; display: none;">
        <label class="switch">
          <input id="editPlantillaGlobal" type="checkbox">
          <span class="slider"></span>
          <span>Plantilla predefinida (visible para todos los usuarios)</span>
        </label>
      </div>
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn" onclick="cerrarEditor()">Cancelar</button>
        <button class="btn primary" onclick="guardarEdicion()">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    let documentos = [];
    let editandoDocId = null;
    let currentUser = null;
    let infusionMedications = [];

    window.initHerramientas = async function() {
      const session = await checkSession();
      currentUser = session;
      
      if (session.role === 'admin') {
        document.getElementById('adminPlantillaOption').style.display = 'block';
        document.getElementById('editAdminPlantillaOption').style.display = 'block';
        document.getElementById('adminInfusionesLink').style.display = 'inline-block';
      }
      
      loadInfusionMedications();
      showMenu();
    }

    function showMenu() {
      document.getElementById('toolMenu').style.display = 'grid';
      document.getElementById('correctorTool').style.display = 'none';
      document.getElementById('gasesTool').style.display = 'none';
      document.getElementById('infusionesTool').style.display = 'none';
      document.getElementById('plantillasTool').style.display = 'none';
      document.getElementById('turnosTool').style.display = 'none';
      document.getElementById('iaTool').style.display = 'none';
    }

    function showTool(tool) {
      document.getElementById('toolMenu').style.display = 'none';
      document.getElementById('correctorTool').style.display = 'none';
      document.getElementById('gasesTool').style.display = 'none';
      document.getElementById('infusionesTool').style.display = 'none';
      document.getElementById('plantillasTool').style.display = 'none';
      document.getElementById('turnosTool').style.display = 'none';
      document.getElementById('iaTool').style.display = 'none';
      
      if (tool === 'corrector') {
        document.getElementById('correctorTool').style.display = 'block';
      } else if (tool === 'gases') {
        document.getElementById('gasesTool').style.display = 'block';
      } else if (tool === 'infusiones') {
        document.getElementById('infusionesTool').style.display = 'block';
      } else if (tool === 'plantillas') {
        document.getElementById('plantillasTool').style.display = 'block';
        cargarDocumentos();
      } else if (tool === 'turnos') {
        document.getElementById('turnosTool').style.display = 'block';
        cargarTurnos();
        inicializarFiltroMes();
      } else if (tool === 'ia') {
        document.getElementById('iaTool').style.display = 'block';
      }
    }

    function corregirEspacios() {
      const input = document.getElementById('textInput').value;
      const corregido = input
        .replace(/\s+/g, ' ')
        .replace(/^\s+|\s+$/g, '')
        .replace(/\s+([.,;:!?])/g, '$1')
        .replace(/([.,;:!?])(\w)/g, '$1 $2');
      
      document.getElementById('textResultContent').textContent = corregido;
      document.getElementById('textResult').style.display = 'block';
      document.getElementById('textInput').value = corregido;
    }

    function limpiarTexto() {
      document.getElementById('textInput').value = '';
      document.getElementById('textResult').style.display = 'none';
    }

    function copiarTexto() {
      const texto = document.getElementById('textResultContent').textContent;
      navigator.clipboard.writeText(texto).then(() => {
        alert('Texto copiado al portapapeles');
      });
    }

    function validateGSAInput(field, value, min, max) {
      const statusEl = document.getElementById(`status${field}`);
      if (!statusEl) return;
      
      if (value === '' || isNaN(value)) {
        statusEl.textContent = '';
        statusEl.style.color = '';
        return;
      }
      
      const numValue = parseFloat(value);
      if (numValue < min) {
        statusEl.textContent = '‚Üì Bajo';
        statusEl.style.color = '#ef4444';
      } else if (numValue > max) {
        statusEl.textContent = '‚Üë Alto';
        statusEl.style.color = '#f59e0b';
      } else {
        statusEl.textContent = '‚úì Normal';
        statusEl.style.color = '#10b981';
      }
    }

    function interpretarGSA() {
      const pH = parseFloat(document.getElementById('gsaPH').value);
      const paCO2 = parseFloat(document.getElementById('gsaPaCO2').value);
      const paO2 = parseFloat(document.getElementById('gsaPaO2').value);
      const hco3 = parseFloat(document.getElementById('gsaHCO3').value);

      if (isNaN(pH) || isNaN(paCO2) || isNaN(hco3)) {
        alert('Por favor, completa al menos pH, PaCO‚ÇÇ y HCO‚ÇÉ');
        return;
      }

      let diagnostico = '';
      let estado = '';
      let oxigenacion = '';

      if (pH >= 7.35 && pH <= 7.45) {
        if (paCO2 >= 35 && paCO2 <= 45 && hco3 >= 22 && hco3 <= 26) {
          diagnostico = 'Normal';
          estado = 'Sin alteraciones';
        } else if (paCO2 > 45 && hco3 > 26) {
          diagnostico = 'Acidosis Respiratoria';
          estado = 'Compensada';
        } else if (paCO2 < 35 && hco3 < 22) {
          diagnostico = 'Alcalosis Respiratoria';
          estado = 'Compensada';
        } else if (paCO2 < 35 && hco3 > 26) {
          diagnostico = 'Alcalosis Metab√≥lica';
          estado = 'Compensada';
        } else if (paCO2 > 45 && hco3 < 22) {
          diagnostico = 'Acidosis Metab√≥lica';
          estado = 'Compensada';
        }
      } else if (pH < 7.35) {
        if (paCO2 > 45 && hco3 >= 22 && hco3 <= 26) {
          diagnostico = 'Acidosis Respiratoria';
          estado = 'Aguda';
        } else if (paCO2 > 45 && hco3 > 26) {
          diagnostico = 'Acidosis Respiratoria';
          estado = 'Parcialmente Compensada';
        } else if (hco3 < 22 && paCO2 >= 35 && paCO2 <= 45) {
          diagnostico = 'Acidosis Metab√≥lica';
          estado = 'Aguda';
        } else if (hco3 < 22 && paCO2 < 35) {
          diagnostico = 'Acidosis Metab√≥lica';
          estado = 'Parcialmente Compensada';
        }
      } else if (pH > 7.45) {
        if (paCO2 < 35 && hco3 >= 22 && hco3 <= 26) {
          diagnostico = 'Alcalosis Respiratoria';
          estado = 'Aguda';
        } else if (paCO2 < 35 && hco3 < 22) {
          diagnostico = 'Alcalosis Respiratoria';
          estado = 'Parcialmente Compensada';
        } else if (hco3 > 26 && paCO2 >= 35 && paCO2 <= 45) {
          diagnostico = 'Alcalosis Metab√≥lica';
          estado = 'Aguda';
        } else if (hco3 > 26 && paCO2 > 45) {
          diagnostico = 'Alcalosis Metab√≥lica';
          estado = 'Parcialmente Compensada';
        }
      }

      if (!isNaN(paO2)) {
        if (paO2 < 60) {
          oxigenacion = 'Hipoxemia severa';
        } else if (paO2 < 80) {
          oxigenacion = 'Hipoxemia moderada';
        } else if (paO2 >= 80 && paO2 <= 95) {
          oxigenacion = 'Normal';
        } else {
          oxigenacion = 'Hiperoxia';
        }
      }

      let html = '<div class="gsa-result">';
      html += '<h4>üìä Interpretaci√≥n de Gasometr√≠a</h4>';
      html += `<p><strong>Diagn√≥stico:</strong> ${diagnostico || 'No determinado'}</p>`;
      if (estado) html += `<p><strong>Estado:</strong> ${estado}</p>`;
      if (oxigenacion) html += `<p><strong>Oxigenaci√≥n:</strong> ${oxigenacion}</p>`;
      html += '<hr style="margin: 12px 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">';
      html += '<p style="font-size: 14px;"><strong>Valores ingresados:</strong></p>';
      html += `<p style="font-size: 14px;">‚Ä¢ pH: ${pH.toFixed(2)} ${pH < 7.35 ? '‚Üì' : pH > 7.45 ? '‚Üë' : '‚úì'}</p>`;
      html += `<p style="font-size: 14px;">‚Ä¢ PaCO‚ÇÇ: ${paCO2.toFixed(1)} mmHg ${paCO2 < 35 ? '‚Üì' : paCO2 > 45 ? '‚Üë' : '‚úì'}</p>`;
      if (!isNaN(paO2)) html += `<p style="font-size: 14px;">‚Ä¢ PaO‚ÇÇ: ${paO2.toFixed(1)} mmHg ${paO2 < 80 ? '‚Üì' : paO2 > 95 ? '‚Üë' : '‚úì'}</p>`;
      html += `<p style="font-size: 14px;">‚Ä¢ HCO‚ÇÉ: ${hco3.toFixed(1)} mEq/L ${hco3 < 22 ? '‚Üì' : hco3 > 26 ? '‚Üë' : '‚úì'}</p>`;
      html += '</div>';

      document.getElementById('gsaResult').innerHTML = html;
      document.getElementById('gsaResult').style.display = 'block';
    }

    function limpiarGSA() {
      document.getElementById('gsaPH').value = '';
      document.getElementById('gsaPaCO2').value = '';
      document.getElementById('gsaPaO2').value = '';
      document.getElementById('gsaHCO3').value = '';
      document.getElementById('statusPH').textContent = '';
      document.getElementById('statusPaCO2').textContent = '';
      document.getElementById('statusPaO2').textContent = '';
      document.getElementById('statusHCO3').textContent = '';
      document.getElementById('gsaResult').style.display = 'none';
    }

    document.getElementById('gsaPH')?.addEventListener('input', (e) => {
      validateGSAInput('PH', e.target.value, 7.35, 7.45);
    });
    document.getElementById('gsaPaCO2')?.addEventListener('input', (e) => {
      validateGSAInput('PaCO2', e.target.value, 35, 45);
    });
    document.getElementById('gsaPaO2')?.addEventListener('input', (e) => {
      validateGSAInput('PaO2', e.target.value, 80, 95);
    });
    document.getElementById('gsaHCO3')?.addEventListener('input', (e) => {
      validateGSAInput('HCO3', e.target.value, 22, 26);
    });

    function initDefaultInfusions() {
      const existing = localStorage.getItem('infusion_medications_global');
      if (!existing) {
        const defaultMeds = [
          {
            id: 1,
            nombre: 'FENTANILO',
            presentacion: '500MCG/10ML = 50MCG/ML = 0.5MG/10ML',
            dosis: '1MCG/KG/HORA',
            unidad: 'mcg/kg/h',
            diluciones: ['12CC', '24CC', '50CC', '100CC'],
            concentraciones: [0.88, 0.44, 0.21, 0.11],
            ssn: '39,4',
            ssn_percentage: '0.9%'
          },
          {
            id: 2,
            nombre: 'MIDAZOLAM',
            presentacion: '15MG/3ML = 5MG/1ML',
            dosis: '0,1MG/KG/HORA',
            unidad: 'mg/kg/h',
            diluciones: ['12CC', '24CC', '50CC', '100CC'],
            concentraciones: [0.42, 0.21, 0.10, 0.05],
            ssn: '38,5',
            ssn_percentage: '0.9%'
          }
        ];
        localStorage.setItem('infusion_medications_global', JSON.stringify(defaultMeds));
      }
    }

    function loadInfusionMedications() {
      initDefaultInfusions();
      
      const globalMeds = JSON.parse(localStorage.getItem('infusion_medications_global') || '[]');
      infusionMedications = globalMeds;
      
      const select = document.getElementById('medicationSelect');
      select.innerHTML = '<option value="">Seleccionar medicamento</option>';
      infusionMedications.forEach((med, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = med.nombre;
        select.appendChild(option);
      });
    }

    function loadMedication() {
      const select = document.getElementById('medicationSelect');
      const index = parseInt(select.value);
      
      if (isNaN(index)) {
        document.getElementById('medicationInfo').style.display = 'none';
        return;
      }
      
      const med = infusionMedications[index];
      document.getElementById('medicationInfo').style.display = 'block';
      document.getElementById('presentacion').innerHTML = `<strong>${med.presentacion}</strong><br>Dosis: ${med.dosis}`;
      
      const unidad = med.unidad || 'mcg/kg/h';
      document.getElementById('dosisLabel').textContent = `Dosis (${unidad})`;
      
      document.getElementById('dosis').value = '';
      document.getElementById('peso').value = '';
      
      const dilucionOptions = document.getElementById('dilucionOptions');
      dilucionOptions.innerHTML = '<label><strong>Opciones de diluci√≥n disponibles:</strong></label><br>';
      med.diluciones.forEach((dil, i) => {
        dilucionOptions.innerHTML += `
          <label style="display:block;margin:8px 0;">
            <input type="radio" name="dilucion" value="${i}" onchange="calculateInfusion()">
            ${dil}
          </label>
        `;
      });
    }

    function calculateInfusion() {
      const select = document.getElementById('medicationSelect');
      const index = parseInt(select.value);
      
      if (isNaN(index)) return;
      
      const med = infusionMedications[index];
      const dosis = parseFloat(document.getElementById('dosis').value);
      const peso = parseFloat(document.getElementById('peso').value);
      
      if (isNaN(dosis) || isNaN(peso)) {
        document.getElementById('dosisCalculada').innerHTML = '';
        document.getElementById('dosisInfusion').innerHTML = '';
        document.getElementById('ordenMedica').style.display = 'none';
        return;
      }
      
      const unidadDosis = med.unidad || 'mcg/kg/h';
      const esPorMinuto = unidadDosis.includes('/min');
      const esMcg = unidadDosis.includes('mcg');
      const esUI = unidadDosis.includes('UI');
      
      const concentracionMatch = med.presentacion.match(/=\s*([\d.]+)\s*(MCG|MG|UI)\/\d*ML/i);
      if (!concentracionMatch) {
        alert('Error: No se pudo extraer la concentraci√≥n del medicamento');
        return;
      }
      
      const concentracionMedicamento = parseFloat(concentracionMatch[1]);
      const unidadConcentracion = concentracionMatch[2].toUpperCase();
      
      let dosisPorHora = dosis * peso;
      if (esPorMinuto) {
        dosisPorHora = dosisPorHora * 60;
      }
      let dosisPorDia = dosisPorHora * 24;
      
      let concentracionEnUnidadDosis;
      if (esUI && unidadConcentracion === 'UI') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (esMcg && unidadConcentracion === 'MCG') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (esMcg && unidadConcentracion === 'MG') {
        concentracionEnUnidadDosis = concentracionMedicamento * 1000;
      } else if (!esMcg && !esUI && unidadConcentracion === 'MG') {
        concentracionEnUnidadDosis = concentracionMedicamento;
      } else if (!esMcg && !esUI && unidadConcentracion === 'MCG') {
        concentracionEnUnidadDosis = concentracionMedicamento / 1000;
      } else {
        concentracionEnUnidadDosis = concentracionMedicamento;
      }
      
      let unidadMostrar = esUI ? 'UI' : (esMcg ? 'MCG' : 'MG');
      let unidadHora = esUI ? 'UI/hora' : (esMcg ? 'mcg/hora' : 'mg/hora');
      
      document.getElementById('dosisCalculada').innerHTML = `
        <p><strong>${unidadMostrar}/DIA:</strong> ${dosisPorDia.toFixed(1)} ${unidadMostrar}</p>
        <p><strong>Dosis:</strong> ${dosisPorHora.toFixed(2)} ${unidadHora}</p>
      `;
      
      const selectedDilucion = document.querySelector('input[name="dilucion"]:checked');
      if (selectedDilucion) {
        const dilucionText = med.diluciones[parseInt(selectedDilucion.value)];
        const dilucionTotal = parseFloat(dilucionText.replace(/[^0-9.]/g, ''));
        
        const mlPorCc = 1;
        const concentracionPorMl = concentracionEnUnidadDosis;
        
        const ccMedicamento = dosisPorDia / concentracionPorMl;
        const ccDiluyente = dilucionTotal - ccMedicamento;
        
        const concentracionFinal = dosisPorDia / dilucionTotal;
        let razonCcHora = dosisPorHora / concentracionFinal;
        
        document.getElementById('dosisInfusion').innerHTML = `
          <p><strong>CC de ${med.nombre}:</strong> ${ccMedicamento.toFixed(1)} CC</p>
          <p><strong>CC de diluyente (SS 0.9%):</strong> ${ccDiluyente.toFixed(1)} CC</p>
          <p style="font-size:13px;color:var(--muted);margin-top:8px;">Concentraci√≥n final: ${concentracionFinal.toFixed(2)} ${unidadMostrar}/CC</p>
        `;
        
        window.razonSeleccionada = razonCcHora;
        
        document.getElementById('ordenMedicaContent').innerHTML = `
          <p><strong>ORDEN M√âDICA:</strong></p>
          <p id="ordenTexto">${med.nombre.toUpperCase()} ${ccMedicamento.toFixed(1)}CC + ${ccDiluyente.toFixed(1)}CC DE SS 0.9% PASAR A RAZ√ìN DE ${razonCcHora.toFixed(1)}CC/HORA</p>
        `;
        document.getElementById('ordenMedica').style.display = 'block';
      }
    }

    function clearInfusion() {
      document.getElementById('medicationSelect').value = '';
      document.getElementById('dosis').value = '';
      document.getElementById('peso').value = '';
      document.getElementById('medicationInfo').style.display = 'none';
      document.getElementById('ordenMedica').style.display = 'none';
    }


    function copyInfusionOrder() {
      const ordenContent = document.getElementById('ordenMedicaContent');
      
      if (!ordenContent || ordenContent.innerHTML === '') {
        alert('Por favor calcula primero la infusi√≥n');
        return;
      }
      
      const ordenText = ordenContent.querySelector('p:last-child').textContent;
      
      navigator.clipboard.writeText(ordenText).then(() => {
        alert('Orden m√©dica copiada al portapapeles');
      }).catch(() => {
        alert('No se pudo copiar al portapapeles');
      });
    }

    function guardarDocumento() {
      const nombre = document.getElementById('docName').value.trim();
      const categoria = document.getElementById('docCategory').value;
      const contenido = document.getElementById('docContent').value.trim();
      const isGlobal = document.getElementById('plantillaGlobal')?.checked || false;

      if (!nombre) {
        alert('Por favor, ingresa un nombre para la plantilla');
        return;
      }
      if (!categoria) {
        alert('Por favor, selecciona una categor√≠a');
        return;
      }
      if (!contenido) {
        alert('Por favor, ingresa el contenido de la plantilla');
        return;
      }

      const tamanio = new Blob([contenido]).size;
      if (tamanio > 10 * 1024 * 1024) {
        alert('La plantilla excede el tama√±o m√°ximo de 10MB');
        return;
      }

      const doc = {
        id: Date.now(),
        nombre: nombre,
        categoria: categoria,
        contenido: contenido,
        fecha: new Date().toISOString(),
        tamanio: tamanio,
        global: currentUser?.role === 'admin' && isGlobal,
        creador: currentUser?.username || 'unknown'
      };

      documentos.push(doc);
      
      const storageKey = isGlobal && currentUser?.role === 'admin' 
        ? 'plantillas_globales' 
        : 'plantillas_' + (currentUser?.username || 'local');
      
      const existingDocs = JSON.parse(localStorage.getItem(storageKey) || '[]');
      existingDocs.push(doc);
      localStorage.setItem(storageKey, JSON.stringify(existingDocs));
      
      limpiarFormDoc();
      cargarDocumentos();
      alert('Plantilla guardada exitosamente');
    }

    function limpiarFormDoc() {
      document.getElementById('docName').value = '';
      document.getElementById('docCategory').value = '';
      document.getElementById('docContent').value = '';
      if (document.getElementById('plantillaGlobal')) {
        document.getElementById('plantillaGlobal').checked = false;
      }
    }

    function cargarDocumentos() {
      documentos = [];
      
      const globales = JSON.parse(localStorage.getItem('plantillas_globales') || '[]');
      documentos = [...globales];
      
      if (currentUser?.username) {
        const locales = JSON.parse(localStorage.getItem('plantillas_' + currentUser.username) || '[]');
        documentos = [...documentos, ...locales];
      }
      
      mostrarDocumentos();
    }

    function mostrarDocumentos(filtrados = null) {
      const lista = filtrados || documentos;
      const container = document.getElementById('docList');
      
      if (lista.length === 0) {
        container.innerHTML = '<p class="text-muted">No hay plantillas guardadas</p>';
        return;
      }

      container.innerHTML = lista.map(doc => {
        const fecha = new Date(doc.fecha).toLocaleDateString('es-ES');
        const tamanioKB = (doc.tamanio / 1024).toFixed(1);
        const esPropia = doc.creador === currentUser?.username;
        const esAdmin = currentUser?.role === 'admin';
        const puedeEditar = esPropia || esAdmin;
        const badge = doc.global ? '<span style="background:#008080;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:8px;">PREDEFINIDA</span>' : '';
        
        return `
          <div class="doc-item">
            <div class="doc-name">${doc.nombre}${badge}</div>
            <div class="doc-meta">
              ${doc.categoria.charAt(0).toUpperCase() + doc.categoria.slice(1)} ‚Ä¢ 
              ${tamanioKB} KB ‚Ä¢ 
              ${fecha}
            </div>
            ${puedeEditar ? `<button class="btn sm" onclick="editarDocumento(${doc.id})">Editar</button>` : ''}
            <button class="btn sm" onclick="descargarDocumento(${doc.id})">Descargar</button>
            ${puedeEditar ? `<button class="btn danger sm" onclick="eliminarDocumento(${doc.id})">Eliminar</button>` : ''}
          </div>
        `;
      }).join('');
    }

    function filtrarDocumentos() {
      const categoria = document.getElementById('filterCategory').value;
      const busqueda = document.getElementById('searchDoc').value.toLowerCase();
      
      let filtrados = documentos;
      
      if (categoria) {
        filtrados = filtrados.filter(doc => doc.categoria === categoria);
      }
      
      if (busqueda) {
        filtrados = filtrados.filter(doc => 
          doc.nombre.toLowerCase().includes(busqueda) ||
          doc.contenido.toLowerCase().includes(busqueda)
        );
      }
      
      mostrarDocumentos(filtrados);
    }

    function editarDocumento(id) {
      const doc = documentos.find(d => d.id === id);
      if (!doc) return;
      
      editandoDocId = id;
      document.getElementById('editDocName').value = doc.nombre;
      document.getElementById('editDocCategory').value = doc.categoria;
      document.getElementById('editDocContent').value = doc.contenido;
      
      if (currentUser?.role === 'admin' && doc.global) {
        document.getElementById('editPlantillaGlobal').checked = true;
      } else {
        document.getElementById('editPlantillaGlobal').checked = false;
      }
      
      document.getElementById('editModal').style.display = 'block';
    }

    function cerrarEditor() {
      editandoDocId = null;
      document.getElementById('editModal').style.display = 'none';
    }

    function guardarEdicion() {
      if (!editandoDocId) return;
      
      const nombre = document.getElementById('editDocName').value.trim();
      const categoria = document.getElementById('editDocCategory').value;
      const contenido = document.getElementById('editDocContent').value.trim();
      const isGlobal = document.getElementById('editPlantillaGlobal')?.checked || false;
      
      if (!nombre || !categoria || !contenido) {
        alert('Por favor, completa todos los campos');
        return;
      }
      
      const tamanio = new Blob([contenido]).size;
      if (tamanio > 10 * 1024 * 1024) {
        alert('La plantilla excede el tama√±o m√°ximo de 10MB');
        return;
      }
      
      const doc = documentos.find(d => d.id === editandoDocId);
      if (!doc) return;
      
      const wasGlobal = doc.global;
      const nowGlobal = currentUser?.role === 'admin' && isGlobal;
      
      doc.nombre = nombre;
      doc.categoria = categoria;
      doc.contenido = contenido;
      doc.tamanio = tamanio;
      doc.fecha = new Date().toISOString();
      doc.global = nowGlobal;
      
      if (wasGlobal && !nowGlobal) {
        const globales = JSON.parse(localStorage.getItem('plantillas_globales') || '[]');
        const filtered = globales.filter(d => d.id !== editandoDocId);
        localStorage.setItem('plantillas_globales', JSON.stringify(filtered));
        
        const locales = JSON.parse(localStorage.getItem('plantillas_' + currentUser.username) || '[]');
        locales.push(doc);
        localStorage.setItem('plantillas_' + currentUser.username, JSON.stringify(locales));
      } else if (!wasGlobal && nowGlobal) {
        const locales = JSON.parse(localStorage.getItem('plantillas_' + currentUser.username) || '[]');
        const filtered = locales.filter(d => d.id !== editandoDocId);
        localStorage.setItem('plantillas_' + currentUser.username, JSON.stringify(filtered));
        
        const globales = JSON.parse(localStorage.getItem('plantillas_globales') || '[]');
        globales.push(doc);
        localStorage.setItem('plantillas_globales', JSON.stringify(globales));
      } else {
        const storageKey = nowGlobal ? 'plantillas_globales' : 'plantillas_' + currentUser.username;
        const docs = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const index = docs.findIndex(d => d.id === editandoDocId);
        if (index !== -1) {
          docs[index] = doc;
          localStorage.setItem(storageKey, JSON.stringify(docs));
        }
      }
      
      cerrarEditor();
      cargarDocumentos();
      alert('Plantilla actualizada exitosamente');
    }

    function descargarDocumento(id) {
      const doc = documentos.find(d => d.id === id);
      if (!doc) return;
      
      const blob = new Blob([doc.contenido], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${doc.nombre}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function eliminarDocumento(id) {
      const doc = documentos.find(d => d.id === id);
      if (!doc) return;
      
      if (!confirm(`¬øEst√°s seguro de eliminar la plantilla "${doc.nombre}"?`)) return;
      
      const storageKey = doc.global ? 'plantillas_globales' : 'plantillas_' + currentUser.username;
      const docs = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const filtered = docs.filter(d => d.id !== id);
      localStorage.setItem(storageKey, JSON.stringify(filtered));
      
      cargarDocumentos();
      alert('Plantilla eliminada');
    }

    let turnos = [];

    function inicializarFiltroMes() {
      const filterMes = document.getElementById('filterMes');
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      filterMes.innerHTML = '<option value="">Todos los meses</option>';
      for (let i = 0; i < 12; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = meses[i];
        filterMes.appendChild(option);
      }
    }

    function guardarTurno() {
      const fecha = document.getElementById('turnoFecha').value;
      const horaInicio = document.getElementById('turnoHoraInicio').value;
      const horaFin = document.getElementById('turnoHoraFin').value;
      const valor = parseFloat(document.getElementById('turnoValor').value) || 0;
      const lugar = document.getElementById('turnoLugar').value.trim();
      const tipo = document.getElementById('turnoTipo').value;
      const notas = document.getElementById('turnoNotas').value.trim();

      if (!fecha || !horaInicio || !horaFin) {
        alert('Por favor completa fecha, hora de inicio y hora de fin');
        return;
      }

      const turno = {
        id: Date.now(),
        fecha,
        horaInicio,
        horaFin,
        valor,
        lugar,
        tipo,
        notas,
        creador: currentUser?.username || 'unknown'
      };

      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      const turnosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      turnosExistentes.push(turno);
      localStorage.setItem(storageKey, JSON.stringify(turnosExistentes));

      limpiarFormTurno();
      cargarTurnos();
      alert('Turno guardado exitosamente');
    }

    function limpiarFormTurno() {
      document.getElementById('turnoFecha').value = '';
      document.getElementById('turnoHoraInicio').value = '';
      document.getElementById('turnoHoraFin').value = '';
      document.getElementById('turnoValor').value = '';
      document.getElementById('turnoLugar').value = '';
      document.getElementById('turnoTipo').value = 'guardia';
      document.getElementById('turnoNotas').value = '';
    }

    function cargarTurnos() {
      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      turnos = JSON.parse(localStorage.getItem(storageKey) || '[]');
      filtrarTurnos();
    }

    function filtrarTurnos() {
      const busqueda = document.getElementById('searchTurno').value.toLowerCase();
      const mes = document.getElementById('filterMes').value;

      let filtrados = [...turnos];

      if (mes !== '') {
        filtrados = filtrados.filter(turno => {
          const fechaTurno = new Date(turno.fecha);
          return fechaTurno.getMonth() === parseInt(mes);
        });
      }

      if (busqueda) {
        filtrados = filtrados.filter(turno =>
          turno.lugar.toLowerCase().includes(busqueda) ||
          turno.tipo.toLowerCase().includes(busqueda) ||
          turno.notas.toLowerCase().includes(busqueda)
        );
      }

      mostrarTurnos(filtrados);
      actualizarResumen(filtrados);
    }

    function mostrarTurnos(lista) {
      const turnosList = document.getElementById('turnosList');
      
      if (lista.length === 0) {
        turnosList.innerHTML = '<p class="text-muted">No hay turnos programados</p>';
        return;
      }

      lista.sort((a, b) => new Date(a.fecha + ' ' + a.horaInicio) - new Date(b.fecha + ' ' + b.horaInicio));

      turnosList.innerHTML = lista.map(turno => {
        const fecha = new Date(turno.fecha);
        const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
        const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);

        return `
          <div class="doc-item">
            <div style="flex: 1;">
              <div class="doc-name">${fechaFormateada} - ${turno.horaInicio} a ${turno.horaFin}</div>
              <div class="doc-meta">${turno.tipo.toUpperCase()} | ${turno.lugar} | $${turno.valor.toFixed(2)}</div>
              ${turno.notas ? `<div class="doc-meta" style="margin-top: 4px;">${turno.notas}</div>` : ''}
            </div>
            <button class="btn sm danger" onclick="eliminarTurno(${turno.id})">Eliminar</button>
          </div>
        `;
      }).join('');
    }

    function actualizarResumen(lista) {
      const total = lista.length;
      const valorTotal = lista.reduce((sum, turno) => sum + turno.valor, 0);
      document.getElementById('resumenTurnos').textContent = `Total de turnos: ${total} | Valor total: $${valorTotal.toFixed(2)}`;
    }

    function eliminarTurno(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este turno?')) return;

      const storageKey = 'turnos_' + (currentUser?.username || 'local');
      const turnosExistentes = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const filtered = turnosExistentes.filter(t => t.id !== id);
      localStorage.setItem(storageKey, JSON.stringify(filtered));

      cargarTurnos();
      alert('Turno eliminado');
    }

    function buscarIA() {
      const query = document.getElementById('iaQuery').value.trim();
      
      if (!query) {
        alert('Por favor, ingresa una pregunta o b√∫squeda');
        return;
      }

      document.getElementById('iaResultContent').innerHTML = `
        <p>Para obtener informaci√≥n m√©dica basada en evidencia sobre "${query}", por favor visita:</p>
        <ul style="margin-top: 12px;">
          <li style="margin: 8px 0;">
            <a href="https://www.openevidence.com/" target="_blank" style="color: var(--primary); font-weight: 600;">
              Open Evidence - IA m√©dica especializada
            </a>
          </li>
          <li style="margin: 8px 0;">
            <a href="https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(query)}" target="_blank" style="color: var(--primary); font-weight: 600;">
              PubMed - B√∫squeda: "${query}"
            </a>
          </li>
          <li style="margin: 8px 0;">
            <a href="https://www.uptodate.com/contents/search?search=${encodeURIComponent(query)}" target="_blank" style="color: var(--primary); font-weight: 600;">
              UpToDate - B√∫squeda: "${query}"
            </a>
          </li>
        </ul>
        <p style="margin-top: 16px; font-size: 13px; color: var(--muted);">
          <strong>Nota:</strong> Estas son plataformas confiables para informaci√≥n m√©dica. Open Evidence utiliza IA para resumir evidencia cient√≠fica de manera precisa.
        </p>
      `;
      
      document.getElementById('iaResult').style.display = 'block';
    }

    function limpiarIA() {
      document.getElementById('iaQuery').value = '';
      document.getElementById('iaResult').style.display = 'none';
    }
  </script>
</body></html>
